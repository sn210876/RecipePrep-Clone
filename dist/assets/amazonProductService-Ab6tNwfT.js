import{s as i}from"./index-Cf-ALqSY.js";const u="mealscrape-20";function l(a,r){try{const e=new URL(a);e.searchParams.has("tag")||e.searchParams.set("tag",u),e.searchParams.has("linkCode")||e.searchParams.set("linkCode","ll1"),e.searchParams.has("ref")||e.searchParams.set("ref","nosim");const s=(r==null?void 0:r.source)||(r!=null&&r.mobile?"mobile_cart":"web_cart");e.searchParams.has("utm_source")||e.searchParams.set("utm_source","mealscrape"),e.searchParams.has("utm_medium")||e.searchParams.set("utm_medium",s);const t=e.toString();return console.log(`ðŸ”— Affiliate URL: ${t.substring(0,100)}... (tag=${u})`),t}catch{const e=a.includes("?")?"&":"?",s=(r==null?void 0:r.source)||(r!=null&&r.mobile?"mobile_cart":"web_cart"),t=`${a}${e}tag=${u}&linkCode=ll1&ref=nosim&utm_source=mealscrape&utm_medium=${s}`;return console.log(`ðŸ”— Affiliate URL (fallback): ${t.substring(0,100)}... (tag=${u})`),t}}async function f(){const{data:a,error:r}=await i.from("product_categories").select("*").order("sort_order");if(r)throw r;return a||[]}async function g(a){const{data:r,error:e}=await i.from("amazon_products").select("*").eq("category_id",a).eq("is_active",!0).order("popularity_score",{ascending:!1});if(e)throw e;return r||[]}async function p(a,r){let e=i.from("amazon_products").select("*").eq("is_active",!0);r&&(e=e.eq("category_id",r)),a.trim()&&(e=e.or(`product_name.ilike.%${a}%,description.ilike.%${a}%,search_keywords.cs.{${a}}`));const{data:s,error:t}=await e.order("popularity_score",{ascending:!1}).limit(50);if(t)throw t;return s||[]}async function h(a,r=5){const e=a.toLowerCase().trim(),{data:s,error:t}=await i.from("ingredient_product_mappings").select(`
      amazon_product_id,
      confidence_score,
      amazon_products (*)
    `).eq("ingredient_name",e).order("confidence_score",{ascending:!1}).limit(r);if(t&&console.error("Error fetching mappings:",t),s&&s.length>0)return s.filter(d=>d.amazon_products).map(d=>d.amazon_products);const c=e.split(",")[0].trim();let o=i.from("amazon_products").select("*").eq("is_active",!0);o=o.or(`product_name.ilike.%${c}%,search_keywords.cs.{${c}}`);const{data:n,error:m}=await o.order("popularity_score",{ascending:!1}).limit(r);if(m)throw m;return n||[]}async function y(a,r,e="1",s="",t,c){const{data:o,error:n}=await i.from("cart_items").insert({user_id:a,ingredient_name:r.product_name,quantity:e,unit:s,amazon_product_url:l(r.amazon_url),amazon_product_name:r.product_name,price:r.price,image_url:r.image_url,asin:r.asin,source_recipe_id:t,delivery_service:null}).select().single();if(n)throw n;return o}async function w(a,r){const e=r.map(c=>({user_id:a,ingredient_name:c.product.product_name,quantity:c.quantity,unit:c.unit,amazon_product_url:l(c.product.amazon_url),amazon_product_name:c.product.product_name,price:c.product.price,image_url:c.product.image_url,asin:c.product.asin,source_recipe_id:c.sourceRecipeId,delivery_service:c.deliveryService||null})),{data:s,error:t}=await i.from("cart_items").insert(e).select();if(t)throw t;return s}export{l as a,w as b,y as c,g as d,h as f,f as g,p as s};
