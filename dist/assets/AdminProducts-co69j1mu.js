import{r as n,s as y,f as i,j as e,C as F,m as A,E as re,t as V,v as L,x as M,I as p,B as g,L as te,T as $e,y as o,z as Be}from"./index-DVwpH2fI.js";import{S as U,a as q,b as R,c as G,d as I}from"./select-CXGQRYnl.js";import{B as ie}from"./badge-BkWGMm2S.js";import{T as Ve,a as Le,b as K,c as O}from"./tabs-C0X-tf9E.js";import{D as Me,a as Ue,b as qe,c as Re,d as Ge,e as Ke}from"./dialog-99F_NYXR.js";import{T as Oe}from"./textarea-BLVCNVEC.js";import{C as le}from"./checkbox-CC1IoS72.js";import{g as Ye}from"./amazonProductService-CG7dxD98.js";import{T as ne}from"./trash-2-CfXlPzL9.js";import{P as He}from"./package-BXwdgxUn.js";import{S as Qe}from"./square-pen-DPlMZ5qw.js";import{U as We}from"./upload-DCEEtfDC.js";import{C as Ze}from"./circle-check-big-DeC-nfFn.js";import"./react-icons.esm-C0YfxzY2.js";import"./index-Cys3cZiM.js";import"./index-BdQq_4o_.js";import"./index-C2gVbWsZ.js";import"./index-DBkdpl3t.js";import"./index-DI7neGSw.js";import"./index-CmMSLvOd.js";import"./index-B9UNKS3B.js";import"./index-BfqclHMW.js";import"./index-Jg5AEDUS.js";import"./index-BQIfC9AS.js";import"./index-6KIGwICh.js";const ce="mealscrape-20";function bs(){var se;const[oe,de]=n.useState("list"),[Y,me]=n.useState([]),[D,ue]=n.useState([]),[he,H]=n.useState(!1),[N,pe]=n.useState(""),[S,xe]=n.useState("all"),[C,Q]=n.useState(1),[W,ge]=n.useState(0),E=50,[Je,je]=n.useState(null),[j,fe]=n.useState([]),[T,Z]=n.useState(!1),[ve,J]=n.useState(0),[k,ye]=n.useState(null),[l,b]=n.useState(null),[_e,P]=n.useState(!1),[t,u]=n.useState({product_name:"",category_id:"",asin:"",price:null,brand:"",package_size:"",description:"",image_url:"",is_prime:!1,search_keywords:[]}),[$,B]=n.useState(""),[_,X]=n.useState(new Set),[we,ee]=n.useState(!1);n.useEffect(()=>{Ne(),be(),w()},[S,N,C]);async function Ne(){const{data:{user:s}}=await y.auth.getUser();if(!s){i.error("You must be logged in");return}const{data:a,error:r}=await y.from("admin_users").select("*").eq("user_id",s.id).maybeSingle();if(r||!a){i.error("You do not have admin access"),ee(!1);return}ee(!0)}async function be(){try{const s=await Ye();ue(s)}catch(s){console.error("Failed to load categories:",s),i.error("Failed to load categories")}}async function w(){H(!0);try{let s=y.from("amazon_products").select("*",{count:"exact"});S!=="all"&&(s=s.eq("category_id",S)),N.trim()&&(s=s.or(`product_name.ilike.%${N}%,asin.ilike.%${N}%,brand.ilike.%${N}%`));const a=(C-1)*E,r=a+E-1,{data:c,error:d,count:f}=await s.order("created_at",{ascending:!1}).range(a,r);if(d)throw d;me(c||[]),ge(f||0)}catch(s){console.error("Failed to load products:",s),i.error("Failed to load products")}finally{H(!1)}}function Ce(s){var c;const a=(c=s.target.files)==null?void 0:c[0];if(!a)return;if(a.type!=="text/csv"&&!a.name.endsWith(".csv")){i.error("Please upload a CSV file");return}je(a);const r=new FileReader;r.onload=d=>{var h;const f=(h=d.target)==null?void 0:h.result;ke(f)},r.readAsText(a)}function ke(s){const a=s.split(`
`).filter(h=>h.trim());if(a.length<2){i.error("CSV file is empty or invalid");return}const r=a[0].split(",").map(h=>h.trim().toLowerCase()),d=["asin","name","category"].filter(h=>!r.includes(h));if(d.length>0){i.error(`Missing required CSV columns: ${d.join(", ")}`);return}const f=[];for(let h=1;h<a.length;h++){const ae=a[h].split(",").map(x=>x.trim());if(ae.length!==r.length)continue;const m={asin:"",name:"",category:""};r.forEach((x,Te)=>{const v=ae[Te];x==="asin"?m.asin=v:x==="name"?m.name=v:x==="price"?m.price=v:x==="image_url"?m.image_url=v:x==="category"?m.category=v:x==="keywords"?m.keywords=v:x==="brand"?m.brand=v:x==="package_size"?m.package_size=v:x==="is_prime"&&(m.is_prime=v)}),m.asin&&m.name&&m.category&&f.push(m)}if(f.length===0){i.error("No valid products found in CSV");return}fe(f),i.success(`Parsed ${f.length} products from CSV`)}async function Se(){if(j.length===0){i.error("No data to import");return}Z(!0),J(0);const s={success:0,failed:0,errors:[]};for(let a=0;a<j.length;a++){const r=j[a];if(!Pe(r.asin)){s.failed++,s.errors.push(`Invalid ASIN: ${r.asin}`);continue}try{const c={category_id:r.category,product_name:r.name,description:"",amazon_url:`https://www.amazon.com/dp/${r.asin}?tag=${ce}`,asin:r.asin,price:r.price?parseFloat(r.price):null,image_url:r.image_url||null,brand:r.brand||null,package_size:r.package_size||null,is_prime:r.is_prime==="true"||r.is_prime==="1",search_keywords:r.keywords?r.keywords.split(";").map(f=>f.trim()):[],popularity_score:0,is_active:!0},{error:d}=await y.from("amazon_products").insert(c);d?(d.code==="23505"?s.errors.push(`Duplicate ASIN: ${r.asin}`):s.errors.push(`${r.asin}: ${d.message}`),s.failed++):s.success++}catch(c){s.failed++,s.errors.push(`${r.asin}: ${c instanceof Error?c.message:"Unknown error"}`)}J(Math.round((a+1)/j.length*100))}ye(s),Z(!1),i.success(`Import complete: ${s.success} succeeded, ${s.failed} failed`),w()}function Pe(s){return/^B[A-Z0-9]{9}$/.test(s)}async function ze(s){if(confirm("Are you sure you want to delete this product?"))try{const{error:a}=await y.from("amazon_products").delete().eq("id",s);if(a)throw a;i.success("Product deleted"),w()}catch(a){console.error("Failed to delete product:",a),i.error("Failed to delete product")}}async function Fe(s){try{const{error:a}=await y.from("amazon_products").update({is_active:!s.is_active}).eq("id",s.id);if(a)throw a;i.success(`Product ${s.is_active?"deactivated":"activated"}`),w()}catch(a){console.error("Failed to toggle product:",a),i.error("Failed to update product")}}async function Ae(s){try{const a={...s,amazon_url:s.asin?`https://www.amazon.com/dp/${s.asin}?tag=${ce}`:s.amazon_url},{error:r}=await y.from("amazon_products").insert(a);if(r)throw r;i.success("Product added successfully"),u({product_name:"",category_id:"",asin:"",price:null,brand:"",package_size:"",description:"",image_url:"",is_prime:!1,search_keywords:[]}),B(""),w()}catch(a){console.error("Failed to add product:",a),i.error("Failed to add product")}}async function Ie(){if(l)try{const{error:s}=await y.from("amazon_products").update({product_name:l.product_name,category_id:l.category_id,price:l.price,brand:l.brand,package_size:l.package_size,description:l.description,image_url:l.image_url,is_prime:l.is_prime,search_keywords:l.search_keywords}).eq("id",l.id);if(s)throw s;i.success("Product updated"),P(!1),b(null),w()}catch(s){console.error("Failed to update product:",s),i.error("Failed to update product")}}function De(){if(_.size===0){i.error("No products selected");return}confirm(`Delete ${_.size} products?`)&&Promise.all(Array.from(_).map(s=>y.from("amazon_products").delete().eq("id",s))).then(()=>{i.success(`Deleted ${_.size} products`),X(new Set),w()}).catch(s=>{console.error("Bulk delete failed:",s),i.error("Failed to delete products")})}function Ee(){const s=`asin,name,price,image_url,category,keywords,brand,package_size,is_prime
B001E5E3KG,Gold Medal All-Purpose Flour 5lb,4.99,https://m.media-amazon.com/images/I/example.jpg,baking,flour;baking;all-purpose,Gold Medal,5 lb,true
B00I8G8AKO,Domino Pure Cane Granulated Sugar 4lb,3.99,https://m.media-amazon.com/images/I/example.jpg,baking,sugar;white;granulated,Domino,4 lb,true`,a=new Blob([s],{type:"text/csv"}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download="sample-products.csv",c.click(),URL.revokeObjectURL(r)}if(!we)return e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsx(F,{children:e.jsx(A,{className:"pt-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You do not have admin privileges to access this page."})]})})})});const z=Math.ceil(W/E);return e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Product Management"}),e.jsx("p",{className:"text-gray-600",children:"Manage Amazon affiliate products and bulk imports"})]}),e.jsxs(Ve,{value:oe,onValueChange:de,children:[e.jsxs(Le,{className:"mb-6",children:[e.jsx(K,{value:"list",children:"Product List"}),e.jsx(K,{value:"import",children:"Bulk Import"}),e.jsx(K,{value:"add",children:"Add Single Product"})]}),e.jsx(O,{value:"list",children:e.jsxs(F,{children:[e.jsxs(V,{children:[e.jsxs(L,{children:["All Products (",W,")"]}),e.jsx(M,{children:"Search, filter, and manage products"})]}),e.jsxs(A,{children:[e.jsxs("div",{className:"flex gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsx(p,{placeholder:"Search by name, ASIN, or brand...",value:N,onChange:s=>pe(s.target.value),className:"w-full"})}),e.jsxs(U,{value:S,onValueChange:xe,children:[e.jsx(q,{className:"w-48",children:e.jsx(R,{placeholder:"All Categories"})}),e.jsxs(G,{children:[e.jsx(I,{value:"all",children:"All Categories"}),D.map(s=>e.jsxs(I,{value:s.id,children:[s.icon," ",s.name]},s.id))]})]})]}),_.size>0&&e.jsx("div",{className:"mb-4 flex gap-2",children:e.jsxs(g,{variant:"destructive",size:"sm",onClick:De,children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Delete Selected (",_.size,")"]})}),he?e.jsx("div",{className:"text-center py-12",children:e.jsx(te,{className:"w-8 h-8 animate-spin mx-auto"})}):Y.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(He,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"No products found"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-2",children:Y.map(s=>e.jsxs("div",{className:"flex items-center gap-4 p-4 border rounded-lg hover:bg-gray-50",children:[e.jsx(le,{checked:_.has(s.id),onCheckedChange:a=>{const r=new Set(_);a?r.add(s.id):r.delete(s.id),X(r)}}),s.image_url&&e.jsx("img",{src:s.image_url,alt:s.product_name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:s.product_name}),e.jsxs("div",{className:"flex gap-2 mt-1 text-sm text-gray-600",children:[e.jsxs("span",{children:["ASIN: ",s.asin]}),s.price&&e.jsxs("span",{children:["• $",s.price.toFixed(2)]}),s.brand&&e.jsxs("span",{children:["• ",s.brand]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ie,{variant:s.is_active?"default":"secondary",children:s.is_active?"Active":"Inactive"}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>{b(s),P(!0)},children:e.jsx(Qe,{className:"w-4 h-4"})}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>Fe(s),children:s.is_active?"Deactivate":"Activate"}),e.jsx(g,{size:"sm",variant:"destructive",onClick:()=>ze(s.id),children:e.jsx(ne,{className:"w-4 h-4"})})]})]},s.id))}),z>1&&e.jsxs("div",{className:"flex justify-center gap-2 mt-6",children:[e.jsx(g,{variant:"outline",size:"sm",onClick:()=>Q(s=>Math.max(1,s-1)),disabled:C===1,children:"Previous"}),e.jsxs("span",{className:"py-2 px-4 text-sm",children:["Page ",C," of ",z]}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>Q(s=>Math.min(z,s+1)),disabled:C===z,children:"Next"})]})]})]})]})}),e.jsx(O,{value:"import",children:e.jsxs(F,{children:[e.jsxs(V,{children:[e.jsx(L,{children:"Bulk Product Import"}),e.jsx(M,{children:"Upload a CSV file to import multiple products at once"})]}),e.jsxs(A,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs(g,{variant:"outline",onClick:Ee,className:"mb-4",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),"Download Sample CSV"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Required columns: asin, name, category"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Optional columns: price, image_url, keywords, brand, package_size, is_prime"}),e.jsx(p,{type:"file",accept:".csv",onChange:Ce,disabled:T})]}),j.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-2",children:["Preview (",j.length," products)"]}),e.jsxs("div",{className:"max-h-64 overflow-y-auto border rounded p-4 space-y-2",children:[j.slice(0,10).map((s,a)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsxs("span",{className:"text-gray-600",children:[" • ASIN: ",s.asin]}),e.jsxs("span",{className:"text-gray-600",children:[" • Category: ",s.category]})]},a)),j.length>10&&e.jsxs("p",{className:"text-sm text-gray-500",children:["...and ",j.length-10," more"]})]}),e.jsx(g,{onClick:Se,disabled:T,className:"mt-4",children:T?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-2 animate-spin"}),"Importing ",ve,"%"]}):e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Import ",j.length," Products"]})})]}),k&&e.jsxs("div",{className:"border rounded p-4 bg-gray-50",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Import Results"}),e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5 text-green-600"}),e.jsxs("span",{className:"text-green-600 font-medium",children:[k.success," succeeded"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5 text-red-600"}),e.jsxs("span",{className:"text-red-600 font-medium",children:[k.failed," failed"]})]})]}),k.errors.length>0&&e.jsxs("div",{className:"max-h-48 overflow-y-auto",children:[e.jsx("p",{className:"font-medium text-sm mb-2",children:"Errors:"}),k.errors.map((s,a)=>e.jsxs("p",{className:"text-sm text-red-600",children:["• ",s]},a))]})]})]})]})}),e.jsx(O,{value:"add",children:e.jsxs(F,{children:[e.jsxs(V,{children:[e.jsx(L,{children:"Add Single Product"}),e.jsx(M,{children:"Manually add a new product to the catalog"})]}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"asin",children:"ASIN *"}),e.jsx(p,{id:"asin",value:t.asin||"",onChange:s=>u({...t,asin:s.target.value}),placeholder:"B001E5E3KG"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"name",children:"Product Name *"}),e.jsx(p,{id:"name",value:t.product_name||"",onChange:s=>u({...t,product_name:s.target.value}),placeholder:"Gold Medal All-Purpose Flour"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"category",children:"Category *"}),e.jsxs(U,{value:t.category_id||"",onValueChange:s=>u({...t,category_id:s}),children:[e.jsx(q,{children:e.jsx(R,{placeholder:"Select category"})}),e.jsx(G,{children:D.map(s=>e.jsxs(I,{value:s.id,children:[s.icon," ",s.name]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"price",children:"Price"}),e.jsx(p,{id:"price",type:"number",step:"0.01",value:t.price||"",onChange:s=>u({...t,price:parseFloat(s.target.value)||null}),placeholder:"4.99"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"brand",children:"Brand"}),e.jsx(p,{id:"brand",value:t.brand||"",onChange:s=>u({...t,brand:s.target.value}),placeholder:"Gold Medal"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"package_size",children:"Package Size"}),e.jsx(p,{id:"package_size",value:t.package_size||"",onChange:s=>u({...t,package_size:s.target.value}),placeholder:"5 lb"})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"image_url",children:"Image URL"}),e.jsx(p,{id:"image_url",value:t.image_url||"",onChange:s=>u({...t,image_url:s.target.value}),placeholder:"https://m.media-amazon.com/images/I/..."})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"description",children:"Description"}),e.jsx(Oe,{id:"description",value:t.description||"",onChange:s=>u({...t,description:s.target.value}),placeholder:"Product description...",rows:3})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Keywords"}),e.jsx("div",{className:"flex gap-2 mb-2",children:e.jsx(p,{value:$,onChange:s=>B(s.target.value),placeholder:"Enter keyword and press Enter",onKeyDown:s=>{s.key==="Enter"&&$.trim()&&(s.preventDefault(),u({...t,search_keywords:[...t.search_keywords||[],$.trim()]}),B(""))}})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:(se=t.search_keywords)==null?void 0:se.map((s,a)=>e.jsxs(ie,{variant:"secondary",className:"cursor-pointer",onClick:()=>{var r;u({...t,search_keywords:(r=t.search_keywords)==null?void 0:r.filter((c,d)=>d!==a)})},children:[s," ×"]},a))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{id:"is_prime",checked:t.is_prime||!1,onCheckedChange:s=>u({...t,is_prime:!!s})}),e.jsx(o,{htmlFor:"is_prime",children:"Amazon Prime eligible"})]}),e.jsxs(g,{onClick:()=>Ae(t),disabled:!t.asin||!t.product_name||!t.category_id,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"Add Product"]})]})]})})]}),e.jsx(Me,{open:_e,onOpenChange:P,children:e.jsxs(Ue,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(qe,{children:[e.jsx(Re,{children:"Edit Product"}),e.jsx(Ge,{children:"Update product information"})]}),l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Product Name"}),e.jsx(p,{value:l.product_name,onChange:s=>b({...l,product_name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Category"}),e.jsxs(U,{value:l.category_id,onValueChange:s=>b({...l,category_id:s}),children:[e.jsx(q,{children:e.jsx(R,{})}),e.jsx(G,{children:D.map(s=>e.jsxs(I,{value:s.id,children:[s.icon," ",s.name]},s.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Price"}),e.jsx(p,{type:"number",step:"0.01",value:l.price||"",onChange:s=>b({...l,price:parseFloat(s.target.value)||null})})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Brand"}),e.jsx(p,{value:l.brand||"",onChange:s=>b({...l,brand:s.target.value})})]})]})]}),e.jsxs(Ke,{children:[e.jsx(g,{variant:"outline",onClick:()=>P(!1),children:"Cancel"}),e.jsx(g,{onClick:Ie,children:"Save Changes"})]})]})})]})}export{bs as AdminProducts};
