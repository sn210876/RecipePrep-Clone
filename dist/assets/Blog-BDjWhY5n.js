import{r as a,j as e,y as k,I as _,B as m,X as D,f as i,a8 as $,a as A,s as I,C as B,z as F,a9 as T}from"./index-DVwpH2fI.js";import{A as U,a as L,b as H,E as z}from"./avatar-DwF1ESeK.js";import{D as W,a as q,b as O,c as J}from"./dropdown-menu-CmQoDqyc.js";import{T as R}from"./textarea-BLVCNVEC.js";import{D as K,a as Q,b as V,c as X}from"./dialog-99F_NYXR.js";import{e as G,c as Y,s as Z,g as ee,f as se,d as te}from"./blogService-CQFKlXn6.js";import{b as ae}from"./imageCompression-DrFzx_NO.js";import{U as re}from"./upload-DCEEtfDC.js";import{T as le}from"./trending-up-CuiZbALH.js";import{E as oe}from"./ellipsis-vertical-CeuI1Ggs.js";import{T as ie}from"./trash-2-CfXlPzL9.js";import{H as ne}from"./heart-DErz6Qra.js";import"./index-CmMSLvOd.js";import"./index-Cys3cZiM.js";import"./react-icons.esm-C0YfxzY2.js";import"./index-C2gVbWsZ.js";import"./index-DBkdpl3t.js";import"./index-DI7neGSw.js";import"./index-B9UNKS3B.js";import"./index-BQIfC9AS.js";import"./index-Jg5AEDUS.js";import"./index-6KIGwICh.js";import"./en-US-wfBU2YNu.js";function ce({open:p,onClose:l,onPostCreated:f}){const[d,h]=a.useState(""),[n,y]=a.useState(""),[c,j]=a.useState(null),[v,C]=a.useState(!1),[b,P]=a.useState(!1),[E,x]=a.useState(null),S=async s=>{var o;const t=(o=s.target.files)==null?void 0:o[0];if(t){if(!t.type.startsWith("image/")){i.error("Please select an image file");return}if(t.size>10*1024*1024){i.error("Image must be less than 10MB");return}C(!0);try{const r=await ae(t,{maxSizeMB:.2,maxWidthOrHeight:1200,useWebWorker:!0,fileType:"image/jpeg",initialQuality:.85}),u=await $(r.file,"blog-covers");j(u),x(r.file),i.success(`Cover image uploaded! (${Math.round(r.compressedSize/1024)}KB)`)}catch(r){console.error("Error uploading image:",r),i.error("Failed to upload image")}finally{C(!1)}}},M=async()=>{if(!d.trim()){i.error("Please enter a title");return}if(!n.trim()){i.error("Please enter some content");return}P(!0);try{const s=G(n,200),t=await Y({title:d.trim(),content:{html:n},excerpt:s,cover_image:c||void 0});i.success("Post published!"),f(t.slug),N()}catch(s){console.error("Error creating post:",s),i.error("Failed to create post")}finally{P(!1)}},N=()=>{h(""),y(""),j(null),x(null),l()};return e.jsx(K,{open:p,onOpenChange:N,children:e.jsxs(Q,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsx(V,{children:e.jsx(X,{className:"text-2xl font-bold",children:"Create New Blog Post"})}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"title",children:"Title *"}),e.jsx(_,{id:"title",placeholder:"Enter an engaging title...",value:d,onChange:s=>h(s.target.value),className:"text-lg"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"cover",children:"Cover Image"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{type:"button",variant:"outline",className:"w-full",disabled:v,onClick:()=>{var s;return(s=document.getElementById("cover-upload"))==null?void 0:s.click()},children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),v?"Uploading...":c?"Change Cover":"Upload Cover"]}),e.jsx("input",{id:"cover-upload",type:"file",accept:"image/*",className:"hidden",onChange:S})]}),c&&e.jsx("div",{className:"relative mt-2 flex justify-center",children:e.jsxs("div",{className:"relative w-full max-w-xs",children:[e.jsx("img",{src:c,alt:"Cover preview",className:"w-full aspect-square object-cover rounded-lg"}),e.jsx(m,{variant:"destructive",size:"sm",className:"absolute top-2 right-2",onClick:()=>{j(null),x(null)},children:e.jsx(D,{className:"h-4 w-4"})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"content",children:"Content *"}),e.jsx(R,{id:"content",placeholder:`Write your post content here... (Markdown supported)

**Bold text**
*Italic text*
[Link text](https://example.com)

- List item 1
- List item 2`,value:n,onChange:s=>y(s.target.value),className:"min-h-[300px] font-mono text-sm"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Tip: Use markdown formatting for better readability"})]}),n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Preview"}),e.jsx("div",{className:"border rounded-lg p-4 prose prose-sm max-w-none",children:e.jsx("div",{className:"whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:n.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" class="text-orange-600 hover:underline" target="_blank" rel="noopener noreferrer">$1</a>').replace(new RegExp('(?<!href="|src=")(https?:\\/\\/[^\\s<]+)',"g"),'<a href="$1" class="text-orange-600 hover:underline" target="_blank" rel="noopener noreferrer">$1</a>').replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>\n?)+/g,'<ul class="list-disc pl-4">$&</ul>').replace(/\n\n/g,'</p><p class="mt-2">').replace(/^(.+)$/,"<p>$1</p>")}})})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(m,{variant:"outline",onClick:N,disabled:b,children:"Cancel"}),e.jsx(m,{onClick:M,disabled:b||!d.trim()||!n.trim(),children:b?"Publishing...":"Publish Post"})]})]})})}function _e({onNavigate:p}){const{user:l}=A(),[f,d]=a.useState([]),[h,n]=a.useState(!0),[y,c]=a.useState(!1),[j,v]=a.useState(1),[C,b]=a.useState(!0),[P,E]=a.useState(!1);a.useEffect(()=>{Z({title:"Blog & Discussion Board",description:"Join the MealScrape community. Share recipes, cooking tips, and food stories with fellow food enthusiasts.",type:"website"})},[]),a.useEffect(()=>{l&&I.from("profiles").select("is_admin").eq("id",l.id).single().then(({data:s})=>E((s==null?void 0:s.is_admin)===!0))},[l]),a.useEffect(()=>{x()},[j]),a.useEffect(()=>{const s=I.channel("blog-posts-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"blog_posts"},()=>{x(!0)}).subscribe();return()=>{I.removeChannel(s)}},[]);const x=async(s=!1)=>{try{const t=await ee(s?1:j,20);if(s){const o=Array.from(new Map(t.map(r=>[r.id,r])).values());d(o),v(1)}else{const o=[...f,...t],r=Array.from(new Map(o.map(u=>[u.id,u])).values());d(r)}b(t.length===20)}catch(t){console.error("Error loading posts:",t),i.error("Failed to load posts")}finally{n(!1)}},S=s=>{p(`blog:${s}`)},M=s=>{p(`blog:${s}`)},N=async(s,t)=>{if(t.stopPropagation(),!!confirm("Are you sure you want to delete this post?"))try{await te(s),i.success("Post deleted successfully"),x(!0)}catch(o){console.error("Error deleting post:",o),i.error("Failed to delete post")}};return h&&f.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 pt-2 pb-8",children:e.jsx("div",{className:"space-y-6",children:[...Array(5)].map((s,t)=>e.jsxs(B,{className:"p-6 animate-pulse border-4 border-orange-500",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-3/4 mb-4"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-full mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]},t))})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50",children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-2xl sm:text-4xl font-bold text-gray-900 mb-2 flex items-center justify-center gap-2",children:[e.jsx(le,{className:"h-6 w-6 sm:h-8 sm:w-8 text-orange-500"}),"Blog & Discussions"]}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 text-center",children:"Share your cooking stories with the community"}),l&&e.jsxs(m,{onClick:()=>c(!0),className:"w-full sm:w-auto bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700",children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"New Post"]})]}),!l&&e.jsx(B,{className:"p-6 mb-6 bg-gradient-to-r from-orange-50 to-amber-50 border-4 border-orange-500",children:e.jsxs("p",{className:"text-center text-gray-700",children:[e.jsx("strong",{children:"Join the conversation!"})," Log in to create posts, comment, and vote."]})}),e.jsx("div",{className:"space-y-6",children:f.map(s=>{var t,o,r,u;return e.jsx(B,{className:"p-6 hover:shadow-lg transition-shadow cursor-pointer border-4 border-orange-500",onClick:()=>M(s.slug),children:e.jsxs("div",{className:"flex gap-4",children:[s.cover_image&&e.jsx("div",{className:"flex-shrink-0 w-32 h-32 rounded-lg overflow-hidden",children:e.jsx("img",{src:s.cover_image,alt:s.title,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 hover:text-orange-600 transition-colors flex-1",children:s.title}),((l==null?void 0:l.id)===s.user_id||P)&&e.jsxs(W,{children:[e.jsx(q,{asChild:!0,onClick:g=>g.stopPropagation(),children:e.jsx(m,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(oe,{className:"h-4 w-4"})})}),e.jsx(O,{align:"end",children:e.jsxs(J,{onClick:g=>N(s.id,g),className:"text-red-600 focus:text-red-600",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Delete Post"]})})]})]}),s.excerpt&&e.jsx("p",{className:"text-gray-600 mb-3 line-clamp-2",children:s.excerpt}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsxs(U,{className:"h-6 w-6 cursor-pointer",onClick:g=>{var w;g.stopPropagation(),(w=s.author)!=null&&w.username&&p(`profile:${s.author.username}`)},children:[e.jsx(L,{src:((t=s.author)==null?void 0:t.avatar_url)||void 0}),e.jsx(H,{children:((r=(o=s.author)==null?void 0:o.username)==null?void 0:r.charAt(0).toUpperCase())||"U"})]}),e.jsx("button",{onClick:g=>{var w;g.stopPropagation(),(w=s.author)!=null&&w.username&&p(`profile:${s.author.username}`)},className:"text-sm font-medium text-gray-700 hover:text-orange-600 hover:underline cursor-pointer transition-colors",children:((u=s.author)==null?void 0:u.username)||"Anonymous"}),e.jsx("span",{className:"text-sm text-gray-500",children:se(new Date(s.created_at),{addSuffix:!0})})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"h-4 w-4"}),s.like_count||0]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{className:"h-4 w-4"}),s.comment_count||0]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-4 w-4"}),s.views||0]})]})]})]})},s.id)})}),C&&e.jsx("div",{className:"text-center mt-8",children:e.jsx(m,{variant:"outline",onClick:()=>v(s=>s+1),disabled:h,children:h?"Loading...":"Load More"})}),f.length===0&&!h&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(T,{className:"h-16 w-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No posts yet"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Be the first to share something!"}),l&&e.jsx(m,{onClick:()=>c(!0),children:"Create First Post"})]})]}),e.jsx(ce,{open:y,onClose:()=>c(!1),onPostCreated:S})]})}export{_e as Blog};
