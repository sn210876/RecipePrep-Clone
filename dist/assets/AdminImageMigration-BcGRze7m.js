import{a as T,r as i,j as e,Z as M,C as n,t as j,v as N,E as r,m as d,B as f,a0 as L,a1 as A,V as E}from"./index-BbNpzWb-.js";import{C as b}from"./circle-play-WYjtBvxA.js";import{C as w}from"./circle-check-big-BkMSTRC5.js";import{C as v}from"./circle-x-BewHy8FG.js";function H(){var R;const{isAdmin:k}=T(),[l,c]=i.useState(!1),[y,m]=i.useState(""),[S,o]=i.useState(""),[C,x]=i.useState(""),[h,p]=i.useState(null),[t,g]=i.useState(null),[a,u]=i.useState(null);if(!k)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-muted-foreground",children:"You need admin privileges to view this page."})]})});const I=async()=>{c(!0),m("Starting recipe migration..."),p(null);try{await L(),m("Recipe migration complete!"),p({success:!0})}catch(s){console.error("Migration failed:",s),m("Recipe migration failed: "+s.message),p({success:!1,error:s.message})}finally{c(!1)}},P=async()=>{c(!0),o("Starting saved recipe migration..."),g(null);try{const s=await A();o("Saved recipe migration complete!"),g(s)}catch(s){console.error("Saved recipe migration failed:",s),o("Saved recipe migration failed: "+s.message),g({success:!1,error:s.message})}finally{c(!1)}},U=async()=>{c(!0),x("Starting post migration..."),u(null);try{const s=await E();x("Post migration complete!"),u(s)}catch(s){console.error("Post migration failed:",s),x("Post migration failed: "+s.message),u({success:!1,error:s.message})}finally{c(!1)}};return e.jsxs("div",{className:"container mx-auto py-8 px-4 max-w-4xl",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(M,{className:"h-8 w-8"}),"Image Migration Tool"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Migrate expired Instagram URLs to permanent Supabase storage"})]}),e.jsxs("div",{className:"grid gap-6",children:[e.jsxs(n,{children:[e.jsx(j,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-5 w-5 text-orange-500"}),"Recipe Images"]})}),e.jsxs(d,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"This will find all recipes with Instagram URLs and download them to permanent Supabase storage. This fixes the issue where recipe images disappear when Instagram CDN URLs expire."}),e.jsxs(f,{onClick:I,disabled:l,className:"w-full",children:[e.jsx(b,{className:"h-4 w-4 mr-2"}),l?"Migrating...":"Migrate Recipe Images"]}),y&&e.jsx("div",{className:`p-4 rounded-lg border ${(h==null?void 0:h.success)===!1?"bg-red-50 border-red-200":"bg-blue-50 border-blue-200"}`,children:e.jsx("p",{className:"text-sm font-medium",children:y})})]})]}),e.jsxs(n,{children:[e.jsx(j,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-5 w-5 text-purple-500"}),"User Saved Recipes"]})}),e.jsxs(d,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:'This will find all user saved recipes with external URLs and download them to permanent Supabase storage. This fixes disappearing images in "My Recipes" section.'}),e.jsxs(f,{onClick:P,disabled:l,className:"w-full",children:[e.jsx(b,{className:"h-4 w-4 mr-2"}),l?"Migrating...":"Migrate Saved Recipe Images"]}),S&&e.jsxs("div",{className:`p-4 rounded-lg border ${(t==null?void 0:t.success)===!1?"bg-red-50 border-red-200":"bg-blue-50 border-blue-200"}`,children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:S}),t&&e.jsxs("div",{className:"space-y-1 text-sm",children:[t.successCount!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 text-green-600"}),e.jsxs("span",{children:["Migrated: ",t.successCount]})]}),t.failCount!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 text-red-600"}),e.jsxs("span",{children:["Failed: ",t.failCount]})]}),t.skippedCount!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4 text-yellow-600"}),e.jsxs("span",{children:["Skipped: ",t.skippedCount]})]}),t.total!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4 text-blue-600"}),e.jsxs("span",{children:["Total checked: ",t.total]})]})]})]})]})]}),e.jsxs(n,{children:[e.jsx(j,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-5 w-5 text-orange-500"}),"Post Images"]})}),e.jsxs(d,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"This will find all social posts with Instagram URLs and download them to permanent Supabase storage. Posts with expired URLs will be identified for re-upload."}),e.jsxs(f,{onClick:U,disabled:l,className:"w-full",children:[e.jsx(b,{className:"h-4 w-4 mr-2"}),l?"Migrating...":"Migrate Post Images"]}),C&&e.jsxs("div",{className:`p-4 rounded-lg border ${(a==null?void 0:a.success)===!1?"bg-red-50 border-red-200":"bg-blue-50 border-blue-200"}`,children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:C}),a&&e.jsxs("div",{className:"space-y-1 text-sm",children:[a.successCount!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 text-green-600"}),e.jsxs("span",{children:["Migrated: ",a.successCount]})]}),a.expiredCount!==void 0&&a.expiredCount>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 text-red-600"}),e.jsxs("span",{children:["Expired (cannot recover): ",a.expiredCount]})]}),a.total!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4 text-blue-600"}),e.jsxs("span",{children:["Total checked: ",a.total]})]})]})]}),((R=a==null?void 0:a.expiredPosts)==null?void 0:R.length)>0&&e.jsxs("div",{className:"p-4 rounded-lg border bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Posts that need to be re-uploaded:"}),e.jsx("ul",{className:"text-sm space-y-1",children:a.expiredPosts.map(s=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(v,{className:"h-4 w-4 text-red-600 mt-0.5 flex-shrink-0"}),e.jsxs("span",{children:['"',s.title,'" (ID: ',s.id,")"]})]},s.id))})]})]})]}),e.jsx(n,{className:"border-blue-200 bg-blue-50",children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(r,{className:"h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("p",{className:"font-medium text-blue-900",children:"How this works:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-blue-800",children:[e.jsx("li",{children:"Finds all images hosted on Instagram CDN"}),e.jsx("li",{children:"Downloads each image through the proxy"}),e.jsx("li",{children:"Uploads to permanent Supabase storage"}),e.jsx("li",{children:"Updates database records with new URLs"}),e.jsx("li",{children:"Images with expired tokens cannot be recovered"})]}),e.jsx("p",{className:"text-blue-900 mt-2",children:"Run this periodically to ensure all images are permanently stored. Check the browser console for detailed progress logs."})]})]})})}),e.jsx(n,{className:"border-green-200 bg-green-50",children:e.jsx(d,{className:"pt-6",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(w,{className:"h-5 w-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("p",{className:"font-medium text-green-900",children:"Automatic Migration Active"}),e.jsx("p",{className:"text-green-800",children:"The app automatically detects and migrates external images in the background:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-green-800",children:[e.jsx("li",{children:"New recipes with external URLs are migrated immediately"}),e.jsx("li",{children:"Existing recipes are checked and migrated in batches"}),e.jsx("li",{children:"Migration runs every minute in the background"}),e.jsx("li",{children:"Maximum 10 recipes per batch to avoid rate limits"})]}),e.jsx("p",{className:"text-green-800 mt-2",children:"You can still use this page for manual bulk migration if needed."})]})]})})})]})]})}export{H as default};
