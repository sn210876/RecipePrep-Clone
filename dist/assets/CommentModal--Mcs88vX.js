const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BxbvCLt6.js","assets/index-DYGrGf0R.css"])))=>i.map(i=>d[i]);
import{r as n,s as m,f as h,j as e,X as E,B as G,_ as me,I as de}from"./index-BxbvCLt6.js";import{D as H,g as W,h as X,a as Y}from"./dialog-BBumg-40.js";import{R as ue}from"./RecipeDetailModal-CPh69H4V.js";import{C as xe,a as he}from"./chevron-right-BqMUixsR.js";import{P as pe,a as ge}from"./play-PAvbGSxu.js";import{E as fe}from"./external-link-Bd9oD5x8.js";import{S as ve}from"./send-BpM0aOUJ.js";const ye=l=>{if(!l){console.log("[imageUtils] âš ï¸ No image URL provided");return}if(console.log("[imageUtils] ðŸ“¥ Input URL:",l),l.includes("vohvdarghgqskzqjclux.supabase.co/storage"))return console.log("[imageUtils] âœ… Supabase storage URL - returning directly"),l;if(l.includes("instagram.com")||l.includes("cdninstagram.com")){console.warn("[imageUtils] âš ï¸ Instagram URL detected - this should have been reuploaded");const f=l.replace(/&amp;/g,"&"),p=`https://vohvdarghgqskzqjclux.supabase.co/functions/v1/image-proxy?url=${encodeURIComponent(f)}`;return console.log("[imageUtils] ðŸ”„ Attempting to proxy:",p),p}return console.log("[imageUtils] âž¡ï¸ Other URL - returning directly"),l},M=()=>e.jsxs("div",{className:"flex gap-2 sm:gap-3 animate-pulse",children:[e.jsx("div",{className:"w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gray-300 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"bg-gray-200 rounded-2xl px-3 py-2 space-y-2",children:[e.jsx("div",{className:"h-3 bg-gray-300 rounded w-24"}),e.jsx("div",{className:"h-3 bg-gray-300 rounded w-full"}),e.jsx("div",{className:"h-3 bg-gray-300 rounded w-3/4"})]}),e.jsx("div",{className:"h-2 bg-gray-200 rounded w-16 ml-3"})]})]}),be=()=>e.jsxs("div",{className:"space-y-3 animate-pulse",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex gap-1",children:[1,2,3,4,5].map(l=>e.jsx("div",{className:"w-4 h-4 bg-gray-300 rounded"},l))}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-24"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-20"}),e.jsx("div",{className:"flex gap-1",children:[1,2,3,4,5].map(l=>e.jsx("div",{className:"w-5 h-5 bg-gray-300 rounded"},l))})]})]});function Se({postId:l,isOpen:f,onClose:p,onCommentPosted:v}){const[P,j]=n.useState([]),[y,U]=n.useState(""),[z,q]=n.useState(!1),[A,I]=n.useState(!1),[g,Q]=n.useState(null),[Z,L]=n.useState(0),[ee,F]=n.useState(0),[N,_]=n.useState(0),[O,k]=n.useState(0),[r,se]=n.useState(null),[C,B]=n.useState(null),[$,T]=n.useState(!1),b=n.useRef(null),[R,w]=n.useState(!1),[S,D]=n.useState(0);n.useEffect(()=>{f&&l&&(console.log("[CommentModal] ðŸ”µ Modal opened with postId:",l),ae())},[f,l]);const ae=async()=>{var s,t;q(!0);try{console.log("[CommentModal] ðŸŸ¡ Starting to load data for post:",l);const{data:i}=await m.auth.getUser(),c=((s=i.user)==null?void 0:s.id)||null;Q(c);const{data:a,error:o}=await m.from("posts").select("*").eq("id",l).maybeSingle();if(console.log("[CommentModal] ðŸ“¦ Raw post data:",a),console.log("[CommentModal] ðŸ“‹ Post columns:",a?Object.keys(a):"none"),o)throw o;if(!a){console.log("[CommentModal] âš ï¸ Post not found!"),h.error("Post not found"),p();return}console.log("[CommentModal] ðŸ” Post fields:",{id:a.id,title:a.title,image_url:a.image_url,recipe_id:a.recipe_id,recipe_url:a.recipe_url,hasImageUrl:!!a.image_url});let x=null;if(a.recipe_id){console.log("[CommentModal] ðŸ”„ Fetching recipe with ID:",a.recipe_id);const{data:u,error:K}=await m.from("public_recipes").select("image_url, video_url, title").eq("id",a.recipe_id).maybeSingle();console.log("[CommentModal] ðŸ“¦ Recipe data:",u),x=u,u&&console.log("[CommentModal] ðŸ” Recipe fields:",{id:a.recipe_id,title:u.title,image_url:u.image_url,hasImageUrl:!!u.image_url})}!a.image_url&&(x!=null&&x.image_url)?(console.log("[CommentModal] âœ… Using recipe image as fallback:",x.image_url),a.image_url=x.image_url):a.image_url||console.log("[CommentModal] ðŸš¨ NO IMAGE AVAILABLE"),se(a);const[d,J,oe]=await Promise.all([m.from("post_ratings").select("rating").eq("post_id",l),m.from("comments").select("id, text, created_at, user_id, profiles!comments_user_id_fkey(username, avatar_url)").eq("post_id",l).order("created_at",{ascending:!0}),c?m.from("post_ratings").select("rating").eq("post_id",l).eq("user_id",c).maybeSingle():Promise.resolve({data:null,error:null})]);if(d.data&&d.data.length>0){const u=d.data.reduce((K,ce)=>K+ce.rating,0)/d.data.length;_(u),k(d.data.length)}J.data&&j(J.data.map(u=>({...u,profiles:Array.isArray(u.profiles)?u.profiles[0]:u.profiles}))),L(((t=oe.data)==null?void 0:t.rating)||0),a.spotify_preview_url&&setTimeout(()=>{},500)}catch(i){console.error("[CommentModal] ðŸ’¥ Error loading modal data:",i),h.error("Failed to load post details")}finally{q(!1)}},V=async()=>{try{const{data:s,error:t}=await m.from("comments").select("*").eq("post_id",l).order("created_at",{ascending:!0});if(t)throw t;if(!s||s.length===0){j([]);return}const i=[...new Set(s.map(d=>d.user_id))],{data:c,error:a}=await m.from("profiles").select("id, username, avatar_url").in("id",i);if(a)throw a;const o=new Map((c||[]).map(d=>[d.id,d])),x=s.map(d=>({...d,profiles:o.get(d.user_id)||{username:"Unknown User",avatar_url:null}}));j(x)}catch(s){console.error("Error reloading comments:",s)}},te=async()=>{try{const{data:s,error:t}=await m.from("post_ratings").select("rating").eq("post_id",l);if(t)throw t;if(s&&s.length>0){const i=s.reduce((c,a)=>c+a.rating,0)/s.length;_(i),k(s.length)}else _(0),k(0)}catch(s){console.error("Error reloading ratings:",s)}},re=async s=>{if(!g){h.error("Please log in to rate");return}try{const{error:t}=await m.from("post_ratings").upsert({post_id:l,user_id:g,rating:s},{onConflict:"post_id,user_id"});if(t)throw t;L(s),await te(),v&&v(),h.success("Rating submitted!")}catch(t){console.error("Error submitting rating:",t),h.error("Failed to submit rating")}},le=async s=>{if(s.preventDefault(),!(!y.trim()||!g)){I(!0);try{const{data:t}=await m.from("posts").select("user_id").eq("id",l).maybeSingle(),{error:i}=await m.from("comments").insert({post_id:l,user_id:g,text:y.trim()});if(i)throw i;t&&t.user_id!==g&&await m.from("notifications").insert({user_id:t.user_id,actor_id:g,type:"comment",post_id:l}),U(""),await V(),h.success("Comment posted!"),v&&v()}catch(t){console.error("Error posting comment:",t),h.error("Failed to post comment")}finally{I(!1)}}},ie=async s=>{if(confirm("Delete this comment?"))try{const{error:t}=await m.from("comments").delete().eq("id",s).eq("user_id",g);if(t)throw t;await V(),h.success("Comment deleted"),v&&v()}catch(t){console.error("Error deleting comment:",t),h.error("Failed to delete comment")}},ne=()=>{b.current&&(R?b.current.pause():b.current.play().catch(s=>console.log("Play failed:",s)),w(!R))};return!r&&z?e.jsx(H,{open:f&&!$,onOpenChange:p,children:e.jsxs(W,{children:[e.jsx(X,{className:"z-[10000000]"}),e.jsx(Y,{className:"max-w-lg w-[95vw] h-[90vh] sm:max-h-[85vh] p-0 gap-0 overflow-hidden z-[10000001] flex flex-col",onInteractOutside:s=>s.preventDefault(),onEscapeKeyDown:s=>s.preventDefault(),children:e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-3 py-2 sm:px-4 sm:py-3 space-y-2 sm:space-y-3 min-h-[100px] max-h-[35vh] sm:max-h-none",children:e.jsx("button",{onClick:p,className:"absolute top-2 right-2 w-8 h-8 bg-black/70 backdrop-blur-sm text-white rounded-full flex items-center justify-center hover:bg-black/90 z-10",children:e.jsx(E,{className:"w-5 h-5"})})}),e.jsxs("div",{className:"flex-1 flex flex-col bg-white min-h-0",children:[e.jsxs("div",{className:"px-3 py-2 sm:px-4 sm:py-3 border-b flex-shrink-0 space-y-2 animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-full"})]}),e.jsx("div",{className:"px-3 py-2 sm:px-4 sm:py-3 border-b flex-shrink-0",children:e.jsx(be,{})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-3 py-2 sm:px-4 sm:py-3 space-y-3 min-h-[100px]",children:[e.jsx(M,{}),e.jsx(M,{}),e.jsx(M,{})]}),e.jsx("div",{className:"border-t px-3 py-3 sm:px-4 sm:py-4 bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex gap-2 animate-pulse",children:[e.jsx("div",{className:"flex-1 h-9 sm:h-10 bg-gray-200 rounded-lg"}),e.jsx("div",{className:"h-9 w-9 sm:h-10 sm:w-10 bg-gray-300 rounded-lg"})]})})]})]})})]})}):e.jsxs(e.Fragment,{children:[e.jsx(H,{open:f&&!$,onOpenChange:p,children:e.jsxs(W,{children:[e.jsx(X,{className:"z-[10000000]"}),e.jsxs(Y,{className:`
    max-w-5xl
    w-[calc(100vw-1rem)]
    sm:w-[95vw]
    h-[calc(100vh-2rem)]
    sm:h-[85vh]
    p-0
    gap-0
    overflow-hidden
    z-[10000001]
    mx-2
    sm:mx-auto
  `,onInteractOutside:s=>s.preventDefault(),onEscapeKeyDown:s=>s.preventDefault(),children:[e.jsx("button",{onClick:p,className:"absolute top-2 right-2 sm:top-4 sm:right-4 w-8 h-8 bg-black/70 backdrop-blur-sm text-white rounded-full flex items-center justify-center hover:bg-black/90 z-50",children:e.jsx(E,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex flex-col sm:flex-row h-full overflow-hidden",children:[e.jsxs("div",{className:"w-full sm:w-1/2 flex flex-col bg-black sm:border-r border-gray-200",children:[e.jsxs("div",{className:"w-full h-[35vh] sm:h-[70%] bg-black flex items-center justify-center relative overflow-hidden flex-shrink-0",children:[(()=>{let s=[],t=[];if(r!=null&&r.image_url)try{const a=JSON.parse(r.image_url);Array.isArray(a)?a.forEach(o=>{s.push(o),t.push("image")}):(s.push(a),t.push("image"))}catch{s.push(r.image_url),t.push("image")}if(r!=null&&r.video_url)try{const a=JSON.parse(r.video_url);Array.isArray(a)?a.forEach(o=>{s.push(o),t.push("video")}):(s.push(a),t.push("video"))}catch{s.push(r.video_url),t.push("video")}if(s.length===0)return e.jsxs("div",{className:"text-white text-center",children:[e.jsx("p",{children:"No media available"}),e.jsxs("p",{className:"text-xs mt-2",children:["Post ID: ",l]})]});const i=s[S],c=t[S];return e.jsxs(e.Fragment,{children:[c==="video"?e.jsx("video",{src:i,controls:!0,playsInline:!0,className:"w-full h-full object-contain",preload:"metadata"},i):e.jsx("img",{src:ye(i),alt:r.title||"Post",className:"w-full h-full object-contain"},i),s.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>D(a=>a===0?s.length-1:a-1),className:"absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/70 backdrop-blur-sm text-white rounded-full flex items-center justify-center hover:bg-black/90 z-10",children:e.jsx(xe,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>D(a=>a===s.length-1?0:a+1),className:"absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/70 backdrop-blur-sm text-white rounded-full flex items-center justify-center hover:bg-black/90 z-10",children:e.jsx(he,{className:"w-5 h-5"})}),e.jsx("div",{className:"absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1.5 z-10",children:s.map((a,o)=>e.jsx("button",{onClick:()=>D(o),className:`w-1.5 h-1.5 rounded-full transition-all ${o===S?"bg-white w-4":"bg-white/50"}`},o))})]})]})})(),(r==null?void 0:r.spotify_preview_url)&&e.jsxs("div",{className:"absolute bottom-2 left-2 right-2 z-10",children:[e.jsxs("button",{onClick:ne,className:"bg-black/70 hover:bg-black/90 backdrop-blur-sm text-white px-2 py-1.5 sm:px-3 sm:py-2 rounded-full shadow-lg transition-all flex items-center gap-2 w-full",children:[R?e.jsx(pe,{className:"w-4 h-4 sm:w-5 sm:h-5"}):e.jsx(ge,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsxs("div",{className:"text-left text-[10px] sm:text-xs flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold truncate",children:r.spotify_track_name}),e.jsx("div",{className:"text-white/80 truncate",children:r.spotify_artist_name})]})]}),e.jsx("audio",{ref:b,src:r.spotify_preview_url,onPlay:()=>w(!0),onPause:()=>w(!1),onEnded:()=>w(!1)})]})]}),e.jsx("div",{className:"flex-1 sm:flex-none sm:h-[30%] bg-white overflow-y-auto",children:e.jsxs("div",{className:"p-3 sm:p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-sm sm:text-base truncate",children:(r==null?void 0:r.title)||"Post"}),(r==null?void 0:r.caption)&&e.jsx("p",{className:"text-xs sm:text-sm text-gray-600 mt-0.5 line-clamp-2",children:r.caption})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex items-center",children:[1,2,3,4,5].map(s=>e.jsx("span",{className:`text-sm sm:text-base ${s<=N?"opacity-100":"opacity-20 grayscale"}`,children:"ðŸ”¥"},s))}),e.jsxs("span",{className:"text-xs sm:text-sm text-gray-600",children:[N>0?N.toFixed(1):"No ratings",O>0&&` (${O})`]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs sm:text-sm text-gray-700 font-medium",children:"Your rating:"}),e.jsx("div",{className:"flex items-center gap-0.5 sm:gap-1",children:[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onClick:()=>re(s),onMouseEnter:()=>F(s),onMouseLeave:()=>F(0),className:"transition-transform active:scale-110 touch-manipulation p-1",children:e.jsx("span",{className:`text-base sm:text-lg ${s<=(ee||Z)?"opacity-100":"opacity-20 grayscale"}`,children:"ðŸ”¥"})},s))})]})]}),((r==null?void 0:r.recipe_id)||(r==null?void 0:r.recipe_url))&&e.jsxs(G,{onClick:async()=>{if(r.recipe_id){const{getRecipeById:s}=await me(async()=>{const{getRecipeById:i}=await import("./index-BxbvCLt6.js").then(c=>c.ai);return{getRecipeById:i}},__vite__mapDeps([0,1])),t=await s(r.recipe_id);t?(B(t),T(!0)):h.error("Recipe not found")}else r.recipe_url&&window.open(r.recipe_url,"_blank")},variant:"outline",size:"sm",className:"border-orange-600 text-orange-600 hover:bg-orange-50 w-full",children:[e.jsx(fe,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1.5"}),e.jsx("span",{className:"text-xs sm:text-sm",children:"View Recipe"})]})]})})]}),e.jsxs("div",{className:"w-full sm:w-1/2 flex flex-col bg-white min-h-0",children:[e.jsx("div",{className:"px-3 py-2 sm:px-4 sm:py-3 border-b flex-shrink-0",children:e.jsx("h3",{className:"font-bold text-sm sm:text-base",children:"Comments"})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-3 py-2 sm:px-4 sm:py-3 space-y-2 sm:space-y-3 min-h-0",children:z?e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"})}):P.length===0?e.jsx("div",{className:"text-center py-8 sm:py-12 text-gray-500 text-xs sm:text-sm",children:"No comments yet. Be the first to comment!"}):P.map(s=>{var t,i,c,a,o;return e.jsxs("div",{className:"flex gap-2 sm:gap-3 group",children:[(t=s.profiles)!=null&&t.avatar_url?e.jsx("img",{src:s.profiles.avatar_url,alt:s.profiles.username,className:"w-7 h-7 sm:w-8 sm:h-8 rounded-full object-cover flex-shrink-0"}):e.jsx("div",{className:"w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-medium text-xs flex-shrink-0",children:(a=(c=(i=s.profiles)==null?void 0:i.username)==null?void 0:c[0])==null?void 0:a.toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"bg-gray-100 rounded-2xl px-3 py-2 relative",children:[e.jsx("button",{onClick:()=>{var x;return window.location.href=`/${((x=s.profiles)==null?void 0:x.username)||"user"}`},className:"font-semibold text-xs sm:text-sm hover:underline",children:(o=s.profiles)==null?void 0:o.username}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-700 break-words mt-0.5",children:s.text}),g===s.user_id&&e.jsx("button",{onClick:()=>ie(s.id),className:"absolute top-1 right-1 p-1.5 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity touch-manipulation",title:"Delete comment",children:e.jsx(E,{className:"w-3 h-3"})})]}),e.jsx("p",{className:"text-[10px] sm:text-xs text-gray-400 mt-1 px-3",children:new Date(s.created_at).toLocaleDateString()})]})]},s.id)})}),e.jsx("form",{onSubmit:le,className:"border-t px-3 py-3 sm:px-4 sm:py-4 bg-white flex-shrink-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(de,{value:y,onChange:s=>U(s.target.value),placeholder:"Add a comment...",disabled:A,className:"flex-1 text-xs sm:text-sm h-9 sm:h-10"}),e.jsx(G,{type:"submit",disabled:!y.trim()||A,size:"icon",className:"bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 flex-shrink-0 h-9 w-9 sm:h-10 sm:w-10",children:e.jsx(ve,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"})})]})})]})]})]})]})}),C&&e.jsx(ue,{recipe:C,open:!!C,onOpenChange:s=>{s||(B(null),T(!1))}})]})}export{Se as C};
