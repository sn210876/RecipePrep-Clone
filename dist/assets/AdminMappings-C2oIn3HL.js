import{r as a,s as i,f as t,j as e,C,m as S,E as ee,t as U,v as q,x as H,B as x,z as B,I,L as R,y as g}from"./index-CFcEIvk0.js";import{B as se}from"./badge-BB_ADSGZ.js";import{S as re}from"./slider-L6Pxtq0i.js";import{D as ae,a as te,b as ne,c as ie,e as ce}from"./dialog-BrYFdSIU.js";import{s as de}from"./amazonProductService-Bzr1CW8E.js";import{T as oe}from"./trending-up-HgiIkQs4.js";import{L as le}from"./link-X7Opauz6.js";import{T as me}from"./trash-2-B8KKquOg.js";import"./index-BdQq_4o_.js";import"./index-1QZ8LZ03.js";import"./react-icons.esm-DuzKoBVU.js";import"./index-COl3SmFl.js";import"./index-D4QaU0nE.js";import"./index-DOmoM7Cu.js";import"./index-BSlGnwL5.js";import"./index-ge_6xC-6.js";import"./index-D1BiB0bT.js";import"./index-ehrYPIHP.js";function ze(){const[f,$]=a.useState([]),[j,F]=a.useState([]),[Y,M]=a.useState(!1),[u,O]=a.useState(""),[N,z]=a.useState(!1),[Q,l]=a.useState(!1),[h,y]=a.useState(""),[m,A]=a.useState(""),[D,L]=a.useState([]),[c,k]=a.useState(null),[v,P]=a.useState(.8),[V,E]=a.useState(!1);a.useEffect(()=>{W()},[]),a.useEffect(()=>{N&&(_(),b())},[N,u]),a.useEffect(()=>{m.length>=2?G():L([])},[m]);async function W(){const{data:{user:s}}=await i.auth.getUser();if(!s){t.error("You must be logged in");return}const{data:r,error:d}=await i.from("admin_users").select("*").eq("user_id",s.id).maybeSingle();if(d||!r){t.error("You do not have admin access"),z(!1);return}z(!0)}async function _(){M(!0);try{let s=i.from("ingredient_product_mappings").select(`
          id,
          ingredient_name,
          amazon_product_id,
          confidence_score,
          amazon_products (*)
        `).order("created_at",{ascending:!1});u.trim()&&(s=s.ilike("ingredient_name",`%${u}%`));const{data:r,error:d}=await s;if(d)throw d;const w=(r||[]).filter(n=>n.amazon_products).map(n=>({id:n.id,ingredient_name:n.ingredient_name,amazon_product_id:n.amazon_product_id,confidence_score:n.confidence_score,product:n.amazon_products}));$(w)}catch(s){console.error("Failed to load mappings:",s),t.error("Failed to load mappings")}finally{M(!1)}}async function b(){try{const{data:s,error:r}=await i.rpc("get_unmapped_ingredients");if(r){const{data:d}=await i.from("cart_items").select("ingredient_name").is("amazon_product_url",null);if(d){const w=d.reduce((o,p)=>{const T=p.ingredient_name.toLowerCase().trim();return o[T]=(o[T]||0)+1,o},{}),n=Object.entries(w).map(([o,p])=>({ingredient_name:o,count:p})).sort((o,p)=>p.count-o.count);F(n)}return}F(s||[])}catch(s){console.error("Failed to load unmapped ingredients:",s)}}async function G(){if(m.trim()){E(!0);try{const s=await de(m);L(s)}catch(s){console.error("Product search failed:",s),t.error("Failed to search products")}finally{E(!1)}}}async function J(){if(!c||!h){t.error("Please select an ingredient and product");return}try{const{data:{user:s}}=await i.auth.getUser(),{error:r}=await i.from("ingredient_product_mappings").insert({ingredient_name:h.toLowerCase().trim(),amazon_product_id:c.id,confidence_score:v,created_by:s==null?void 0:s.id});if(r){if(r.code==="23505")t.error("This mapping already exists");else throw r;return}t.success("Mapping created successfully"),l(!1),y(""),A(""),k(null),P(.8),_(),b()}catch(s){console.error("Failed to create mapping:",s),t.error("Failed to create mapping")}}async function K(s){if(confirm("Are you sure you want to delete this mapping?"))try{const{error:r}=await i.from("ingredient_product_mappings").delete().eq("id",s);if(r)throw r;t.success("Mapping deleted"),_(),b()}catch(r){console.error("Failed to delete mapping:",r),t.error("Failed to delete mapping")}}function X(s){return s>=.9?"Very High":s>=.7?"High":s>=.5?"Medium":"Low"}function Z(s){return s>=.9?"text-green-600":s>=.7?"text-blue-600":s>=.5?"text-yellow-600":"text-red-600"}return N?e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Ingredient Mappings"}),e.jsx("p",{className:"text-gray-600",children:"Manage ingredient-to-product mappings for better product matching"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6",children:[e.jsxs(C,{children:[e.jsxs(U,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),"Unmapped Ingredients (",j.length,")"]}),e.jsx(H,{children:"Ingredients requested but not yet mapped to products"})]}),e.jsx(S,{children:j.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"All ingredients are mapped!"})}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:j.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.ingredient_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Requested ",s.count," time",s.count!==1?"s":""]})]}),e.jsxs(x,{size:"sm",onClick:()=>{y(s.ingredient_name),l(!0)},children:[e.jsx(B,{className:"w-4 h-4 mr-1"}),"Map"]})]},r))})})]}),e.jsxs(C,{children:[e.jsxs(U,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-5 h-5"}),"All Mappings (",f.length,")"]}),e.jsx(H,{children:"Existing ingredient-to-product relationships"})]}),e.jsxs(S,{children:[e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx(I,{placeholder:"Search ingredient...",value:u,onChange:s=>O(s.target.value),className:"flex-1"}),e.jsxs(x,{onClick:()=>l(!0),children:[e.jsx(B,{className:"w-4 h-4 mr-1"}),"New"]})]}),Y?e.jsx("div",{className:"text-center py-8",children:e.jsx(R,{className:"w-8 h-8 animate-spin mx-auto"})}):f.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No mappings found"})}):e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:f.map(s=>e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.ingredient_name}),e.jsxs("p",{className:"text-sm text-gray-600 flex items-center gap-1 mt-1",children:["→ ",s.product.product_name]})]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>K(s.id),children:e.jsx(me,{className:"w-4 h-4 text-red-600"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Confidence:"}),e.jsxs(se,{variant:"secondary",className:Z(s.confidence_score),children:[(s.confidence_score*100).toFixed(0),"% - ",X(s.confidence_score)]})]})]},s.id))})]})]})]}),e.jsx(ae,{open:Q,onOpenChange:l,children:e.jsxs(te,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(ie,{children:"Create Ingredient Mapping"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"ingredient",children:"Ingredient Name"}),e.jsx(I,{id:"ingredient",value:h,onChange:s=>y(s.target.value),placeholder:"e.g., flour, sugar, milk"})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"product-search",children:"Search for Product"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{id:"product-search",value:m,onChange:s=>A(s.target.value),placeholder:"Search by name, ASIN, brand..."}),V&&e.jsx(R,{className:"w-5 h-5 animate-spin mt-2"})]})]}),D.length>0&&e.jsxs("div",{children:[e.jsx(g,{children:"Select Product"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border rounded p-2",children:D.map(s=>e.jsxs("div",{onClick:()=>k(s),className:`flex items-center gap-3 p-3 rounded cursor-pointer border-2 transition-colors ${(c==null?void 0:c.id)===s.id?"border-blue-500 bg-blue-50":"border-transparent hover:bg-gray-50"}`,children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:s.product_name,className:"w-12 h-12 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:s.product_name}),e.jsxs("p",{className:"text-xs text-gray-600",children:["ASIN: ",s.asin," • ",s.brand||"No brand",s.price&&` • $${s.price.toFixed(2)}`]})]})]},s.id))})]}),c&&e.jsxs("div",{children:[e.jsxs(g,{children:["Confidence Score: ",(v*100).toFixed(0),"%"]}),e.jsx(re,{value:[v*100],onValueChange:([s])=>P(s/100),min:50,max:100,step:5,className:"mt-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-600 mt-1",children:[e.jsx("span",{children:"Low (50%)"}),e.jsx("span",{children:"Medium (70%)"}),e.jsx("span",{children:"High (90%)"}),e.jsx("span",{children:"Perfect (100%)"})]})]})]}),e.jsxs(ce,{children:[e.jsx(x,{variant:"outline",onClick:()=>l(!1),children:"Cancel"}),e.jsx(x,{onClick:J,disabled:!c||!h,children:"Create Mapping"})]})]})})]}):e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsx(C,{children:e.jsx(S,{className:"pt-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ee,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You do not have admin privileges to access this page."})]})})})})}export{ze as AdminMappings};
