import{r as l,j as e,aO as O,aP as H,aL as J,a6 as Q,aN as M,aQ as W,aM as G,aR as K,ap as X}from"./react-vendor-z9ssXL8w.js";import{u as R,s as L,B as n,T}from"./page-addrecipe-Pb6dTsbS.js";import{A as U,d as z,e as V,S as Y}from"./page-adminpayouts-D8abdeR0.js";import{D as Z,a as ee,b as se,c as te,s as re,g as ae}from"./page-blog-DTt-yulm.js";import{v as le,l as oe,m as F,n as ie,o as ne,p as ce}from"./services-BpcRR5rK.js";import{b as I,u as o}from"./vendor-Clj4czuh.js";import"./ui-vendor-BA32w1ww.js";import"./capacitor-vendor-Dh3Cr3CD.js";import"./supabase-vendor-DpDh9Ika.js";import"./page-grocerylist-9H8dAkfw.js";import"./page-adminproducts-DimmU9B1.js";function q({comment:r,postId:c,onCommentAdded:p,depth:s=0,onNavigate:m}){var $;const{user:i}=R(),[S,y]=l.useState(!1),[j,u]=l.useState(""),[w,N]=l.useState(!1),[d,h]=l.useState(r.vote_score||0),[x,g]=l.useState(r.user_vote),[C,k]=l.useState(!1);l.useEffect(()=>{i&&L.from("profiles").select("is_admin").eq("id",i.id).single().then(({data:a})=>k((a==null?void 0:a.is_admin)===!0))},[i]);const f=async a=>{if(!i){o.error("Please log in to vote");return}try{const b=x===a,P=x;b?(g(null),h(d+(a==="up"?-1:1))):(g(a),h(P?d+(a==="up"?2:-2):d+(a==="up"?1:-1))),await le(r.id,a)}catch(b){console.error("Error voting:",b),g(r.user_vote),h(r.vote_score||0),o.error("Failed to vote")}},A=async()=>{if(!i){o.error("Please log in to comment");return}if(!j.trim()){o.error("Comment cannot be empty");return}N(!0);try{await F(c,j,r.id),u(""),y(!1),o.success("Reply posted!"),p()}catch(a){console.error("Error posting reply:",a),o.error("Failed to post reply")}finally{N(!1)}},E=async()=>{if(confirm("Are you sure you want to delete this comment?"))try{await oe(r.id),o.success("Comment deleted successfully"),p()}catch(a){console.error("Error deleting comment:",a),o.error("Failed to delete comment")}},_=s<5;return e.jsx("div",{className:`${s>0?"ml-8 mt-4":"mt-4"}`,children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center gap-1 pt-1",children:[e.jsx(n,{variant:"ghost",size:"sm",className:`h-6 w-6 p-0 ${x==="up"?"text-orange-500":"text-gray-400"}`,onClick:()=>f("up"),children:e.jsx(O,{className:"h-4 w-4"})}),e.jsx("span",{className:`text-xs font-medium ${d>0?"text-orange-500":d<0?"text-blue-500":"text-gray-500"}`,children:d}),e.jsx(n,{variant:"ghost",size:"sm",className:`h-6 w-6 p-0 ${x==="down"?"text-blue-500":"text-gray-400"}`,onClick:()=>f("down"),children:e.jsx(H,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs(U,{className:"h-6 w-6 cursor-pointer",onClick:()=>r.author.username&&(m==null?void 0:m(`profile:${r.author.username}`)),children:[e.jsx(z,{src:r.author.avatar_url||void 0}),e.jsx(V,{children:(($=r.author.username)==null?void 0:$.charAt(0).toUpperCase())||"U"})]}),e.jsx("button",{onClick:()=>r.author.username&&(m==null?void 0:m(`profile:${r.author.username}`)),className:"text-sm font-medium text-gray-900 hover:text-orange-600 hover:underline cursor-pointer transition-colors",children:r.author.username||"Anonymous"}),e.jsx("span",{className:"text-xs text-gray-500",children:I(new Date(r.created_at),{addSuffix:!0})}),((i==null?void 0:i.id)===r.user_id||C)&&e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsx(n,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",children:e.jsx(J,{className:"h-3 w-3"})})}),e.jsx(se,{align:"end",children:e.jsxs(te,{onClick:E,className:"text-red-600 focus:text-red-600",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Delete Comment"]})})]})]}),e.jsx("p",{className:"text-sm text-gray-700 mb-2 whitespace-pre-wrap",children:r.content}),e.jsx("div",{className:"flex items-center gap-2",children:_&&e.jsxs(n,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>y(!S),children:[e.jsx(M,{className:"h-3 w-3 mr-1"}),"Reply"]})}),S&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx(T,{placeholder:"Write a reply...",value:j,onChange:a=>u(a.target.value),className:"min-h-[80px] text-sm"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{size:"sm",onClick:A,disabled:w||!j.trim(),children:w?"Posting...":"Post Reply"}),e.jsx(n,{size:"sm",variant:"ghost",onClick:()=>{y(!1),u("")},children:"Cancel"})]})]}),r.replies&&r.replies.length>0&&e.jsx("div",{className:"mt-2",children:r.replies.map(a=>e.jsx(q,{comment:a,postId:c,onCommentAdded:p,depth:s+1,onNavigate:m},a.id))})]})]})})}function ye({slug:r,onNavigate:c}){var a,b,P,D;const{user:p}=R(),[s,m]=l.useState(null),[i,S]=l.useState([]),[y,j]=l.useState(!0),[u,w]=l.useState(""),[N,d]=l.useState(!1),[h,x]=l.useState(!1),[g,C]=l.useState(0);l.useEffect(()=>{k()},[r]),l.useEffect(()=>{var t,v;s&&(re({title:s.title,description:s.excerpt||"Read this post on MealScrape",image:s.cover_image||void 0,url:`${window.location.origin}/blog/${s.slug}`,type:"article",author:((t=s.author)==null?void 0:t.username)||"MealScrape User",publishedTime:s.created_at}),ae({title:s.title,description:s.excerpt||"",image:s.cover_image||void 0,author:((v=s.author)==null?void 0:v.username)||"MealScrape User",authorUrl:s.author?`${window.location.origin}/${s.author.username}`:void 0,publishedTime:s.created_at,modifiedTime:s.updated_at,url:`${window.location.origin}/blog/${s.slug}`}))},[s]),l.useEffect(()=>{if(!s)return;const t=L.channel(`blog-post-${s.id}`).on("postgres_changes",{event:"*",schema:"public",table:"blog_comments",filter:`post_id=eq.${s.id}`},()=>{f()}).on("postgres_changes",{event:"*",schema:"public",table:"blog_likes",filter:`post_id=eq.${s.id}`},()=>{k()}).subscribe();return()=>{L.removeChannel(t)}},[s==null?void 0:s.id]);const k=async()=>{try{const t=await ie(r);if(!t){o.error("Post not found"),c("blog");return}m(t),x(t.user_has_liked||!1),C(t.like_count||0),f()}catch(t){console.error("Error loading post:",t),o.error("Failed to load post")}finally{j(!1)}},f=async()=>{if(s)try{const t=await ne(s.id);S(t)}catch(t){console.error("Error loading comments:",t)}},A=async()=>{if(!p){o.error("Please log in to like posts");return}if(!s)return;const t=h;x(!h),C(g+(t?-1:1));try{await ce(s.id)}catch(v){console.error("Error toggling like:",v),x(t),C(g),o.error("Failed to like post")}},E=async()=>{if(!p){o.error("Please log in to comment");return}if(s){if(!u.trim()){o.error("Comment cannot be empty");return}d(!0);try{await F(s.id,u),w(""),o.success("Comment posted!"),f()}catch(t){console.error("Error posting comment:",t),o.error("Failed to post comment")}finally{d(!1)}}},B=async()=>{if(!s)return;const t=`${window.location.origin}/blog/${s.slug}`;if(navigator.share)try{await navigator.share({title:s.title,text:s.excerpt||s.title,url:t})}catch(v){v.name!=="AbortError"&&_(t)}else _(t)},_=t=>{navigator.clipboard.writeText(t),o.success("Link copied to clipboard!")};if(y)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 pt-2 pb-8",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-12 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]})})});if(!s)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Post not found"}),e.jsx(n,{onClick:()=>c("blog"),children:"Back to Blog"})]})});const $=t=>typeof t=="string"?t:t.html?e.jsx("div",{className:"prose prose-lg max-w-none",dangerouslySetInnerHTML:{__html:t.html.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" class="text-orange-600 hover:underline" target="_blank" rel="noopener noreferrer">$1</a>').replace(new RegExp('(?<!href="|src=")(https?:\\/\\/[^\\s<]+)',"g"),'<a href="$1" class="text-orange-600 hover:underline" target="_blank" rel="noopener noreferrer">$1</a>').replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>\n?)+/g,'<ul class="list-disc pl-4 my-4">$&</ul>').replace(/\n\n/g,'</p><p class="mt-4">').replace(/^(.+)$/,"<p>$1</p>")}}):JSON.stringify(t);return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 pt-2 pb-8",children:[e.jsxs(n,{variant:"ghost",onClick:()=>c("blog"),className:"mb-6",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Back to Blog"]}),e.jsxs("article",{children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-gray-900 mb-6",children:s.title}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(U,{className:"h-10 w-10 cursor-pointer",onClick:()=>{var t;return((t=s.author)==null?void 0:t.username)&&c(`profile:${s.author.username}`)},children:[e.jsx(z,{src:((a=s.author)==null?void 0:a.avatar_url)||void 0}),e.jsx(V,{children:((P=(b=s.author)==null?void 0:b.username)==null?void 0:P.charAt(0).toUpperCase())||"U"})]}),e.jsxs("div",{children:[e.jsx("button",{onClick:()=>{var t;return((t=s.author)==null?void 0:t.username)&&c(`profile:${s.author.username}`)},className:"font-medium text-gray-900 hover:text-orange-600 hover:underline cursor-pointer transition-colors",children:((D=s.author)==null?void 0:D.username)||"Anonymous"}),e.jsx("p",{className:"text-sm text-gray-500",children:I(new Date(s.created_at),{addSuffix:!0})})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(n,{variant:"ghost",size:"sm",onClick:A,className:h?"text-red-500":"",children:[e.jsx(G,{className:`h-5 w-5 mr-1 ${h?"fill-red-500":""}`}),g]}),e.jsxs(n,{variant:"ghost",size:"sm",onClick:B,children:[e.jsx(K,{className:"h-5 w-5 mr-1"}),"Share"]})]})]}),s.cover_image&&e.jsx("div",{className:"flex justify-center mb-8",children:e.jsx("img",{src:s.cover_image,alt:s.title,className:"w-full max-w-md aspect-square object-cover rounded-xl shadow-lg"})}),e.jsx("div",{className:"prose prose-lg max-w-none mb-8",children:$(s.content)}),e.jsxs("div",{className:"flex items-center gap-6 text-sm text-gray-500 mb-8",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),s.views," views"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(M,{className:"h-4 w-4"}),i.length," comments"]})]}),e.jsx(Y,{className:"my-8"}),e.jsxs("div",{className:"mt-8",children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:["Comments (",i.length,")"]}),p?e.jsxs("div",{className:"mb-8 space-y-3",children:[e.jsx(T,{placeholder:"Share your thoughts...",value:u,onChange:t=>w(t.target.value),className:"min-h-[100px]"}),e.jsx(n,{onClick:E,disabled:N||!u.trim(),children:N?"Posting...":"Post Comment"})]}):e.jsx("div",{className:"mb-8 p-4 bg-gray-50 rounded-lg text-center",children:e.jsx("p",{className:"text-gray-600",children:"Please log in to leave a comment"})}),e.jsxs("div",{className:"space-y-4",children:[i.map(t=>e.jsx(q,{comment:t,postId:s.id,onCommentAdded:f,onNavigate:c},t.id)),i.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No comments yet. Be the first to comment!"})]})]})]})]})})}export{ye as BlogPostPage};
