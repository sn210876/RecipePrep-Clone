import{r,j as e,a0 as Y,a1 as ae,a2 as re,a3 as ne,Y as te,a4 as ie,Q as H,a5 as ce,H as U,a6 as de}from"./react-vendor-CdxBdSXn.js";import{f as le,s as i,C as S,c as M,a as q,b as $,g as O,B as p,I,h as oe,D as me,i as ue,j as he,k as xe,L as j,l as pe}from"./page-addrecipe-DiItHnEU.js";import{u as n}from"./vendor-Bm4oc8-A.js";import{c as ge}from"./services-TCLpZZGf.js";const B=r.forwardRef(({className:o,...y},m)=>e.jsxs(Y,{ref:m,className:le("relative flex w-full touch-none select-none items-center",o),...y,children:[e.jsx(ae,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:e.jsx(re,{className:"absolute h-full bg-primary"})}),e.jsx(ne,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));B.displayName=Y.displayName;function fe(){const[o,y]=r.useState([]),[m,F]=r.useState([]),[Q,k]=r.useState(!1),[g,V]=r.useState(""),[N,A]=r.useState(!1),[W,u]=r.useState(!1),[f,b]=r.useState(""),[h,z]=r.useState(""),[D,P]=r.useState([]),[c,L]=r.useState(null),[v,T]=r.useState(.8),[G,R]=r.useState(!1);r.useEffect(()=>{J()},[]),r.useEffect(()=>{N&&(_(),w())},[N,g]),r.useEffect(()=>{h.length>=2?K():P([])},[h]);async function J(){const{data:{user:s}}=await i.auth.getUser();if(!s){n.error("You must be logged in");return}const{data:a,error:d}=await i.from("admin_users").select("*").eq("user_id",s.id).maybeSingle();if(d||!a){n.error("You do not have admin access"),A(!1);return}A(!0)}async function _(){k(!0);try{let s=i.from("ingredient_product_mappings").select(`
          id,
          ingredient_name,
          amazon_product_id,
          confidence_score,
          amazon_products (*)
        `).order("created_at",{ascending:!1});g.trim()&&(s=s.ilike("ingredient_name",`%${g}%`));const{data:a,error:d}=await s;if(d)throw d;const C=(a||[]).filter(t=>t.amazon_products).map(t=>({id:t.id,ingredient_name:t.ingredient_name,amazon_product_id:t.amazon_product_id,confidence_score:t.confidence_score,product:t.amazon_products}));y(C)}catch(s){console.error("Failed to load mappings:",s),n.error("Failed to load mappings")}finally{k(!1)}}async function w(){try{const{data:s,error:a}=await i.rpc("get_unmapped_ingredients");if(a){const{data:d}=await i.from("cart_items").select("ingredient_name").is("amazon_product_url",null);if(d){const C=d.reduce((l,x)=>{const E=x.ingredient_name.toLowerCase().trim();return l[E]=(l[E]||0)+1,l},{}),t=Object.entries(C).map(([l,x])=>({ingredient_name:l,count:x})).sort((l,x)=>x.count-l.count);F(t)}return}F(s||[])}catch(s){console.error("Failed to load unmapped ingredients:",s)}}async function K(){if(h.trim()){R(!0);try{const s=await ge(h);P(s)}catch(s){console.error("Product search failed:",s),n.error("Failed to search products")}finally{R(!1)}}}async function X(){if(!c||!f){n.error("Please select an ingredient and product");return}try{const{data:{user:s}}=await i.auth.getUser(),{error:a}=await i.from("ingredient_product_mappings").insert({ingredient_name:f.toLowerCase().trim(),amazon_product_id:c.id,confidence_score:v,created_by:s==null?void 0:s.id});if(a){if(a.code==="23505")n.error("This mapping already exists");else throw a;return}n.success("Mapping created successfully"),u(!1),b(""),z(""),L(null),T(.8),_(),w()}catch(s){console.error("Failed to create mapping:",s),n.error("Failed to create mapping")}}async function Z(s){if(confirm("Are you sure you want to delete this mapping?"))try{const{error:a}=await i.from("ingredient_product_mappings").delete().eq("id",s);if(a)throw a;n.success("Mapping deleted"),_(),w()}catch(a){console.error("Failed to delete mapping:",a),n.error("Failed to delete mapping")}}function ee(s){return s>=.9?"Very High":s>=.7?"High":s>=.5?"Medium":"Low"}function se(s){return s>=.9?"text-green-600":s>=.7?"text-blue-600":s>=.5?"text-yellow-600":"text-red-600"}return N?e.jsxs("div",{className:"max-w-7xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Ingredient Mappings"}),e.jsx("p",{className:"text-gray-600",children:"Manage ingredient-to-product mappings for better product matching"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6",children:[e.jsxs(S,{children:[e.jsxs(q,{children:[e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),"Unmapped Ingredients (",m.length,")"]}),e.jsx(O,{children:"Ingredients requested but not yet mapped to products"})]}),e.jsx(M,{children:m.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"All ingredients are mapped!"})}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:m.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.ingredient_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Requested ",s.count," time",s.count!==1?"s":""]})]}),e.jsxs(p,{size:"sm",onClick:()=>{b(s.ingredient_name),u(!0)},children:[e.jsx(H,{className:"w-4 h-4 mr-1"}),"Map"]})]},a))})})]}),e.jsxs(S,{children:[e.jsxs(q,{children:[e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),"All Mappings (",o.length,")"]}),e.jsx(O,{children:"Existing ingredient-to-product relationships"})]}),e.jsxs(M,{children:[e.jsxs("div",{className:"mb-4 flex gap-2",children:[e.jsx(I,{placeholder:"Search ingredient...",value:g,onChange:s=>V(s.target.value),className:"flex-1"}),e.jsxs(p,{onClick:()=>u(!0),children:[e.jsx(H,{className:"w-4 h-4 mr-1"}),"New"]})]}),Q?e.jsx("div",{className:"text-center py-8",children:e.jsx(U,{className:"w-8 h-8 animate-spin mx-auto"})}):o.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{children:"No mappings found"})}):e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:o.map(s=>e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.ingredient_name}),e.jsxs("p",{className:"text-sm text-gray-600 flex items-center gap-1 mt-1",children:["→ ",s.product.product_name]})]}),e.jsx(p,{size:"sm",variant:"ghost",onClick:()=>Z(s.id),children:e.jsx(de,{className:"w-4 h-4 text-red-600"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Confidence:"}),e.jsxs(oe,{variant:"secondary",className:se(s.confidence_score),children:[(s.confidence_score*100).toFixed(0),"% - ",ee(s.confidence_score)]})]})]},s.id))})]})]})]}),e.jsx(me,{open:W,onOpenChange:u,children:e.jsxs(ue,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsx(he,{children:e.jsx(xe,{children:"Create Ingredient Mapping"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"ingredient",children:"Ingredient Name"}),e.jsx(I,{id:"ingredient",value:f,onChange:s=>b(s.target.value),placeholder:"e.g., flour, sugar, milk"})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"product-search",children:"Search for Product"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{id:"product-search",value:h,onChange:s=>z(s.target.value),placeholder:"Search by name, ASIN, brand..."}),G&&e.jsx(U,{className:"w-5 h-5 animate-spin mt-2"})]})]}),D.length>0&&e.jsxs("div",{children:[e.jsx(j,{children:"Select Product"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border rounded p-2",children:D.map(s=>e.jsxs("div",{onClick:()=>L(s),className:`flex items-center gap-3 p-3 rounded cursor-pointer border-2 transition-colors ${(c==null?void 0:c.id)===s.id?"border-blue-500 bg-blue-50":"border-transparent hover:bg-gray-50"}`,children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:s.product_name,className:"w-12 h-12 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:s.product_name}),e.jsxs("p",{className:"text-xs text-gray-600",children:["ASIN: ",s.asin," • ",s.brand||"No brand",s.price&&` • $${s.price.toFixed(2)}`]})]})]},s.id))})]}),c&&e.jsxs("div",{children:[e.jsxs(j,{children:["Confidence Score: ",(v*100).toFixed(0),"%"]}),e.jsx(B,{value:[v*100],onValueChange:([s])=>T(s/100),min:50,max:100,step:5,className:"mt-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-600 mt-1",children:[e.jsx("span",{children:"Low (50%)"}),e.jsx("span",{children:"Medium (70%)"}),e.jsx("span",{children:"High (90%)"}),e.jsx("span",{children:"Perfect (100%)"})]})]})]}),e.jsxs(pe,{children:[e.jsx(p,{variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsx(p,{onClick:X,disabled:!c||!f,children:"Create Mapping"})]})]})})]}):e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsx(S,{children:e.jsx(M,{className:"pt-6",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(te,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You do not have admin privileges to access this page."})]})})})})}const ve=Object.freeze(Object.defineProperty({__proto__:null,AdminMappings:fe},Symbol.toStringTag,{value:"Module"}));export{ve as A,B as S};
