import{s as l}from"./index-JyBq9rLv.js";const g=["fresh","organic","produce","vegetable","fruit","greens","lettuce","tomato","cucumber","carrot","onion","garlic","bell pepper","mushroom","spinach","kale","broccoli","cauliflower"],h=["chicken","beef","pork","turkey","lamb","fish","salmon","shrimp","meat","steak","ground","breast","thigh","tenderloin"],y=["milk","cheese","yogurt","butter","cream","sour cream","cottage cheese","mozzarella","cheddar","parmesan","eggs"],f=["rice","pasta","flour","sugar","salt","pepper","oil","vinegar","sauce","canned","dried","spice","seasoning","baking powder","baking soda","vanilla extract"],v=["frozen","ice cream","popsicle","frozen peas","frozen corn","frozen berries","frozen vegetables"],b=["organic","grass-fed","free-range","pasture-raised","wild-caught","non-gmo","gluten-free","vegan","sustainable","local","artisan"];function z(e,a){const r=e.toLowerCase(),n=b.some(t=>r.includes(t));if(g.some(t=>r.includes(t))){let t="instacart";return(a==null?void 0:a.enableInstacart)!==!1?t="instacart":n&&(a!=null&&a.enableWholeFoods)?t="whole_foods":a!=null&&a.enableAmazonFresh&&(t="amazon_fresh"),{category:"fresh_produce",freshnessPriority:10,recommendedService:t}}if(h.some(t=>r.includes(t))){let t="instacart";return(a==null?void 0:a.enableInstacart)!==!1?t="instacart":n&&(a!=null&&a.enableWholeFoods)?t="whole_foods":a!=null&&a.enableAmazonFresh&&(t="amazon_fresh"),{category:"meat",freshnessPriority:10,recommendedService:t}}if(y.some(t=>r.includes(t))){let t="instacart";return(a==null?void 0:a.enableInstacart)!==!1?t="instacart":n&&(a!=null&&a.enableWholeFoods)?t="whole_foods":a!=null&&a.enableAmazonFresh&&(t="amazon_fresh"),{category:"dairy",freshnessPriority:9,recommendedService:t}}if(v.some(t=>r.includes(t))){let t="instacart";return(a==null?void 0:a.enableInstacart)!==!1?t="instacart":a!=null&&a.enableAmazonFresh&&(t="amazon_fresh"),{category:"frozen",freshnessPriority:6,recommendedService:t}}if(f.some(t=>r.includes(t))){let t="amazon";return a!=null&&a.enableAmazonGrocery&&(t="amazon_grocery"),{category:"pantry",freshnessPriority:2,recommendedService:t}}let o="amazon";return a!=null&&a.enableAmazonGrocery&&(o="amazon_grocery"),{category:"other",freshnessPriority:5,recommendedService:o}}async function w(e){const{data:a,error:r}=await l.from("ingredient_delivery_routing").select("*").eq("ingredient_name",e.toLowerCase().trim()).maybeSingle();return r?(console.error("Error fetching routing rule:",r),null):a}async function P(e,a){const r=await S(a),n=await Promise.all(e.map(async o=>{const t=await w(o.name);if(t)return{...o,recommendedService:t.recommended_service,category:t.category,freshnessPriority:t.freshness_priority,confidenceScore:Number(t.confidence_score),reasoning:"Database rule match"};const i=z(o.name,r);let s=i.recommendedService;return(r==null?void 0:r.defaultService)!=="auto"&&(s=r.defaultService),!(r!=null&&r.autoRouteFreshItems)&&i.freshnessPriority>=8&&(s="manual"),!(r!=null&&r.autoRoutePantryItems)&&i.freshnessPriority<=3&&(s="manual"),{...o,recommendedService:s,category:i.category,freshnessPriority:i.freshnessPriority,confidenceScore:.7,reasoning:"Auto-categorized"}}));return{instacartItems:n.filter(o=>o.recommendedService==="instacart"),amazonItems:n.filter(o=>o.recommendedService==="amazon"),amazonFreshItems:n.filter(o=>o.recommendedService==="amazon_fresh"),amazonGroceryItems:n.filter(o=>o.recommendedService==="amazon_grocery"),wholeFoodsItems:n.filter(o=>o.recommendedService==="whole_foods"),manualItems:n.filter(o=>o.recommendedService==="manual")}}async function S(e){const{data:a,error:r}=await l.from("user_delivery_preferences").select("*").eq("user_id",e).maybeSingle();return r?(console.error("Error fetching delivery preferences:",r),null):a?{id:a.id,userId:a.user_id,defaultService:a.default_service,deliveryAddress:a.delivery_address,deliveryInstructions:a.delivery_instructions,preferredDeliveryWindow:a.preferred_delivery_window,autoRouteFreshItems:a.auto_route_fresh_items,autoRoutePantryItems:a.auto_route_pantry_items,enableCostOptimization:a.enable_cost_optimization,preferredAmazonService:a.preferred_amazon_service,enableAmazonFresh:a.enable_amazon_fresh,enableAmazonGrocery:a.enable_amazon_grocery,enableWholeFoods:a.enable_whole_foods,userZipCode:a.user_zip_code}:null}async function R(e){const{error:a}=await l.from("user_delivery_preferences").upsert({user_id:e.userId,default_service:e.defaultService,delivery_address:e.deliveryAddress,delivery_instructions:e.deliveryInstructions||"",preferred_delivery_window:e.preferredDeliveryWindow||"",auto_route_fresh_items:e.autoRouteFreshItems,auto_route_pantry_items:e.autoRoutePantryItems,enable_cost_optimization:e.enableCostOptimization,preferred_amazon_service:e.preferredAmazonService||"auto",enable_amazon_fresh:e.enableAmazonFresh??!0,enable_amazon_grocery:e.enableAmazonGrocery??!0,enable_whole_foods:e.enableWholeFoods??!1,user_zip_code:e.userZipCode||"",updated_at:new Date().toISOString()});if(a)throw console.error("Error saving delivery preferences:",a),a}function A(e){return{fresh_produce:"ðŸ¥¬",meat:"ðŸ¥©",dairy:"ðŸ¥›",pantry:"ðŸº",frozen:"â„ï¸",other:"ðŸ“¦"}[e]||"ðŸ“¦"}function F(e){return{instacart:"Instacart",amazon:"Amazon",amazon_fresh:"Amazon Fresh",amazon_grocery:"Amazon Grocery",whole_foods:"Whole Foods",manual:"Choose Service"}[e]}const I="https://connect.instacart.com/idp/v1/products/products_link";async function _(){const{data:e,error:a}=await l.from("delivery_service_configs").select("*").eq("service_name","instacart").single();if(a||!e)throw new Error("Instacart configuration not found");return e}async function E(){try{return(await _()).is_active}catch{return!1}}function m(e,a){const r="https://www.instacart.com/store/search",n=e.map(t=>{const i=t.quantity>1?`${t.quantity} `:"",s=t.unit?` ${t.unit}`:"";return`${i}${t.name}${s}`}).join(", "),o=new URLSearchParams({q:n,ref:a||"mealscrape"});return`${r}?${o.toString()}`}async function O(e,a,r){try{const n=await _(),o=`${a}-${Date.now()}`;if(console.log("[Instacart] Creating shopping list with",e.length,"items"),!n.api_key||n.api_key.length<20){console.log("[Instacart] No valid API key, using storefront URL fallback");const c=m(e,n.affiliate_tag||"mealscrape");return await l.from("affiliate_conversions").insert({user_id:a,service_name:"instacart",conversion_type:"cart_created",tracking_id:o,status:"pending",metadata:{products_link_url:c,item_count:e.length,method:"storefront_fallback"}}),r&&await u(a,"instacart",e,r,o),{products_link_url:c}}const t={title:"My Shopping List from MealScrape",line_items:e.map(c=>({name:c.name,quantity:c.quantity,unit:c.unit||""})),landing_page_configuration:{partner_linkback_url:"https://mealscrapeapp.com"}};console.log("[Instacart] Using API with request body:",JSON.stringify(t,null,2));const i=await fetch(I,{method:"POST",headers:{Authorization:`Bearer ${n.api_key}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[Instacart] Response status:",i.status),!i.ok){const c=await i.text().catch(()=>"");console.error("[Instacart] API error:",i.status,c),console.log("[Instacart] Falling back to storefront URL");const d=m(e,n.affiliate_tag||"mealscrape");return await l.from("affiliate_conversions").insert({user_id:a,service_name:"instacart",conversion_type:"cart_created",tracking_id:o,status:"pending",metadata:{products_link_url:d,item_count:e.length,method:"storefront_fallback",api_error:c}}),r&&await u(a,"instacart",e,r,o),{products_link_url:d}}const s=await i.json();if(console.log("[Instacart] Response data:",s),!s.products_link_url)throw new Error("No products link URL returned from Instacart");return await l.from("affiliate_conversions").insert({user_id:a,service_name:"instacart",conversion_type:"cart_created",tracking_id:o,status:"pending",metadata:{products_link_url:s.products_link_url,item_count:e.length,method:"api"}}),r&&await u(a,"instacart",e,r,o),{products_link_url:k(s.products_link_url,o)}}catch(n){throw console.error("[Instacart] Error creating shopping list:",n),n}}function k(e,a){try{const r=new URL(e);return r.searchParams.set("utm_source","mealscrape"),r.searchParams.set("utm_medium","affiliate"),r.searchParams.set("tracking_id",a),r.toString()}catch{return e}}async function u(e,a,r,n,o){const{data:t,error:i}=await l.from("delivery_orders").insert({user_id:e,service_name:a,external_order_id:o,cart_snapshot:r,order_status:"pending",delivery_address:n}).select("id").single();if(i)throw console.error("Error saving delivery order:",i),i;return t.id}export{A as a,F as b,O as c,S as g,E as i,P as r,R as s};
