var me=Object.defineProperty;var ge=(e,t,r)=>t in e?me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var C=(e,t,r)=>ge(e,typeof t!="symbol"?t+"":t,r);import{s as c,M as X,E as h,N as D}from"./page-addrecipe-Pb6dTsbS.js";import{c as pe}from"./supabase-vendor-DpDh9Ika.js";import{u as fe}from"./vendor-Clj4czuh.js";import{p as he,n as ye,c as _e,a as re,g as we,b as ve}from"./page-grocerylist-9H8dAkfw.js";import{d as be}from"./page-blog-DTt-yulm.js";function ie(e){if(e.length===0)return{cuisinePreferences:{},dietaryPreferences:[],difficultyPreferences:{},avgCookTime:0,totalRecipesSaved:0};const t={},r=new Set,i={};let o=0;return e.forEach(s=>{t[s.cuisineType]=(t[s.cuisineType]||0)+1,i[s.difficulty]=(i[s.difficulty]||0)+1,s.dietaryTags.forEach(n=>r.add(n)),o+=s.prepTime+s.cookTime}),{cuisinePreferences:t,dietaryPreferences:Array.from(r),difficultyPreferences:i,avgCookTime:o/e.length,totalRecipesSaved:e.length}}function Ee(e,t,r,i){if(i.has(e.id))return-1e3;let o=0;const s=t.cuisinePreferences[e.cuisineType]||0;o+=s*10,r.favoriteCuisines.includes(e.cuisineType)&&(o+=15);let a=0;e.dietaryTags.forEach(f=>{t.dietaryPreferences.includes(f)&&a++,r.dietaryPreferences.includes(f)&&a++}),o+=a*8;const u=t.difficultyPreferences[e.difficulty]||0;o+=u*5;const d={Beginner:"Easy",Intermediate:"Medium",Advanced:"Hard"}[r.cookingSkillLevel];if(e.difficulty===d?o+=10:(r.cookingSkillLevel==="Intermediate"&&e.difficulty==="Easy"||r.cookingSkillLevel==="Advanced"&&e.difficulty==="Medium")&&(o+=5),t.avgCookTime>0){const f=e.prepTime+e.cookTime,I=Math.abs(f-t.avgCookTime),y=Math.max(0,10-I/10);o+=y}e.ingredients.some(f=>r.dislikedIngredients.some(I=>f.name.toLowerCase().includes(I.toLowerCase())))&&(o-=50),e.popularity&&(o+=e.popularity*.5);const v=Math.random()*5;return o+=v,o}function ht(e,t,r,i=6){const o=ie(t),s=new Set(t.map(a=>a.id));return t.length===0?e.filter(a=>!s.has(a.id)).sort((a,u)=>(u.popularity||0)-(a.popularity||0)).slice(0,i):e.map(a=>({recipe:a,score:Ee(a,o,r,s)})).filter(a=>a.score>=0).sort((a,u)=>u.score-a.score).slice(0,i).map(a=>a.recipe)}function yt(e){if(e.length===0)return"Popular recipes to get you started";const t=ie(e),r=Object.entries(t.cuisinePreferences).sort((o,s)=>s[1]-o[1])[0],i=[];return r&&i.push(r[0]),t.dietaryPreferences.length>0&&i.push(t.dietaryPreferences[0]),i.length>0?`Based on your love for ${i.join(" and ")} recipes`:"Personalized recommendations based on your saved recipes"}async function _t(){}async function wt(){}function j(e){return{id:e.id,userId:e.user_id,title:e.title,ingredients:e.ingredients,instructions:e.instructions,prepTime:e.prep_time,cookTime:e.cook_time,servings:e.servings,tags:e.tags||[],cuisineType:e.cuisine_type,difficulty:e.difficulty,dietaryTags:e.dietary_tags||[],mealType:e.meal_type||[],imageUrl:e.image_url,videoUrl:e.video_url,sourceUrl:e.source_url,notes:e.notes,isSaved:!1}}function se(e){return{user_id:e.userId,title:e.title,ingredients:e.ingredients,instructions:e.instructions,prep_time:e.prepTime,cook_time:e.cookTime,servings:e.servings,tags:e.tags||[],cuisine_type:e.cuisineType,difficulty:e.difficulty,dietary_tags:e.dietaryTags||[],meal_type:e.mealType||[],image_url:e.imageUrl,video_url:e.videoUrl,source_url:e.sourceUrl,notes:e.notes,is_public:!0}}async function ke(e){const{data:t,error:r}=await c.from("saved_recipes").select("id, recipe_id, recipe_data").eq("user_id",e).order("created_at",{ascending:!1});if(r)throw console.error("Error fetching saved recipes:",r),new Error("Failed to fetch saved recipes");const i=(t||[]).map(o=>({...o.recipe_data,isSaved:!0}));for(const o of t||[]){const s=o.recipe_data;s!=null&&s.imageUrl&&O(s.imageUrl)&&(console.log("[getSavedRecipes] Detected external image URL, migrating in background..."),Z(o.id,o.recipe_id||s.id,s.imageUrl))}return i}async function Se(e,t){try{const{data:{session:r},error:i}=await c.auth.getSession();if(!r||i)throw console.error("[saveRecipeToCloud] Session validation failed:",i),new Error("Your session has expired. Please log in again.");if(r.user.id!==e)throw console.error("[saveRecipeToCloud] User ID mismatch:",{sessionId:r.user.id,paramId:e}),new Error("User authentication mismatch. Please log in again.");console.log("[saveRecipeToCloud] Session validated successfully for user:",e);const o=await c.from("saved_recipes").select("id").eq("user_id",e).eq("recipe_id",t.id).maybeSingle();if(o.data){const{error:s}=await c.from("saved_recipes").update({recipe_data:{...t,isSaved:!0},updated_at:new Date().toISOString()}).eq("id",o.data.id);if(s)throw console.error("Error updating recipe:",s),new Error("Failed to update recipe");t.imageUrl&&O(t.imageUrl)&&(console.log("[saveRecipeToCloud] Detected external image URL, migrating in background..."),Z(o.data.id,t.id,t.imageUrl))}else{const{data:s,error:n}=await c.from("saved_recipes").insert({user_id:e,recipe_id:t.id,recipe_data:{...t,isSaved:!0}}).select("id").single();if(n)throw console.error("Error saving recipe:",n),new Error("Failed to save recipe");s&&t.imageUrl&&O(t.imageUrl)&&(console.log("[saveRecipeToCloud] Detected external image URL, migrating in background..."),Z(s.id,t.id,t.imageUrl))}}catch(r){throw console.error("Error in saveRecipeToCloud:",r),new Error(r.message||"Failed to save recipe")}}async function Te(e,t){const{data:{session:r},error:i}=await c.auth.getSession();if(!r||i)throw console.error("[removeRecipeFromCloud] Session validation failed:",i),new Error("Your session has expired. Please log in again.");if(r.user.id!==e)throw console.error("[removeRecipeFromCloud] User ID mismatch:",{sessionId:r.user.id,paramId:e}),new Error("User authentication mismatch. Please log in again.");console.log("[removeRecipeFromCloud] Session validated successfully for user:",e);const{error:o}=await c.from("saved_recipes").delete().eq("user_id",e).eq("recipe_id",t);if(o)throw console.error("Error removing recipe:",o),new Error("Failed to remove recipe")}async function Ie(e){let t=se(e);console.log("[createRecipe] Attempting to insert:",t);const{data:r,error:i}=await c.from("public_recipes").insert(t).select().single();if(i)throw console.error("Error creating recipe:",i),console.error("Error details:",{message:i.message,details:i.details,hint:i.hint,code:i.code}),console.error("Supabase request failed",i),new Error(i.message||"Failed to create recipe");const o=j(r);return o.imageUrl&&O(o.imageUrl)&&(console.log("[createRecipe] Detected external image URL, storing in Supabase..."),ae(o.id,o.imageUrl)),o}function O(e){return e?!e.includes("https://vohvdarghgqskzqjclux.supabase.co")&&(e.includes("instagram.com")||e.includes("cdninstagram.com")||e.includes("fbcdn.net")||e.includes("http://")||e.includes("https://")):!1}async function Z(e,t,r){try{console.log("[migrateSavedRecipeImage] Starting migration for saved recipe:",e);const i=await X(r,t);if(i!==r){const{data:o}=await c.from("saved_recipes").select("recipe_data").eq("id",e).single();if(o){const s={...o.recipe_data,imageUrl:i};await c.from("saved_recipes").update({recipe_data:s,updated_at:new Date().toISOString()}).eq("id",e),console.log("[migrateSavedRecipeImage] ‚úÖ Successfully migrated saved recipe image")}}}catch(i){console.error("[migrateSavedRecipeImage] Failed to migrate:",i)}}async function ae(e,t){try{console.log("[migrateRecipeImage] Starting migration for recipe:",e);const r=await X(t,e);if(r!==t){const{error:i}=await c.from("public_recipes").update({image_url:r}).eq("id",e);i?console.error("[migrateRecipeImage] Failed to update recipe:",i):console.log("[migrateRecipeImage] ‚úÖ Successfully migrated image for recipe:",e)}}catch(r){console.error("[migrateRecipeImage] Error migrating image:",r)}}async function Pe(){const{data:e,error:t}=await c.from("public_recipes").select("*").eq("is_public",!0).order("created_at",{ascending:!1});if(t)throw console.error("Error fetching recipes:",t),new Error("Failed to fetch recipes");const r=(e||[]).map(j);return xe(r),r}async function xe(e){const t=e.filter(r=>r.imageUrl&&O(r.imageUrl));if(t.length>0){console.log(`[Migration] Found ${t.length} recipes with external images to migrate`);for(const r of t.slice(0,5))ae(r.id,r.imageUrl),await new Promise(i=>setTimeout(i,1e3))}}async function Re(e){const{data:t,error:r}=await c.from("public_recipes").select("*").eq("id",e).maybeSingle();return r?(console.error("Error fetching recipe:",r),null):t?j(t):null}async function Ue(e,t){const r=se(t),{data:i,error:o}=await c.from("public_recipes").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().maybeSingle();if(o)throw console.error("Error updating recipe:",o),new Error("Failed to update recipe");if(!i)throw new Error("Recipe not found or you do not have permission to update it");return j(i)}async function qe(e){if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e))throw new Error("Cannot delete mock recipes - only database recipes can be deleted");const{error:r}=await c.from("public_recipes").delete().eq("id",e);if(r)throw console.error("Error deleting recipe:",r),new Error("Failed to delete recipe")}const vt=Object.freeze(Object.defineProperty({__proto__:null,createRecipe:Ie,deleteRecipe:qe,getAllPublicRecipes:Pe,getRecipeById:Re,getSavedRecipes:ke,removeRecipeFromCloud:Te,saveRecipeToCloud:Se,updateRecipe:Ue},Symbol.toStringTag,{value:"Module"}));class ze{constructor(){C(this,"isRunning",!1);C(this,"checkInterval",6e4);C(this,"maxPerBatch",10)}startMonitoring(){if(this.isRunning){console.log("[ImageMonitor] Already running");return}this.isRunning=!0,console.log("[ImageMonitor] Started monitoring for external images"),this.checkAndMigrateImages(),setInterval(()=>{this.checkAndMigrateImages()},this.checkInterval)}stopMonitoring(){this.isRunning=!1,console.log("[ImageMonitor] Stopped monitoring")}async checkAndMigrateImages(){try{const t=await this.getRecipesWithExternalImages();if(t.length===0){console.log("[ImageMonitor] ‚úÖ No recipes need migration");return}console.log(`[ImageMonitor] Found ${t.length} recipes with external images`);const r=t.slice(0,this.maxPerBatch);for(const i of r)await this.migrateRecipeImage(i.id,i.image_url),await new Promise(o=>setTimeout(o,2e3));console.log(`[ImageMonitor] ‚úÖ Migrated ${r.length} recipe images`)}catch(t){console.error("[ImageMonitor] Error during migration:",t)}}async getRecipesWithExternalImages(){const t="https://vohvdarghgqskzqjclux.supabase.co",{data:r,error:i}=await c.from("public_recipes").select("id, image_url").not("image_url","is",null).limit(50);return i?(console.error("[ImageMonitor] Error fetching recipes:",i),[]):(r||[]).filter(o=>o.image_url?!o.image_url.includes(t)&&(o.image_url.includes("instagram.com")||o.image_url.includes("cdninstagram.com")||o.image_url.includes("fbcdn.net")||o.image_url.startsWith("http://")||o.image_url.startsWith("https://")):!1)}async migrateRecipeImage(t,r){try{console.log(`[ImageMonitor] Migrating recipe ${t}...`);const i=await X(r,t);if(i!==r){const{error:o}=await c.from("public_recipes").update({image_url:i}).eq("id",t);o?console.error(`[ImageMonitor] Failed to update recipe ${t}:`,o):console.log(`[ImageMonitor] ‚úÖ Successfully migrated recipe ${t}`)}else console.warn(`[ImageMonitor] ‚ö†Ô∏è Migration failed for recipe ${t}`)}catch(i){console.error(`[ImageMonitor] Error migrating recipe ${t}:`,i)}}async manualCheckRecipe(t){try{const{data:r,error:i}=await c.from("public_recipes").select("image_url").eq("id",t).maybeSingle();return i||!(r!=null&&r.image_url)||r.image_url.includes("https://vohvdarghgqskzqjclux.supabase.co")?!1:(await this.migrateRecipeImage(t,r.image_url),!0)}catch(r){return console.error("[ImageMonitor] Error checking recipe:",r),!1}}}const bt=new ze,Ae="https://vohvdarghgqskzqjclux.supabase.co",Me="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvaHZkYXJnaGdxc2t6cWpjbHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4ODgwMDcsImV4cCI6MjA3ODQ2NDAwN30.6povbtgWFLTvq6lxVrqii_-PrOiLZrUo1n-BMlpK4gc",k=pe(Ae,Me);async function Et(e){if(!k)return[];const{data:t,error:r}=await k.from("reviews").select("*").eq("recipe_id",e).order("created_at",{ascending:!1});if(r)throw r;return await Promise.all((t||[]).map(async o=>{const{data:s}=await k.from("review_images").select("id, image_url").eq("review_id",o.id);return{...o,images:s||[]}}))}async function kt(e,t){if(!k)return null;const{data:r,error:i}=await k.from("reviews").select("*").eq("recipe_id",e).eq("user_id",t).maybeSingle();if(i)throw i;if(!r)return null;const{data:o}=await k.from("review_images").select("id, image_url").eq("review_id",r.id);return{...r,images:o||[]}}async function ne(e){if(!k)throw new Error("Supabase not configured");const r=`reviews/${`${Date.now()}-${Math.random().toString(36).substr(2,9)}-${e.name}`}`,{error:i}=await k.storage.from("recipe-images").upload(r,e);if(i)throw i;const{data:o}=k.storage.from("recipe-images").getPublicUrl(r);return o.publicUrl}async function St(e,t,r,i){if(!k)throw new Error("Supabase not configured");const{data:{user:o}}=await k.auth.getUser();if(!o)throw new Error("User not authenticated");const{data:s,error:n}=await k.from("reviews").insert({recipe_id:e,user_id:o.id,rating:t,comment:r}).select().single();if(n)throw n;if(i.length>0){const a=await Promise.all(i.map(ne)),{error:u}=await k.from("review_images").insert(a.map(l=>({review_id:s.id,image_url:l})));if(u)throw u}try{const{data:a}=await k.from("posts").select("id").eq("recipe_id",e);if(a&&a.length>0){const u=a[0].id,l="üî•".repeat(t),d=r?` ${r}`:"";await k.from("comments").insert({post_id:u,user_id:o.id,text:`${l}${d}`,rating:t})}}catch(a){console.error("Failed to add review as comment to social post:",a)}return s}async function Tt(e,t,r,i){if(!k)throw new Error("Supabase not configured");const{error:o}=await k.from("reviews").update({rating:t,comment:r,updated_at:new Date().toISOString()}).eq("id",e);if(o)throw o;if(i.length>0){const s=await Promise.all(i.map(ne)),{error:n}=await k.from("review_images").insert(s.map(a=>({review_id:e,image_url:a})));if(n)throw n}return{id:e,rating:t,comment:r}}async function It(e){if(!k)return 0;const{data:t,error:r}=await k.from("reviews").select("rating").eq("recipe_id",e);if(r)throw r;if(!t||t.length===0)return 0;const i=t.reduce((o,s)=>o+s.rating,0)/t.length;return Math.round(i*10)/10}const Pt={async getBlockedUserIds(e){try{const{data:t,error:r}=await c.from("blocked_users").select("blocked_id").eq("blocker_id",e);if(r)throw r;return(t==null?void 0:t.map(i=>i.blocked_id))||[]}catch(t){return console.error("Error fetching blocked users:",t),[]}},async getUsersWhoBlockedMe(e){try{const{data:t,error:r}=await c.from("blocked_users").select("blocker_id").eq("blocked_id",e);if(r)throw r;return(t==null?void 0:t.map(i=>i.blocker_id))||[]}catch(t){return console.error("Error fetching users who blocked me:",t),[]}},async isUserBlocked(e,t){try{const{data:r,error:i}=await c.from("blocked_users").select("id").eq("blocker_id",e).eq("blocked_id",t).maybeSingle();if(i)throw i;return!!r}catch(r){return console.error("Error checking if user is blocked:",r),!1}},async amIBlockedBy(e,t){try{const{data:r,error:i}=await c.from("blocked_users").select("id").eq("blocker_id",t).eq("blocked_id",e).maybeSingle();if(i)throw i;return!!r}catch(r){return console.error("Error checking if blocked by user:",r),!1}},filterBlockedUsers(e,t,r){return e.filter(i=>{const o=i.user_id||i.id;return o?!t.includes(o)&&!r.includes(o):!0})}};function Ce(e){const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const r of t){const i=e.match(r);if(i)return i[1]}return null}async function De(e){const r=await fetch("https://recipe-backend-nodejs-1.onrender.com/youtube-metadata",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:e})});if(!r.ok){const o=await r.text();throw console.error("[YouTube Service] Failed to fetch metadata:",o),new Error(`YouTube API error: ${r.status}`)}const i=await r.json();return{title:i.title,description:i.description,thumbnail:i.thumbnail,channelTitle:i.channelTitle}}function $e(e){const t=["ingredients","instructions","directions","recipe","cups","tablespoon","teaspoon","serves","prep time","cook time","method","step 1","step 2"],r=e.toLowerCase();return t.filter(o=>r.includes(o)).length>=3}async function Oe(e){const t="https://recipe-backend-nodejs-1.onrender.com";console.log("[YouTube Service] Extracting recipe from description...");const r=await fetch(`${t}/extract-from-description`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok){const o=await r.text();throw console.error("[YouTube Service] Description extraction failed:",r.status,o),r.status===404?new Error("Backend server needs update. Please redeploy the server to Render with the latest code."):new Error("Failed to extract recipe from description")}const i=await r.json();return console.log("[YouTube Service] ‚úÖ Recipe extracted from description:",i.title),i}class Fe{constructor(){C(this,"attempts",[]);C(this,"MAX_HISTORY",100)}logAttempt(t){const r={...t,timestamp:Date.now()};this.attempts.push(r),this.attempts.length>this.MAX_HISTORY&&(this.attempts=this.attempts.slice(-this.MAX_HISTORY))}getStats(){const t=Date.now(),r=this.attempts.filter(l=>t-l.timestamp<24*60*60*1e3),i=this.attempts.filter(l=>t-l.timestamp<60*60*1e3),o=r.length>0?r.filter(l=>l.success).length/r.length*100:0,s=i.length>0?i.filter(l=>l.success).length/i.length*100:0,n=r.reduce((l,d)=>(l[d.platform]||(l[d.platform]={total:0,success:0}),l[d.platform].total++,d.success&&l[d.platform].success++,l),{}),a=r.reduce((l,d)=>(l[d.method]||(l[d.method]={total:0,success:0}),l[d.method].total++,d.success&&l[d.method].success++,l),{}),u=r.filter(l=>!l.success&&l.error).reduce((l,d)=>{const m=d.error||"Unknown";return l[m]=(l[m]||0)+1,l},{});return{total24h:r.length,totalHour:i.length,successRate24h:Math.round(o),successRateHour:Math.round(s),byPlatform:n,byMethod:a,commonErrors:u,recentAttempts:this.attempts.slice(-10)}}getRecommendation(t){const i=this.getStats().byPlatform[t];if(!i||i.total<3)return"Not enough data to provide recommendations";const o=i.success/i.total*100;return o>80?"‚úÖ Extraction working well for this platform":o>50?"‚ö†Ô∏è Moderate success rate. Consider using manual description paste if extraction fails.":"‚ùå Low success rate. We recommend using the manual description paste method for this platform."}clear(){this.attempts=[]}}const oe=new Fe;async function H(e,t,r,i){const o=Date.now();try{const s=await i(),n=Date.now()-o;return oe.logAttempt({url:e,platform:t,method:r,success:!0,duration:n}),s}catch(s){const n=Date.now()-o;throw oe.logAttempt({url:e,platform:t,method:r,success:!1,error:s.message||"Unknown error",duration:n}),s}}const F="https://vohvdarghgqskzqjclux.supabase.co",Y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvaHZkYXJnaGdxc2t6cWpjbHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4ODgwMDcsImV4cCI6MjA3ODQ2NDAwN30.6povbtgWFLTvq6lxVrqii_-PrOiLZrUo1n-BMlpK4gc",Ne=`${F}/functions/v1/recipe-proxy`,ce="https://recipe-backend-nodejs-1.onrender.com/extract",Be=`${F}/functions/v1/extract-recipe-photo`,We=`${F}/functions/v1/extract-recipe-text`;async function xt(e){var u,l,d,m,v,f,I,y,g,x;if(!e.trim()||!Le(e))throw new Error("Please enter a valid URL");const t=Ce(e);if(t){console.log("[Extractor] YouTube video detected:",t);try{return await Ye(e,t)}catch(P){console.error("[Extractor] YouTube hybrid extraction failed:",P)}}if(/tiktok\.com|instagram\.com|youtube\.com|youtu\.be/i.test(e)){let R=null;for(let S=0;S<3;S++)try{if(S>0){const b=Math.min(1e3*Math.pow(2,S),3e4);console.log(`[Extractor] Retry attempt ${S+1}/3, waiting ${b}ms...`),fe.info(`Server busy, retrying in ${Math.ceil(b/1e3)} seconds...`),await new Promise(_=>setTimeout(_,b))}console.log("[Extractor] Sending to Render server:",e);const U=new AbortController,N=setTimeout(()=>U.abort(),9e4),z=await fetch(ce,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e.trim()}),signal:U.signal});if(clearTimeout(N),!z.ok){if(console.error("[Extractor] Server response not OK:",z.status),z.status===429&&S<2){R=new Error("Rate limit exceeded, retrying...");continue}if(z.status>=500&&S<2){R=new Error("Server error, retrying...");continue}if(z.status>=500||z.status===429)throw new Error('Server is busy or waking up. Please wait 30 seconds and try again, or use the "Paste Description" option to manually enter the recipe text.');const b=await z.text();throw console.error("[Extractor] Error response:",b),new Error("Video extraction failed")}const p=await z.json();console.log("[Extractor] Raw data from server:",p),console.log("[Extractor] Server description field:",p.description||"NONE"),console.log("[Extractor] Server content field:",p.content||"NONE");const A=p.thumbnail||p.image||"";console.log("[Extractor] Raw image URL:",A);let T=A;if(A)if(A.includes("cdninstagram.com")||A.includes("fbcdn.net")||A.includes("instagram.com")){const _=A.replace(/&amp;/g,"&");T=`${F}/functions/v1/image-proxy?url=${encodeURIComponent(_)}`,console.log("[Extractor] Instagram image detected, proxying:",T)}else console.log("[Extractor] Direct image URL (no proxy needed):",T);const w=Array.isArray(p.ingredients)?p.ingredients:[];console.log("[Extractor] Processing ingredients:",w);const G=w.map(b=>{const _=h(b.trim());if(!_)return{quantity:"",unit:"",name:""};const $=_.match(/^([\d¬º¬Ω¬æ‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû\/\.\-\s\,]+)\s*/),ee=$?$[1].trim():"",te=D(ee);let L=_.slice(ee.length).trim();const J=L.match(/^(cups?|tbsps?|tablespoons?|tsps?|teaspoons?|oz|ounces?|lbs?|pounds?|grams?|g|kg|kilograms?|ml|milliliters?|l|liters?|pinch|dash|piece|pieces|clove|cloves|slice|slices|can|cans)\s+/i);let q="";if(J){const E=J[1].toLowerCase();L=L.slice(J[0].length).trim(),E==="g"||E==="gram"||E==="grams"?q="g":E==="kg"||E==="kilogram"||E==="kilograms"?q="kg":E==="ml"||E==="milliliter"||E==="milliliters"?q="ml":E==="l"||E==="liter"||E==="liters"?q="l":E.startsWith("cup")?q="cup":E.startsWith("tbsp")||E.startsWith("tablespoon")?q="tbsp":E.startsWith("tsp")||E.startsWith("teaspoon")?q="tsp":E==="oz"||E.startsWith("ounce")?q="oz":E.startsWith("lb")||E.startsWith("pound")?q="lb":q=E}else q=te?"piece":"";return{quantity:te,unit:q,name:L||_}}),B=b=>{if(!b||b<=0)return"30 mins";if(b<60)return`${b} mins`;const _=Math.floor(b/60),$=b%60;return $?`${_} hr ${$} mins`:`${_} hr`};console.log("[Extractor] Final image URL being returned:",T);const W=Array.isArray(p.instructions)?p.instructions:[];console.log("[Extractor] Processing instructions:",W);const M=h(p.description||p.shortDescription||p.content||"");if(console.log("[Extractor] Description:",M?`"${M.substring(0,100)}..."`:"EMPTY"),console.log("[Extractor] Ingredients count:",G.length),console.log("[Extractor] Instructions count:",W.length),G.length===0&&W.length===0&&M){console.log("[Extractor] ‚ö° Triggering AI extraction from description...");try{const b=await fetch(We,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Y}`},body:JSON.stringify({text:M})});if(b.ok){const _=await b.json();if(console.log("[Extractor] AI extraction successful:",_),_.ingredients&&_.ingredients.length>0)return{title:h(p.title||p.channel||_.title||"Video Recipe"),description:_.description||M,creator:h(p.channel||p.creator||"Unknown"),ingredients:_.ingredients,instructions:_.instructions||[],prepTime:_.prepTime||B(p.prep_time||15),cookTime:_.cookTime||B(p.cook_time||35),servings:_.servings||p.servings||p.yield||"4",cuisineType:_.cuisineType||"Global",difficulty:_.difficulty||"Medium",mealTypes:_.mealTypes||["Dinner"],dietaryTags:_.dietaryTags||[],imageUrl:T,videoUrl:e,notes:"Recipe extracted from description",sourceUrl:e}}}catch(b){console.error("[Extractor] AI extraction failed:",b)}}return{title:h(p.title||p.channel||"Video Recipe"),description:M,creator:h(p.channel||p.creator||"Unknown"),ingredients:G,instructions:W.map(b=>h(b)),prepTime:B(p.prep_time||15),cookTime:B(p.cook_time||35),servings:p.servings||p.yield||"4",cuisineType:"Global",difficulty:"Medium",mealTypes:["Dinner"],dietaryTags:[],imageUrl:T,videoUrl:e,notes:`Recipe from ${p.channel||p.creator||"video"}`,sourceUrl:e}}catch(U){if(console.error("[Extractor] Attempt error:",U),R=U,U.name==="AbortError"&&S<2)continue;if(U.name==="AbortError")throw new Error('Server is waking up ‚Äî please wait 30 seconds and try again, or use the "Paste Description" option to manually enter the recipe text.');if(S===2)throw U}throw R||new Error("Video extraction temporarily unavailable ‚Äî try again soon")}const i=await fetch(Ne,{method:"POST",headers:{"Content-Type":"application/json",apikey:Y,Authorization:`Bearer ${Y}`},body:JSON.stringify({url:e.trim()})});if(!i.ok)throw await i.text(),new Error("Failed to extract from website");const o=await i.json(),s=P=>P.map(R=>{const S=h(R.trim()),U=S.match(/^([\d¬º¬Ω¬æ‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû\/\.\-\s\,]+)\s*/),N=U?U[1].trim():"",z=D(N);let p=S.slice(N.length).trim();const A=p.match(/^(cups?|tbsps?|tablespoons?|tsps?|teaspoons?|oz|ounces?|lbs?|pounds?|grams?|g|kg|kilograms?|ml|milliliters?|l|liters?|pinch|dash|piece|pieces|clove|cloves|slice|slices|can|cans)\s+/i);let T="";if(A){const w=A[1].toLowerCase();p=p.slice(A[0].length).trim(),w==="g"||w==="gram"||w==="grams"?T="g":w==="kg"||w==="kilogram"||w==="kilograms"?T="kg":w==="ml"||w==="milliliter"||w==="milliliters"?T="ml":w==="l"||w==="liter"||w==="liters"?T="l":w.startsWith("cup")?T="cup":w.startsWith("tbsp")||w.startsWith("tablespoon")?T="tbsp":w.startsWith("tsp")||w.startsWith("teaspoon")?T="tsp":w==="oz"||w.startsWith("ounce")?T="oz":w.startsWith("lb")||w.startsWith("pound")?T="lb":T=w}else T=z?"piece":"";return{quantity:z,unit:T,name:p||S}}),n=s(o.ingredients||[]),a={title:h(o.title||"Untitled Recipe"),description:"Extracted recipe",creator:h(o.author||"Unknown"),ingredients:n,instructions:(o.instructions||[]).map(h),prepTime:o.prep_time?`${o.prep_time} mins`:"30 mins",cookTime:o.cook_time?`${o.cook_time} mins`:"45 mins",servings:String(o.yield||"4"),cuisineType:"Global",difficulty:"Medium",mealTypes:["Dinner"],dietaryTags:[],imageUrl:o.image||"",videoUrl:"",notes:o.notes||"",sourceUrl:e};if(o.hasConflict&&o.structuredVersion){const P=s(((u=o.structuredVersion)==null?void 0:u.ingredients)||[]),R=(((l=o.structuredVersion)==null?void 0:l.instructions)||[]).map(h);if(P.length>0&&R.length>0)a.ingredients=P,a.instructions=R,a.prepTime=(d=o.structuredVersion)!=null&&d.prep_time?`${o.structuredVersion.prep_time} mins`:a.prepTime,a.cookTime=(m=o.structuredVersion)!=null&&m.cook_time?`${o.structuredVersion.cook_time} mins`:a.cookTime,a.servings=String(((v=o.structuredVersion)==null?void 0:v.yield)||a.servings);else if(o.aiVersion){const S=s(((f=o.aiVersion)==null?void 0:f.ingredients)||[]),U=(((I=o.aiVersion)==null?void 0:I.instructions)||[]).map(h);S.length>0&&U.length>0&&(a.ingredients=S,a.instructions=U,a.prepTime=(y=o.aiVersion)!=null&&y.prep_time?`${o.aiVersion.prep_time} mins`:a.prepTime,a.cookTime=(g=o.aiVersion)!=null&&g.cook_time?`${o.aiVersion.cook_time} mins`:a.cookTime,a.servings=String(((x=o.aiVersion)==null?void 0:x.yield)||a.servings))}}return a}function Le(e){try{return new URL(e),!0}catch{return!1}}async function Ye(e,t){var r,i;try{console.log("[Extractor] Attempting YouTube description extraction...");const o=await H(e,"YouTube","metadata",()=>De(t)),s=$e(o.description);console.log(`[Extractor] Recipe keywords found: ${s}`);try{console.log("[Extractor] Attempting AI-powered description extraction...");const n=await H(e,"YouTube","description",()=>Oe({title:o.title,description:o.description,thumbnail:o.thumbnail,channelTitle:o.channelTitle}));if(n&&n.ingredients&&n.ingredients.length>0&&n.instructions&&n.instructions.length>0)return console.log("[Extractor] ‚úÖ Recipe successfully extracted from description!"),je(n,e,o);console.log("[Extractor] Description extraction returned incomplete data, trying audio...")}catch(n){console.log("[Extractor] Description extraction failed:",n.message)}return console.log("[Extractor] Falling back to audio transcription..."),await H(e,"YouTube","audio",()=>Ve(e))}catch(o){throw console.error("[Extractor] YouTube hybrid extraction error:",o),(r=o.message)!=null&&r.includes("404")||(i=o.message)!=null&&i.includes("YouTube API error")?(console.log("[Extractor] YouTube metadata endpoint not available. Backend needs deployment."),new Error("YouTube extraction temporarily unavailable. Please copy and paste the video description from YouTube into the recipe form manually, or wait for the server to update.")):o}}async function Ve(e){var i,o,s;console.log("[Extractor] Sending to Render server for audio extraction:",e);const t=new AbortController,r=setTimeout(()=>t.abort(),9e4);try{const n=await fetch(ce,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e.trim()}),signal:t.signal});if(clearTimeout(r),!n.ok){console.error("[Extractor] Server response not OK:",n.status);const m=await n.text();if(console.error("[Extractor] Error response:",m),n.status===403){if(m.includes("bot detection")||m.includes("Sign in to confirm")||m.includes("not a bot"))throw new Error(`ü§ñ YouTube detected automated access. Try these alternatives:

1. Wait 5 minutes and retry
2. Copy the video description from YouTube and paste it in the manual entry form
3. Try a different YouTube video`);if(m.includes("Age-restricted"))throw new Error("‚ùå This video is age-restricted and cannot be extracted automatically. Please copy the recipe from the video description.")}throw n.status===404?new Error("‚ùå Video not found or is private. Please check the URL and try again."):n.status>=500||n.status===429?new Error("‚è≥ Server is waking up or busy. Please wait 20-30 seconds and try again."):new Error("Video extraction failed. Please try the manual description paste method.")}const a=await n.json();console.log("[Extractor] Raw data from server:",a);const u=a.thumbnail||a.image||"";let l=u;if(u&&(u.includes("cdninstagram.com")||u.includes("fbcdn.net")||u.includes("instagram.com"))){const v=u.replace(/&amp;/g,"&");l=`${F}/functions/v1/image-proxy?url=${encodeURIComponent(v)}`}const d=(a.ingredients||[]).map(m=>{const v=h(m.trim());if(!v)return{quantity:"",unit:"",name:""};const f=v.match(/^([\d¬º¬Ω¬æ‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû\/\.\-\s\,]+)\s*/),I=f?f[1].trim():"",y=D(I);let g=v.slice(I.length).trim();const x=g.match(/^(cups?|tbsps?|tablespoons?|tsps?|teaspoons?|oz|ounces?|lbs?|pounds?|grams?|g|kg|kilograms?|ml|milliliters?|l|liters?|pinch|dash|piece|pieces|clove|cloves|slice|slices|can|cans)\s+/i);let P="";if(x){const R=x[1].toLowerCase();g=g.slice(x[0].length).trim(),P={cups:"cup",cup:"cup",tablespoons:"tbsp",tablespoon:"tbsp",tbsp:"tbsp",tbsps:"tbsp",teaspoons:"tsp",teaspoon:"tsp",tsp:"tsp",tsps:"tsp",ounces:"oz",ounce:"oz",oz:"oz",pounds:"lb",pound:"lb",lbs:"lb",lb:"lb",grams:"g",gram:"g",g:"g",kilograms:"kg",kilogram:"kg",kg:"kg",milliliters:"ml",milliliter:"ml",ml:"ml",liters:"l",liter:"l",l:"l"}[R]||R}return{quantity:y,unit:P,name:g}});return{title:h(a.title||a.channel||"Video Recipe"),description:h(a.description||a.shortDescription||a.content||""),creator:h(a.channel||a.creator||"Unknown"),ingredients:d,instructions:(a.instructions||[]).map(m=>h(m)),prepTime:V(a.prep_time||15),cookTime:V(a.cook_time||35),servings:a.servings||a.yield||"4",cuisineType:"Global",difficulty:"Medium",mealTypes:["Dinner"],dietaryTags:[],imageUrl:l,videoUrl:e,notes:`Recipe from ${a.channel||a.creator||"video"}`,sourceUrl:e}}catch(n){throw clearTimeout(r),console.error("[Extractor] Render server error:",n),n.name==="AbortError"?new Error("‚è≥ Request timed out. The server may be busy or the video may be too long. Please try again or use the manual description paste method."):(i=n.message)!=null&&i.includes("ü§ñ")||(o=n.message)!=null&&o.includes("‚ùå")||(s=n.message)!=null&&s.includes("‚è≥")?n:new Error(`Extraction failed: ${n.message||"Unknown error"}. Try pasting the video description manually.`)}}function je(e,t,r){const i=(e.ingredients||[]).map(o=>{if(typeof o=="string"){const s=h(o.trim()),n=s.match(/^([\d¬º¬Ω¬æ‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû\/\.\-\s\,]+)\s*/),a=n?n[1].trim():"",u=D(a);let l=s.slice(a.length).trim();const d=l.match(/^(cups?|tbsps?|tablespoons?|tsps?|teaspoons?|oz|ounces?|lbs?|pounds?|grams?|g|kg|ml|l|pinch|dash|piece|pieces|clove|cloves|slice|slices|can|cans)\s+/i);let m="";return d&&(m=d[1].toLowerCase(),l=l.slice(d[0].length).trim()),{quantity:u,unit:m,name:l}}return{quantity:D(o.quantity||""),unit:o.unit||"",name:h(o.name||"")}});return{title:h(e.title||r.title||"YouTube Recipe"),description:h(e.description||""),creator:h(e.creator||r.channelTitle||"Unknown"),ingredients:i,instructions:(e.instructions||[]).map(o=>h(o)),prepTime:V(e.prepTime||e.prep_time||15),cookTime:V(e.cookTime||e.cook_time||30),servings:String(e.servings||4),cuisineType:e.cuisineType||e.cuisine||"Global",difficulty:e.difficulty||"Medium",mealTypes:e.mealTypes||["Dinner"],dietaryTags:e.dietaryTags||e.tags||[],imageUrl:e.imageUrl||r.thumbnail||"",videoUrl:t,notes:e.notes||`Recipe from ${r.channelTitle||"YouTube"}`,sourceUrl:t}}function V(e){const t=typeof e=="string"?parseInt(e):e;return isNaN(t)?"30 mins":`${t} mins`}async function Rt(e){try{if(!e||e.length===0)throw new Error("Please select at least one photo");if(e.length>4)throw new Error("Maximum 4 photos allowed");console.log(`[Photo Extractor] Processing ${e.length} image(s)`);const t=async u=>new Promise((l,d)=>{const m=new FileReader;m.onload=v=>{var I;const f=new Image;f.onload=()=>{const y=document.createElement("canvas");let g=f.width,x=f.height;const P=2e3;g>x&&g>P?(x=x*P/g,g=P):x>P&&(g=g*P/x,x=P),y.width=g,y.height=x;const R=y.getContext("2d");if(!R){d(new Error("Failed to get canvas context"));return}R.drawImage(f,0,0,g,x);const S=u.size>1e6?.7:.85;l(y.toDataURL("image/jpeg",S))},f.onerror=d,f.src=(I=v.target)==null?void 0:I.result},m.onerror=d,m.readAsDataURL(u)}),r=await Promise.all(e.map(u=>t(u)));console.log("[Photo Extractor] Images compressed, sending to server...");const i=new AbortController,o=setTimeout(()=>i.abort(),9e4),s=await fetch(Be,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Y}`},body:JSON.stringify({images:r}),signal:i.signal});if(clearTimeout(o),!s.ok){if(console.error("[Photo Extractor] Server response not OK:",s.status),s.status>=500||s.status===429)throw new Error("Server is processing - try again in 30 seconds");const u=await s.text();throw console.error("[Photo Extractor] Error response:",u),new Error("Photo extraction failed")}const n=await s.json();console.log("[Photo Extractor] Raw data from server:",n);const a=u=>{if(!u||u<=0)return"30 mins";if(u<60)return`${u} mins`;const l=Math.floor(u/60),d=u%60;return d?`${l} hr ${d} mins`:`${l} hr`};return{title:h(n.title||"Recipe from Photo"),description:h(n.description||"Scanned from photo"),creator:"Photo Scan",ingredients:(n.ingredients||[]).map(u=>{const l=h(u.trim());if(!l)return{quantity:"",unit:"",name:""};const d=l.match(/^([\d¬º¬Ω¬æ‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû\/\.\-\s\,]+)\s*/),m=d?d[1].trim():"",v=D(m);let f=l.slice(m.length).trim();const I=f.match(/^(cups?|tbsps?|tablespoons?|tsps?|teaspoons?|oz|ounces?|lbs?|pounds?|grams?|g|kg|kilograms?|ml|milliliters?|l|liters?|pinch|dash|piece|pieces|clove|cloves|slice|slices|can|cans)\s+/i);let y="";if(I){const g=I[1].toLowerCase();f=f.slice(I[0].length).trim(),g==="g"||g==="gram"||g==="grams"?y="g":g==="kg"||g==="kilogram"||g==="kilograms"?y="kg":g==="ml"||g==="milliliter"||g==="milliliters"?y="ml":g==="l"||g==="liter"||g==="liters"?y="l":g.startsWith("cup")?y="cup":g.startsWith("tbsp")||g.startsWith("tablespoon")?y="tbsp":g.startsWith("tsp")||g.startsWith("teaspoon")?y="tsp":g==="oz"||g.startsWith("ounce")?y="oz":g.startsWith("lb")||g.startsWith("pound")?y="lb":y=g}else y=v?"piece":"";return{quantity:v,unit:y,name:f||l}}),instructions:(n.instructions||[]).map(u=>h(u)),prepTime:a(n.prep_time||15),cookTime:a(n.cook_time||35),servings:n.servings||"4",cuisineType:n.cuisine||"Global",difficulty:n.difficulty||"Medium",mealTypes:["Dinner"],dietaryTags:n.dietary_tags||[],imageUrl:r[0],videoUrl:"",notes:n.notes||`Scanned from ${e.length} photo${e.length>1?"s":""}`,sourceUrl:""}}catch(t){throw console.error("[Photo Extractor] Catch block error:",t),t.name==="AbortError"?new Error("Server is processing ‚Äî please wait 30-45 seconds and try again"):new Error(t.message||"Photo extraction temporarily unavailable ‚Äî try again soon")}}const Ge=[{name:"Produce",sortOrder:0},{name:"Meat & Seafood",sortOrder:1},{name:"Dairy & Eggs",sortOrder:2},{name:"Bakery",sortOrder:3},{name:"Pantry",sortOrder:4},{name:"Frozen",sortOrder:5},{name:"Beverages",sortOrder:6},{name:"Other",sortOrder:7}],Je={tomato:"Produce",tomatoes:"Produce",onion:"Produce",onions:"Produce",garlic:"Produce",carrot:"Produce",carrots:"Produce",potato:"Produce",potatoes:"Produce",lettuce:"Produce",spinach:"Produce",broccoli:"Produce","bell pepper":"Produce",peppers:"Produce",mushroom:"Produce",mushrooms:"Produce",cucumber:"Produce",zucchini:"Produce",apple:"Produce",apples:"Produce",banana:"Produce",bananas:"Produce",lemon:"Produce",lemons:"Produce",lime:"Produce",limes:"Produce",avocado:"Produce",cilantro:"Produce",parsley:"Produce",basil:"Produce",chicken:"Meat & Seafood",beef:"Meat & Seafood",pork:"Meat & Seafood",turkey:"Meat & Seafood",salmon:"Meat & Seafood",shrimp:"Meat & Seafood",fish:"Meat & Seafood",bacon:"Meat & Seafood",sausage:"Meat & Seafood","ground beef":"Meat & Seafood",milk:"Dairy & Eggs",cheese:"Dairy & Eggs",butter:"Dairy & Eggs",eggs:"Dairy & Eggs",egg:"Dairy & Eggs",yogurt:"Dairy & Eggs",cream:"Dairy & Eggs","sour cream":"Dairy & Eggs",cheddar:"Dairy & Eggs",mozzarella:"Dairy & Eggs",parmesan:"Dairy & Eggs",bread:"Bakery",tortilla:"Bakery",tortillas:"Bakery",buns:"Bakery",rolls:"Bakery",bagels:"Bakery",croissant:"Bakery",rice:"Pantry",pasta:"Pantry",flour:"Pantry",sugar:"Pantry",salt:"Pantry",pepper:"Pantry",oil:"Pantry","olive oil":"Pantry","vegetable oil":"Pantry",vinegar:"Pantry","soy sauce":"Pantry",beans:"Pantry",chickpeas:"Pantry",lentils:"Pantry","tomato sauce":"Pantry","tomato paste":"Pantry",broth:"Pantry",stock:"Pantry",honey:"Pantry","peanut butter":"Pantry","canned tomatoes":"Pantry","ice cream":"Frozen","frozen vegetables":"Frozen","frozen peas":"Frozen","frozen corn":"Frozen",water:"Beverages",juice:"Beverages",coffee:"Beverages",tea:"Beverages",soda:"Beverages"};function le(e){return e.toLowerCase().trim().replace(/\s+/g," ").replace(/[^a-z0-9\s]/g,"")}function He(e,t){var o;const r=le(e);for(const[s,n]of Object.entries(Je))if(r.includes(s)){const a=t.find(u=>u.name===n);if(a)return a.id}const i=t.find(s=>s.name==="Other");return(i==null?void 0:i.id)||((o=t[0])==null?void 0:o.id)||""}function Qe(){return Ge.map((e,t)=>({id:`cat-${t}`,name:e.name,sortOrder:e.sortOrder}))}function Ut(e,t){const r=Qe(),i=new Map;for(const o of e){const s=t.find(a=>a.id===o.recipeId);if(!s)continue;const n=o.servings/s.servings;for(const a of s.ingredients){const u=he(a.quantity)*n,d=`${le(a.name)}-${ye(a.unit)}`,m=i.get(d);if(m){if(_e(m.unit,a.unit)){const v=re(m.quantity,m.unit)||0,f=re(u,a.unit)||0,I=v+f,y=we(m.unit);if(y){const g=ve(I,y.type);m.quantity=g.quantity,m.unit=g.unit}}else m.quantity+=u;m.sourceRecipeIds.includes(s.id)||m.sourceRecipeIds.push(s.id)}else{const v=He(a.name,r),f={id:`item-${Date.now()}-${Math.random()}`,name:a.name,quantity:u,unit:a.unit,categoryId:v,checked:!1,sourceRecipeIds:[s.id]};i.set(d,f)}}}return Array.from(i.values())}const Q="mealscrape-20";function ue(e){try{const t=new URL(e);return t.searchParams.has("tag")||t.searchParams.set("tag",Q),t.toString()}catch{return e.includes("?")?`${e}&tag=${Q}`:`${e}?tag=${Q}`}}async function qt(){const{data:e,error:t}=await c.from("product_categories").select("*").order("sort_order");if(t)throw t;return e||[]}async function zt(e){const{data:t,error:r}=await c.from("amazon_products").select("*").eq("category_id",e).eq("is_active",!0).order("popularity_score",{ascending:!1});if(r)throw r;return t||[]}async function At(e,t){let r=c.from("amazon_products").select("*").eq("is_active",!0);t&&(r=r.eq("category_id",t)),e.trim()&&(r=r.or(`product_name.ilike.%${e}%,description.ilike.%${e}%,search_keywords.cs.{${e}}`));const{data:i,error:o}=await r.order("popularity_score",{ascending:!1}).limit(50);if(o)throw o;return i||[]}async function Mt(e,t=5){const r=e.toLowerCase().trim(),{data:i,error:o}=await c.from("ingredient_product_mappings").select(`
      amazon_product_id,
      confidence_score,
      amazon_products (*)
    `).eq("ingredient_name",r).order("confidence_score",{ascending:!1}).limit(t);if(o&&console.error("Error fetching mappings:",o),i&&i.length>0)return i.filter(l=>l.amazon_products).map(l=>l.amazon_products);const s=r.split(",")[0].trim();let n=c.from("amazon_products").select("*").eq("is_active",!0);n=n.or(`product_name.ilike.%${s}%,search_keywords.cs.{${s}}`);const{data:a,error:u}=await n.order("popularity_score",{ascending:!1}).limit(t);if(u)throw u;return a||[]}async function Ct(e,t,r="1",i="",o,s){const{data:n,error:a}=await c.from("cart_items").insert({user_id:e,ingredient_name:t.product_name,quantity:r,unit:i,amazon_product_url:ue(t.amazon_url),amazon_product_name:t.product_name,price:t.price,image_url:t.image_url,asin:t.asin,source_recipe_id:o,delivery_service:null}).select().single();if(a)throw a;return n}async function Dt(e,t){const r=t.map(s=>({user_id:e,ingredient_name:s.product.product_name,quantity:s.quantity,unit:s.unit,amazon_product_url:ue(s.product.amazon_url),amazon_product_name:s.product.product_name,price:s.product.price,image_url:s.product.image_url,asin:s.product.asin,source_recipe_id:s.sourceRecipeId,delivery_service:s.deliveryService||null})),{data:i,error:o}=await c.from("cart_items").insert(r).select();if(o)throw o;return i}async function $t(e){const{data:t,error:r}=await c.from("user_meal_plans").select("*").eq("user_id",e).order("date",{ascending:!0});if(r)throw console.error("Error fetching meal plans:",r),r;return t.map(i=>({id:i.id,recipeId:i.recipe_id,date:i.date,mealType:i.meal_type,servings:i.servings}))}async function Ot(e,t){const{data:r,error:i}=await c.from("user_meal_plans").insert({user_id:e,recipe_id:t.recipeId,date:t.date,meal_type:t.mealType,servings:t.servings}).select().single();if(i)throw console.error("Error adding meal plan:",i),i;return{id:r.id,recipeId:r.recipe_id,date:r.date,mealType:r.meal_type,servings:r.servings}}async function Ft(e,t){const{data:r,error:i}=await c.from("user_meal_plans").upsert({id:t.id,user_id:e,recipe_id:t.recipeId,date:t.date,meal_type:t.mealType,servings:t.servings},{onConflict:"user_id,date,meal_type"}).select().single();if(i)throw console.error("Error updating meal plan:",i),i;return{id:r.id,recipeId:r.recipe_id,date:r.date,mealType:r.meal_type,servings:r.servings}}async function Nt(e,t){const{error:r}=await c.from("user_meal_plans").delete().eq("id",t).eq("user_id",e);if(r)throw console.error("Error deleting meal plan:",r),r}async function Bt(e){const{error:t}=await c.from("user_meal_plans").delete().eq("user_id",e);if(t)throw console.error("Error clearing meal plans:",t),t}async function Wt(e){const{data:t,error:r}=await c.from("user_grocery_items").select("*").eq("user_id",e).order("created_at",{ascending:!0});if(r)throw console.error("Error fetching grocery items:",r),r;return t.map(i=>({id:i.id,name:i.name,quantity:Number(i.quantity),unit:i.unit,categoryId:i.category_id,checked:i.checked,sourceRecipeIds:i.source_recipe_ids||[]}))}async function Lt(e,t){if(await c.from("user_grocery_items").delete().eq("user_id",e),t.length===0)return;const r=t.map(o=>({user_id:e,name:o.name,quantity:o.quantity,unit:o.unit,category_id:o.categoryId,checked:o.checked,source_recipe_ids:o.sourceRecipeIds})),{error:i}=await c.from("user_grocery_items").insert(r);if(i)throw console.error("Error saving grocery items:",i),i}async function Yt(e){const{error:t}=await c.from("user_grocery_items").delete().eq("user_id",e);if(t)throw console.error("Error clearing grocery items:",t),t}const K="mealscrape-20";function Ze(e,t){const r=e.replace(/\([^)]*\)/g,"").replace(/\[[^\]]*\]/g,"").trim();let i="https://www.amazon.com/s",o=new URLSearchParams({k:r,tag:K});return t==="amazon_fresh"?o.set("i","amazonfresh"):t==="amazon_grocery"?o.set("i","grocery"):t==="whole_foods"&&o.set("i","wholefoods"),`${i}?${o.toString()}`}function Ke(e){const t="https://www.amazon.com/gp/aws/cart/add.html",r=new URLSearchParams;return e.forEach((i,o)=>{const s=o+1;r.append(`ASIN.${s}`,i.asin);const n=typeof i.quantity=="string"?parseInt(i.quantity)||1:i.quantity||1;r.append(`Quantity.${s}`,n.toString())}),r.append("tag",K),r.append("AssociateTag",K),`${t}?${r.toString()}`}function Vt(e,t){const r=e.filter(a=>a.asin).map(a=>({name:a.name,asin:a.asin,quantity:a.quantity||"1",unit:a.unit})),i=e.filter(a=>!a.asin),o=new Map;i.forEach(a=>{const u=a.name.toLowerCase().trim();o.has(u)||o.set(u,{ingredient:a.name,searchUrl:Ze(a.name,t),quantities:[]}),o.get(u).quantities.push({quantity:a.quantity,unit:a.unit})});const s=Array.from(o.values()).map(a=>{if(a.quantities.length===1)return{ingredient:a.ingredient,searchUrl:a.searchUrl,quantity:a.quantities[0].quantity,unit:a.quantities[0].unit};const u=a.quantities.reduce((d,m)=>{const v=parseFloat(m.quantity||"0");return d+(isNaN(v)?0:v)},0),l=a.quantities[0].unit||"";return{ingredient:a.ingredient,searchUrl:a.searchUrl,quantity:u>0?u.toString():void 0,unit:l}}),n=r.length>0?Ke(r):null;return{mappedItems:r,unmappedItems:s,cartUrl:n,hasCartItems:r.length>0,hasUnmappedItems:s.length>0}}const Xe=["fresh","organic","produce","vegetable","fruit","greens","lettuce","tomato","cucumber","carrot","onion","garlic","bell pepper","mushroom","spinach","kale","broccoli","cauliflower"],et=["chicken","beef","pork","turkey","lamb","fish","salmon","shrimp","meat","steak","ground","breast","thigh","tenderloin"],tt=["milk","cheese","yogurt","butter","cream","sour cream","cottage cheese","mozzarella","cheddar","parmesan","eggs"],rt=["rice","pasta","flour","sugar","salt","pepper","oil","vinegar","sauce","canned","dried","spice","seasoning","baking powder","baking soda","vanilla extract"],ot=["frozen","ice cream","popsicle","frozen peas","frozen corn","frozen berries","frozen vegetables"],it=["organic","grass-fed","free-range","pasture-raised","wild-caught","non-gmo","gluten-free","vegan","sustainable","local","artisan"];function st(e,t){const r=e.toLowerCase(),i=it.some(s=>r.includes(s));if(Xe.some(s=>r.includes(s))){let s="instacart";return i&&(t!=null&&t.enableWholeFoods)?s="whole_foods":t!=null&&t.enableAmazonFresh&&(s="amazon_fresh"),{category:"fresh_produce",freshnessPriority:10,recommendedService:s}}if(et.some(s=>r.includes(s))){let s="instacart";return i&&(t!=null&&t.enableWholeFoods)?s="whole_foods":t!=null&&t.enableAmazonFresh&&(s="amazon_fresh"),{category:"meat",freshnessPriority:10,recommendedService:s}}if(tt.some(s=>r.includes(s))){let s="instacart";return i&&(t!=null&&t.enableWholeFoods)?s="whole_foods":t!=null&&t.enableAmazonFresh&&(s="amazon_fresh"),{category:"dairy",freshnessPriority:9,recommendedService:s}}if(ot.some(s=>r.includes(s))){let s="instacart";return t!=null&&t.enableAmazonFresh&&(s="amazon_fresh"),{category:"frozen",freshnessPriority:6,recommendedService:s}}if(rt.some(s=>r.includes(s))){let s="amazon";return t!=null&&t.enableAmazonGrocery&&(s="amazon_grocery"),{category:"pantry",freshnessPriority:2,recommendedService:s}}let o="amazon";return t!=null&&t.enableAmazonGrocery&&(o="amazon_grocery"),{category:"other",freshnessPriority:5,recommendedService:o}}async function at(e){const{data:t,error:r}=await c.from("ingredient_delivery_routing").select("*").eq("ingredient_name",e.toLowerCase().trim()).maybeSingle();return r?(console.error("Error fetching routing rule:",r),null):t}async function jt(e,t){const r=await nt(t),i=await Promise.all(e.map(async o=>{const s=await at(o.name);if(s)return{...o,recommendedService:s.recommended_service,category:s.category,freshnessPriority:s.freshness_priority,confidenceScore:Number(s.confidence_score),reasoning:"Database rule match"};const n=st(o.name,r);let a=n.recommendedService;return(r==null?void 0:r.defaultService)!=="auto"&&(a=r.defaultService),!(r!=null&&r.autoRouteFreshItems)&&n.freshnessPriority>=8&&(a="manual"),!(r!=null&&r.autoRoutePantryItems)&&n.freshnessPriority<=3&&(a="manual"),{...o,recommendedService:a,category:n.category,freshnessPriority:n.freshnessPriority,confidenceScore:.7,reasoning:"Auto-categorized"}}));return{instacartItems:i.filter(o=>o.recommendedService==="instacart"),amazonItems:i.filter(o=>o.recommendedService==="amazon"),amazonFreshItems:i.filter(o=>o.recommendedService==="amazon_fresh"),amazonGroceryItems:i.filter(o=>o.recommendedService==="amazon_grocery"),wholeFoodsItems:i.filter(o=>o.recommendedService==="whole_foods"),manualItems:i.filter(o=>o.recommendedService==="manual")}}async function nt(e){const{data:t,error:r}=await c.from("user_delivery_preferences").select("*").eq("user_id",e).maybeSingle();return r?(console.error("Error fetching delivery preferences:",r),null):t?{id:t.id,userId:t.user_id,defaultService:t.default_service,deliveryAddress:t.delivery_address,deliveryInstructions:t.delivery_instructions,preferredDeliveryWindow:t.preferred_delivery_window,autoRouteFreshItems:t.auto_route_fresh_items,autoRoutePantryItems:t.auto_route_pantry_items,enableCostOptimization:t.enable_cost_optimization,preferredAmazonService:t.preferred_amazon_service,enableAmazonFresh:t.enable_amazon_fresh,enableAmazonGrocery:t.enable_amazon_grocery,enableWholeFoods:t.enable_whole_foods,userZipCode:t.user_zip_code}:null}async function Gt(e){const{error:t}=await c.from("user_delivery_preferences").upsert({user_id:e.userId,default_service:e.defaultService,delivery_address:e.deliveryAddress,delivery_instructions:e.deliveryInstructions||"",preferred_delivery_window:e.preferredDeliveryWindow||"",auto_route_fresh_items:e.autoRouteFreshItems,auto_route_pantry_items:e.autoRoutePantryItems,enable_cost_optimization:e.enableCostOptimization,preferred_amazon_service:e.preferredAmazonService||"auto",enable_amazon_fresh:e.enableAmazonFresh??!0,enable_amazon_grocery:e.enableAmazonGrocery??!0,enable_whole_foods:e.enableWholeFoods??!1,user_zip_code:e.userZipCode||"",updated_at:new Date().toISOString()});if(t)throw console.error("Error saving delivery preferences:",t),t}function Jt(e){return{fresh_produce:"ü•¨",meat:"ü•©",dairy:"ü•õ",pantry:"üè∫",frozen:"‚ùÑÔ∏è",other:"üì¶"}[e]||"üì¶"}function Ht(e){return{instacart:"Instacart",amazon:"Amazon",amazon_fresh:"Amazon Fresh",amazon_grocery:"Amazon Grocery",whole_foods:"Whole Foods",manual:"Choose Service"}[e]}const ct="https://api.instacart.com/v2";async function de(){const{data:e,error:t}=await c.from("delivery_service_configs").select("*").eq("service_name","instacart").single();if(t||!e)throw new Error("Instacart configuration not found");return e}async function Qt(){try{return(await de()).is_active}catch{return!1}}async function Zt(e,t,r){try{const i=await de();if(!i.api_key)throw new Error("Instacart API key not configured");const o=i.affiliate_tag||"mealscrape",s=`${t}-${Date.now()}`,n=await fetch(`${ct}/checkout/sessions`,{method:"POST",headers:{Authorization:`Bearer ${i.api_key}`,"Content-Type":"application/json"},body:JSON.stringify({items:e,delivery_address:r,partner_metadata:{affiliate_tag:o,tracking_id:s,source:"mealscrape_app"}})});if(!n.ok)throw new Error("Failed to create Instacart checkout session");const a=await n.json();return await c.from("affiliate_conversions").insert({user_id:t,service_name:"instacart",conversion_type:"cart_created",tracking_id:s,status:"pending",metadata:{session_id:a.session_id}}),{session_id:a.session_id,checkout_url:lt(a.checkout_url,s),expires_at:a.expires_at}}catch(i){throw console.error("Error creating Instacart cart:",i),i}}function lt(e,t){try{const r=new URL(e);return r.searchParams.set("utm_source","mealscrape"),r.searchParams.set("utm_medium","affiliate"),r.searchParams.set("tracking_id",t),r.toString()}catch{return e}}const Kt={async getUserReferralCode(){const{data:{user:e}}=await c.auth.getUser();if(!e)return null;const{data:t,error:r}=await c.from("referral_codes").select("code").eq("user_id",e.id).maybeSingle();if(r)return console.error("Error fetching referral code:",r),null;if(t)return t.code;const{data:i,error:o}=await c.rpc("generate_referral_code",{p_user_id:e.id});return o?(console.error("Error generating referral code:",o),null):i},async getUserReferralStats(){const{data:{user:e}}=await c.auth.getUser();if(!e)return null;const{data:t,error:r}=await c.rpc("get_user_referral_stats",{p_user_id:e.id});return r?(console.error("Error fetching referral stats:",r),null):t},async checkPayoutEligibility(){const{data:{user:e}}=await c.auth.getUser();if(!e)return!1;const{data:t,error:r}=await c.rpc("check_referral_payout_eligibility",{p_user_id:e.id});return r?(console.error("Error checking payout eligibility:",r),!1):t},async requestPayout(e,t,r){const{data:{user:i}}=await c.auth.getUser();if(!i)return{success:!1,error:"Not authenticated"};const{data:o,error:s}=await c.rpc("request_referral_payout",{p_user_id:i.id,p_payout_method:e,p_payout_email:t,p_payout_details:r||null});return s?(console.error("Error requesting payout:",s),{success:!1,error:s.message}):{success:!0,rewardId:o}},async getPayoutHistory(){const{data:{user:e}}=await c.auth.getUser();if(!e)return[];const{data:t,error:r}=await c.from("referral_rewards").select("*").eq("user_id",e.id).order("requested_at",{ascending:!1});return r?(console.error("Error fetching payout history:",r),[]):t||[]},async getReferralsList(){const{data:{user:e}}=await c.auth.getUser();if(!e)return[];const{data:t,error:r}=await c.from("referrals").select("*").eq("referrer_id",e.id).order("created_at",{ascending:!1});return r?(console.error("Error fetching referrals list:",r),[]):t||[]},async getAllPendingPayouts(){const{data:e,error:t}=await c.from("referral_rewards").select("*").in("payout_status",["pending","processing"]).order("requested_at",{ascending:!0});return t?(console.error("Error fetching pending payouts:",t),[]):e||[]},async adminProcessPayout(e,t,r,i){const{data:o,error:s}=await c.rpc("admin_process_payout",{p_reward_id:e,p_new_status:t,p_admin_notes:r||null,p_failure_reason:i||null});return s?(console.error("Error processing payout:",s),{success:!1,error:s.message}):{success:!0}},getReferralLink(e){return`https://mealscrape.com/?ref=${e}`}};async function Xt(e=1,t=20){const r=(e-1)*t,{data:i,error:o}=await c.from("blog_posts").select(`
      *,
      profiles!blog_posts_user_id_profiles_fkey(id, username, avatar_url)
    `).eq("published",!0).order("created_at",{ascending:!1}).range(r,r+t-1);if(o)throw o;return await Promise.all((i||[]).map(async n=>{const[a,u,l]=await Promise.all([c.from("blog_likes").select("*",{count:"exact",head:!0}).eq("post_id",n.id),c.from("blog_comments").select("*",{count:"exact",head:!0}).eq("post_id",n.id),(async()=>{const{data:{user:d}}=await c.auth.getUser();return d?c.from("blog_likes").select("*").eq("post_id",n.id).eq("user_id",d.id).maybeSingle():null})()]);return{...n,author:n.profiles,like_count:a.count||0,comment_count:u.count||0,user_has_liked:!!(l!=null&&l.data)}}))}async function er(e){const{data:t,error:r}=await c.from("blog_posts").select(`
      *,
      profiles!blog_posts_user_id_profiles_fkey(id, username, avatar_url)
    `).eq("slug",e).eq("published",!0).single();if(r||!t)return null;await c.rpc("increment_blog_post_views",{post_id:t.id});const[i,o,s]=await Promise.all([c.from("blog_likes").select("*",{count:"exact",head:!0}).eq("post_id",t.id),c.from("blog_comments").select("*",{count:"exact",head:!0}).eq("post_id",t.id),(async()=>{const{data:{user:n}}=await c.auth.getUser();return n?c.from("blog_likes").select("*").eq("post_id",t.id).eq("user_id",n.id).maybeSingle():null})()]);return{...t,author:t.profiles,like_count:i.count||0,comment_count:o.count||0,user_has_liked:!!(s!=null&&s.data)}}async function tr(e){const{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("Not authenticated");let r=be(e.title);const{data:i}=await c.from("blog_posts").select("slug").eq("slug",r).single();i&&(r=`${r}-${Date.now()}`);const{data:o,error:s}=await c.from("blog_posts").insert({user_id:t.id,title:e.title,slug:r,content:e.content,excerpt:e.excerpt,cover_image:e.cover_image}).select(`
      *,
      profiles!blog_posts_user_id_profiles_fkey(id, username, avatar_url)
    `).single();if(s)throw s;return{...o,author:o.profiles,like_count:0,comment_count:0,user_has_liked:!1}}async function rr(e){const{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("Not authenticated");const{data:r}=await c.from("blog_likes").select("*").eq("post_id",e).eq("user_id",t.id).maybeSingle();return r?(await c.from("blog_likes").delete().eq("post_id",e).eq("user_id",t.id),!1):(await c.from("blog_likes").insert({post_id:e,user_id:t.id}),!0)}async function or(e){const{data:t,error:r}=await c.from("blog_comments").select(`
      *,
      profiles!blog_comments_user_id_profiles_fkey(id, username, avatar_url)
    `).eq("post_id",e).order("created_at",{ascending:!0});if(r)throw r;const{data:{user:i}}=await c.auth.getUser(),o=await Promise.all((t||[]).map(async a=>{var m;const[u,l,d]=await Promise.all([c.from("blog_comment_votes").select("*",{count:"exact",head:!0}).eq("comment_id",a.id).eq("vote_type","up"),c.from("blog_comment_votes").select("*",{count:"exact",head:!0}).eq("comment_id",a.id).eq("vote_type","down"),i?c.from("blog_comment_votes").select("vote_type").eq("comment_id",a.id).eq("user_id",i.id).maybeSingle():Promise.resolve({data:null})]);return{...a,author:a.profiles,vote_score:(u.count||0)-(l.count||0),user_vote:((m=d.data)==null?void 0:m.vote_type)||null}})),s=new Map,n=[];return o.forEach(a=>{s.set(a.id,{...a,replies:[]})}),o.forEach(a=>{const u=s.get(a.id);if(a.parent_id){const l=s.get(a.parent_id);l&&(l.replies=l.replies||[],l.replies.push(u))}else n.push(u)}),n}async function ir(e,t,r){const{data:{user:i}}=await c.auth.getUser();if(!i)throw new Error("Not authenticated");const{data:o,error:s}=await c.from("blog_comments").insert({post_id:e,user_id:i.id,parent_id:r||null,content:t}).select(`
      *,
      profiles!blog_comments_user_id_profiles_fkey(id, username, avatar_url)
    `).single();if(s)throw s;return{...o,author:o.profiles,vote_score:0,user_vote:null,replies:[]}}async function sr(e,t){const{data:{user:r}}=await c.auth.getUser();if(!r)throw new Error("Not authenticated");const{data:i}=await c.from("blog_comment_votes").select("*").eq("comment_id",e).eq("user_id",r.id).maybeSingle();i?i.vote_type===t?await c.from("blog_comment_votes").delete().eq("comment_id",e).eq("user_id",r.id):await c.from("blog_comment_votes").update({vote_type:t}).eq("comment_id",e).eq("user_id",r.id):await c.from("blog_comment_votes").insert({comment_id:e,user_id:r.id,vote_type:t})}async function ar(e){const{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("Not authenticated");const{data:r}=await c.from("profiles").select("is_admin").eq("id",t.id).single(),{data:i}=await c.from("blog_posts").select("user_id").eq("id",e).single();if(!i)throw new Error("Post not found");const o=i.user_id===t.id,s=(r==null?void 0:r.is_admin)===!0;if(!o&&!s)throw new Error("Not authorized to delete this post");const{error:n}=await c.from("blog_posts").delete().eq("id",e);if(n)throw n}async function nr(e){const{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("Not authenticated");const{data:r}=await c.from("profiles").select("is_admin").eq("id",t.id).single(),{data:i}=await c.from("blog_comments").select("user_id").eq("id",e).single();if(!i)throw new Error("Comment not found");const o=i.user_id===t.id,s=(r==null?void 0:r.is_admin)===!0;if(!o&&!s)throw new Error("Not authorized to delete this comment");const{error:n}=await c.from("blog_comments").delete().eq("id",e);if(n)throw n}async function cr(e,t,r,i,o){const{error:s}=await c.from("amazon_service_clicks").insert({user_id:e,service_type:t,item_count:r,estimated_value:null,recipe_id:null,clicked_at:new Date().toISOString()});s&&console.error("Error tracking Amazon service click:",s)}export{Ot as $,Dt as A,Zt as B,Ht as C,cr as D,Vt as E,Pt as F,kt as G,Tt as H,St as I,Et as J,It as K,yt as L,Pe as M,ht as N,qe as O,Qe as P,$t as Q,Wt as R,Lt as S,Qt as T,nt as U,jt as V,Yt as W,Bt as X,Nt as Y,Ut as Z,Ft as _,Rt as a,Gt as a0,bt as a1,vt as a2,ie as b,At as c,Kt as d,xt as e,qt as f,ke as g,tr as h,Le as i,Xt as j,ar as k,nr as l,ir as m,er as n,or as o,rr as p,zt as q,Te as r,Se as s,_t as t,wt as u,sr as v,ue as w,Ct as x,Jt as y,Mt as z};
