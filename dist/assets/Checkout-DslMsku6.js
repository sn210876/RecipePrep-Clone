import{s as R,r as U,j as e,B as b,C as u,t as g,v as p,x as v,m as j,f as m}from"./index-JyBq9rLv.js";import{B as I}from"./badge-CS5hCRJb.js";import{a as k,c as G,b as L}from"./instacartService-ESGH7ADc.js";import{f as W,b as O}from"./amazonProductService-BvrNFzFX.js";import{o as Q}from"./deviceDetection-Bz2v38a8.js";import{A as J}from"./arrow-left-C-KHpdAf.js";import{T as M}from"./truck-CN4STPAq.js";import{L as E}from"./leaf-C5rgh1g9.js";import{P as S}from"./package-D2kwbZbb.js";import{S as D}from"./shopping-bag-CE9oTTAr.js";import{E as A}from"./external-link-CK9C3IEb.js";const $="mealscrape-20";function H(a,c){const n=a.replace(/\([^)]*\)/g,"").replace(/\[[^\]]*\]/g,"").trim();let d="https://www.amazon.com/s",i=new URLSearchParams({k:n,tag:$});return c==="amazon_fresh"?i.set("i","amazonfresh"):c==="amazon_grocery"?i.set("i","grocery"):c==="whole_foods"&&i.set("i","wholefoods"),`${d}?${i.toString()}`}function T(a){const c="https://www.amazon.com/gp/aws/cart/add.html",n=new URLSearchParams;return a.forEach((d,i)=>{const r=i+1;n.append(`ASIN.${r}`,d.asin);const x=typeof d.quantity=="string"?parseInt(d.quantity)||1:d.quantity||1;n.append(`Quantity.${r}`,x.toString())}),n.append("tag",$),n.append("AssociateTag",$),`${c}?${n.toString()}`}function V(a,c){const n=a.filter(t=>t.asin).map(t=>({name:t.name,asin:t.asin,quantity:t.quantity||"1",unit:t.unit})),d=a.filter(t=>!t.asin),i=new Map;d.forEach(t=>{const l=t.name.toLowerCase().trim();i.has(l)||i.set(l,{ingredient:t.name,searchUrl:H(t.name,c),quantities:[]}),i.get(l).quantities.push({quantity:t.quantity,unit:t.unit})});const r=Array.from(i.values()).map(t=>{if(t.quantities.length===1)return{ingredient:t.ingredient,searchUrl:t.searchUrl,quantity:t.quantities[0].quantity,unit:t.quantities[0].unit};const l=t.quantities.reduce((w,_)=>{const C=parseFloat(_.quantity||"0");return w+(isNaN(C)?0:C)},0),f=t.quantities[0].unit||"";return{ingredient:t.ingredient,searchUrl:t.searchUrl,quantity:l>0?l.toString():void 0,unit:f}}),x=n.length>0?T(n):null;return{mappedItems:n,unmappedItems:r,cartUrl:x,hasCartItems:n.length>0,hasUnmappedItems:r.length>0}}async function K(a,c,n,d,i){const{error:r}=await R.from("amazon_service_clicks").insert({user_id:a,service_type:c,item_count:n,estimated_value:null,recipe_id:null,clicked_at:new Date().toISOString()});r&&console.error("Error tracking Amazon service click:",r)}function le({onNavigate:a}){const[c,n]=U.useState(!1),[d,i]=U.useState(null);if(U.useEffect(()=>{(()=>{const N=localStorage.getItem("checkout_data");if(N)try{const o=JSON.parse(N);i(o)}catch(o){console.error("Failed to parse checkout data:",o),m.error("Failed to load checkout data"),a==null||a("grocery-list")}else m.error("No checkout data found"),a==null||a("grocery-list")})()},[a]),!d)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"Loading checkout..."})})});const{instacartItems:r,amazonItems:x,amazonFreshItems:t,amazonGroceryItems:l,wholeFoodsItems:f,userId:w,deliveryAddress:_}=d,C=[...x,...t,...l,...f],P=r.length+C.length,B=async()=>{if(r.length===0){m.error("No items for Instacart delivery");return}n(!0);try{m.info("Creating Instacart shopping list...");const s=r.map(o=>({name:o.name,quantity:o.quantity,unit:o.unit})),N=await G(s,w,_);await Q(N.products_link_url),m.success("Instacart opened - add items to cart and checkout!")}catch(s){console.error("Error creating Instacart shopping list:",s),m.error("Failed to create Instacart shopping list. Please try again.")}finally{n(!1)}},q=async(s,N)=>{if(N.length===0){m.error(`No items for ${L(s)}`);return}n(!0);try{m.info("Finding matching Amazon products...");const o=[],z=[];for(const y of N){const F=await W(y.name,1);F.length>0?(z.push({product:F[0],quantity:y.quantity.toString(),unit:y.unit,deliveryService:s}),o.push({name:y.name,quantity:y.quantity.toString(),unit:y.unit,asin:F[0].asin})):o.push({name:y.name,quantity:y.quantity.toString(),unit:y.unit,asin:null})}z.length>0&&await O(w,z),await K(w,s,z.length);const h=V(o,s);localStorage.setItem("checkout_results",JSON.stringify({result:h,serviceName:L(s)})),a==null||a("checkout-results"),h.hasCartItems&&!h.hasUnmappedItems?m.success(`Added ${h.mappedItems.length} items to ${L(s)} cart`):h.hasCartItems&&h.hasUnmappedItems?m.info(`${h.mappedItems.length} items ready, ${h.unmappedItems.length} need manual search`):h.hasUnmappedItems&&m.info(`${h.unmappedItems.length} items need manual search on Amazon`)}catch(o){console.error(`Error processing ${s}:`,o),m.error("Failed to process items")}finally{n(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-orange-50 to-amber-50",children:e.jsxs("div",{className:"max-w-3xl mx-auto p-4 pb-safe",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(b,{variant:"ghost",onClick:()=>a==null?void 0:a("grocery-list"),className:"mb-4",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Back to Grocery List"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(M,{className:"w-6 h-6 text-orange-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Choose Delivery Service"})]}),e.jsxs("p",{className:"text-gray-600",children:["We've automatically sorted your ",P," items by freshness and delivery service"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.length>0&&e.jsxs(u,{children:[e.jsxs(g,{className:"pb-3 pt-6",children:[e.jsx(p,{className:"text-base flex items-start gap-2 mb-2",children:e.jsx("img",{src:"/instacart_logo_kale.png",alt:"Instacart",style:{width:"80px",height:"24px",objectFit:"contain",marginTop:"-4px"}})}),e.jsx(v,{children:"Quick delivery"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:r.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),t.length>0&&e.jsxs(u,{children:[e.jsxs(g,{className:"pb-3",children:[e.jsxs(p,{className:"text-base flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-green-600"}),"Amazon Fresh"]}),e.jsx(v,{children:"Same-day delivery"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:t.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),l.length>0&&e.jsxs(u,{children:[e.jsxs(g,{className:"pb-3",children:[e.jsxs(p,{className:"text-base flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 text-orange-600"}),"Amazon Grocery"]}),e.jsx(v,{children:"Standard shipping"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:l.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),f.length>0&&e.jsxs(u,{children:[e.jsxs(g,{className:"pb-3",children:[e.jsxs(p,{className:"text-base flex items-center gap-2",children:[e.jsx(D,{className:"w-4 h-4 text-emerald-600"}),"Whole Foods"]}),e.jsx(v,{children:"Premium organic"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-600",children:f.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),x.length>0&&e.jsxs(u,{children:[e.jsxs(g,{className:"pb-3",children:[e.jsxs(p,{className:"text-base flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 text-orange-600"}),"Amazon"]}),e.jsx(v,{children:"General items"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:x.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]})]}),r.length>0&&e.jsxs(u,{children:[e.jsx(g,{children:e.jsxs(p,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("img",{src:"/instacart_logo_kale.png",alt:"Instacart",style:{width:"80px",height:"80px",objectFit:"contain"}}),"(",r.length,")"]}),e.jsxs(b,{onClick:B,disabled:c,className:"font-medium hover:opacity-90 flex items-center",style:{height:"44px",backgroundColor:c?"#002920":"#003D29",color:"#FAF1E5",borderRadius:"22px",paddingLeft:"20px",paddingRight:"20px",border:"none",gap:"8px"},children:[e.jsx("img",{src:"/instacart_logo_carrott.png",alt:"Instacart",style:{width:"18px",height:"18px",objectFit:"contain",flexShrink:0}}),e.jsx("span",{style:{whiteSpace:"nowrap"},children:"Shop with Instacart"})]})]})}),e.jsx(j,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:r.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:k(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(I,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),t.length>0&&e.jsxs(u,{children:[e.jsx(g,{children:e.jsxs(p,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-green-600"}),"Amazon Fresh (",t.length,")"]}),e.jsxs(b,{size:"sm",onClick:()=>q("amazon_fresh",t),disabled:c,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(A,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(j,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:t.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:k(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(I,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),l.length>0&&e.jsxs(u,{children:[e.jsx(g,{children:e.jsxs(p,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 text-orange-600"}),"Amazon Grocery (",l.length,")"]}),e.jsxs(b,{size:"sm",onClick:()=>q("amazon_grocery",l),disabled:c,className:"bg-orange-600 hover:bg-orange-700",children:[e.jsx(A,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(j,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:l.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-orange-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:k(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(I,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),f.length>0&&e.jsxs(u,{children:[e.jsx(g,{children:e.jsxs(p,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-4 h-4 text-emerald-600"}),"Whole Foods (",f.length,")"]}),e.jsxs(b,{size:"sm",onClick:()=>q("whole_foods",f),disabled:c,className:"bg-emerald-600 hover:bg-emerald-700",children:[e.jsx(A,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(j,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:f.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-emerald-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:k(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(I,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),x.length>0&&e.jsxs(u,{children:[e.jsx(g,{children:e.jsxs(p,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4 text-orange-600"}),"Amazon (",x.length,")"]}),e.jsxs(b,{size:"sm",onClick:()=>q("amazon",x),disabled:c,className:"bg-orange-600 hover:bg-orange-700",children:[e.jsx(A,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(j,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:x.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-orange-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:k(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(I,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]})]})]})})}export{le as Checkout};
