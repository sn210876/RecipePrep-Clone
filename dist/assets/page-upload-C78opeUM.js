import{r as d,bd as _e,j as e,B as Fe,J as W,c0 as $e,X as T,c1 as Me,b3 as De,b4 as Ie,U as Le}from"./react-vendor-z9ssXL8w.js";import{s as f,T as ze,S as Ee,o as Ve,p as Oe,q as Be,r as Ae,B as We,G as ue,K as q,H as he}from"./page-addrecipe-Pb6dTsbS.js";import{u as t}from"./vendor-Clj4czuh.js";import{e as Te}from"./page-discover-C_JktAEP.js";import{C as P,b as ge,c as qe,d as He}from"./capacitor-vendor-Dh3Cr3CD.js";import"./ui-vendor-BA32w1ww.js";import"./services-BpcRR5rK.js";import"./supabase-vendor-DpDh9Ika.js";import"./page-grocerylist-9H8dAkfw.js";import"./page-adminproducts-DimmU9B1.js";import"./page-adminpayouts-D8abdeR0.js";import"./page-blog-DTt-yulm.js";function pe(k){return k.type.startsWith("video/")}function ls({onNavigate:k}){var oe;const[p,R]=d.useState([]),[_,F]=d.useState([]),[$,L]=d.useState(null),[x,H]=d.useState("post"),[U,G]=d.useState(""),[N,J]=d.useState(""),[z,K]=d.useState(""),[X,xe]=d.useState([]),[Y,Q]=d.useState(!1),[Z,Ge]=d.useState(0),[fe,E]=d.useState(!1),[ee,be]=d.useState(""),[se,V]=d.useState([]),[c,O]=d.useState(null),[te,ae]=d.useState(!1),[B,M]=d.useState(!1),D=_e.useRef(null);d.useEffect(()=>{ye()},[]);const ye=async()=>{try{const{data:s}=await f.auth.getUser();if(!s.user)return;const{data:a,error:n}=await f.from("public_recipes").select("id, title, image_url").eq("user_id",s.user.id).order("created_at",{ascending:!1});if(n)throw n;xe(a||[])}catch(s){console.error("Error loading recipes:",s)}},ve=s=>new Promise((a,n)=>{const l=document.createElement("video");l.preload="metadata",l.onloadedmetadata=()=>{window.URL.revokeObjectURL(l.src);const i=Math.floor(l.duration);isNaN(i)||i===0?n(new Error("Invalid video duration")):a(i)},l.onerror=()=>{window.URL.revokeObjectURL(l.src),n(new Error("Failed to load video metadata"))},l.src=URL.createObjectURL(s)}),je=async s=>{const a=Array.from(s.target.files||[]);if(a.length===0)return;const n=a.filter(o=>o.type.startsWith("image/")||o.type.startsWith("video/"));if(n.length===0){t.error("Please select at least one image or video");return}if(n.length>4){t.error("You can only upload up to 4 images/videos total");return}const l=[],i=[];let m=!1;const r=[],w=[];for(const o of n){const g=ue(o),b=o.type.startsWith("video/");if(g)r.push(o);else if(b){if(o.size>100*1024*1024){t.error(`${o.name} is too large (max 100MB for videos)`);continue}try{const u=await ve(o);if(x==="daily"&&u>30){t.error(`${o.name}: Daily videos must be 30 seconds or less`);continue}m=!0,w.push(o)}catch(u){console.error("Video load error:",u),t.error(`Failed to load ${o.name}`);continue}}}if(r.length>0){const o=t.loading("Compressing images...",{duration:0});try{const g=await q(r,(u,S,C)=>{C.isCompressing&&t.loading(`Compressing image ${u+1}/${S}... ${Math.round(C.percent)}%`,{id:o,duration:0})}),b=g.reduce((u,S)=>u+(S.originalSize-S.compressedSize),0);t.success(`Images compressed! Saved ${he(b)}`,{id:o,duration:3e3});for(const u of g)l.push(u.file),i.push(URL.createObjectURL(u.file))}catch(g){t.error(g.message||"Failed to compress images",{id:o});return}}for(const o of w)l.push(o),i.push(URL.createObjectURL(o));if(l.length===0){t.error("No valid files to upload");return}R(l),F(i),L(m?"video":"image")},re=()=>{_.forEach(s=>URL.revokeObjectURL(s)),R([]),F([]),L(null)},ie=async s=>{try{const a=await qe.getPhoto({quality:90,allowEditing:!1,resultType:He.Uri,source:s});if(!a.webPath){t.error("Failed to get image");return}const l=await(await fetch(a.webPath)).blob(),i=new File([l],`photo-${Date.now()}.${a.format}`,{type:`image/${a.format}`}),m=t.loading("Compressing image...",{duration:0});try{const w=(await q([i]))[0].file;t.success("Image ready!",{id:m}),R([w]),F([URL.createObjectURL(w)]),L("image")}catch(r){t.error(r.message||"Failed to compress image",{id:m})}}catch(a){a.message!=="User cancelled photos app"&&(console.error("Camera error:",a),t.error("Failed to access camera"))}},we=()=>{P.isNativePlatform()?ie(ge.Camera):t.info("Camera only available on mobile app")},Ne=()=>{P.isNativePlatform()&&ie(ge.Photos)},Se=()=>{D.current&&(B?D.current.pause():D.current.play(),M(!B))},Ue=async s=>{if(!s.trim()){V([]);return}ae(!0);try{const l=((await(await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(s)}&media=music&entity=song&limit=20`)).json()).results||[]).map(i=>{var m;return{id:i.trackId.toString(),name:i.trackName||"Unknown Song",artists:[{name:i.artistName||"Unknown Artist"}],album:{images:[{url:((m=i.artworkUrl100)==null?void 0:m.replace("100x100","300x300"))||"https://via.placeholder.com/300"}]},preview_url:i.previewUrl||null}});V(l)}catch(a){console.error("Music search failed:",a),t.error("Search failed â€” try again"),V([])}finally{ae(!1)}},Ce=async()=>{var s,a,n,l,i,m;if(p.length===0){t.error("Please select an image or video");return}if(x==="post"&&!U.trim()){t.error("Please enter a title");return}if(x==="daily"&&$==="video"&&Z>30){t.error("Daily videos must be 30 seconds or less");return}Q(!0);try{const{data:r}=await f.auth.getUser();if(!r.user)throw new Error("Not authenticated");const{data:w}=await f.from("profiles").select("id").eq("id",r.user.id).maybeSingle();w||await f.from("profiles").insert({id:r.user.id,username:((s=r.user.email)==null?void 0:s.split("@")[0])||"user",avatar_url:null});const o=t.loading("Preparing files...",{duration:0}),g=[],b=[],u=p.filter(ue),S=p.filter(pe);let C=[];if(u.length>0){t.loading(`Compressing ${u.length} image(s)...`,{id:o});const h=await q(u);C=h.map(y=>y.file);const v=h.reduce((y,j)=>y+(j.originalSize-j.compressedSize),0);console.log(`Images compressed: saved ${he(v)}`)}const le=[...C,...S],ne=le.length;let ce=0;t.loading(`Uploading ${ne} file(s)...`,{id:o});const Pe=le.map(async h=>{var me;const v=(me=h.name.split(".").pop())==null?void 0:me.toLowerCase(),y=`${r.user.id}/${Date.now()}-${Math.random().toString(36).substr(2,9)}.${v}`,{error:j}=await f.storage.from("posts").upload(y,h,{cacheControl:"3600",upsert:!1});if(j)throw j;ce++,t.loading(`Uploaded ${ce}/${ne} file(s)...`,{id:o});const{data:I}=f.storage.from("posts").getPublicUrl(y);return{url:I.publicUrl,isVideo:pe(h)}});(await Promise.all(Pe)).forEach(h=>{h.isVideo?b.push(h.url):g.push(h.url)}),t.success("Upload complete!",{id:o});const ke=g.length>1?JSON.stringify(g):g.length===1?g[0]:null,Re=b.length>1?JSON.stringify(b):b.length===1?b[0]:null,de=g[0]||b[0],A={spotify_track_id:(c==null?void 0:c.id)||null,spotify_track_name:(c==null?void 0:c.name)||null,spotify_artist_name:((n=(a=c==null?void 0:c.artists)==null?void 0:a[0])==null?void 0:n.name)||null,spotify_album_art:((m=(i=(l=c==null?void 0:c.album)==null?void 0:l.images)==null?void 0:i[0])==null?void 0:m.url)||null,spotify_preview_url:(c==null?void 0:c.preview_url)||null};if(x==="daily"){const h={user_id:r.user.id,media_url:de,media_type:$==="image"?"photo":"video",caption:N.trim()||null,duration:$==="video"?Z:null,...A},{error:v}=await f.from("dailies").insert(h);if(v)throw v;await f.from("posts").insert({user_id:r.user.id,title:"Daily",caption:N.trim()||null,[$==="image"?"image_url":"video_url"]:de,...A}),t.success("Daily posted successfully!")}else{let h=z?`${window.location.origin}/#recipe/${z}`:null;const v={user_id:r.user.id,title:U.trim(),caption:N.trim()||null,recipe_url:h,image_url:ke,video_url:Re,...A},{data:y,error:j}=await f.from("posts").insert(v).select().single();if(j)throw j;const I=Te(N);I.length>0&&y&&await f.rpc("process_post_hashtags",{p_post_id:y.id,p_hashtags:I}),t.success("Post uploaded successfully!")}re(),G(""),J(""),K(""),O(null),window.history.replaceState({},"","/discover"),k("discover")}catch(r){console.error("Upload error:",r),t.error(r.message||"Failed to upload")}finally{Q(!1)}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 md:bg-transparent md:relative",children:e.jsxs("div",{className:"absolute inset-x-0 bottom-0 md:relative md:inset-auto bg-gray-50 md:min-h-screen overflow-hidden md:overflow-visible rounded-t-3xl md:rounded-none shadow-2xl md:shadow-none pb-safe",style:{maxHeight:window.innerWidth>=768?"none":"90vh",paddingBottom:"max(10rem, env(safe-area-inset-bottom))"},children:[e.jsx("div",{className:"flex md:hidden items-center justify-center pt-3 pb-2 bg-white",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-300 rounded-full"})}),e.jsx("div",{className:"sticky top-0 bg-white border-b border-gray-200 z-20",style:{paddingTop:"env(safe-area-inset-top)"},children:e.jsxs("div",{className:"max-w-lg mx-auto px-4 h-14 flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),k("discover")},className:"text-gray-600 hover:text-gray-900 font-medium active:scale-95 transition-transform",children:"Cancel"}),e.jsxs("h1",{className:"text-lg font-semibold",children:["New ",x==="daily"?"Daily":"Post"]}),e.jsx("div",{className:"w-16"})]})}),e.jsxs("div",{className:"overflow-y-auto max-h-[calc(90vh-4rem)] md:overflow-visible md:max-h-none overscroll-contain",children:[e.jsxs("div",{className:"max-w-lg mx-auto p-4 space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-sm",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:"Post Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>H("post"),className:`flex-1 py-3 px-4 rounded-lg font-medium transition-colors ${x==="post"?"bg-gradient-to-r from-orange-600 to-red-600 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:"Post"}),e.jsx("button",{onClick:()=>H("daily"),className:`flex-1 py-3 px-4 rounded-lg font-medium transition-colors ${x==="daily"?"bg-gradient-to-r from-purple-600 to-pink-600 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:"Daily"})]}),x==="daily"&&e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Dailies expire after 24 hours. Videos must be 30 seconds or less."})]}),_.length===0?e.jsxs("div",{className:"space-y-3",children:[P.isNativePlatform()&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{type:"button",onClick:we,className:"border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-orange-500 transition-colors",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-2xl shadow-lg mx-auto",children:e.jsx(Fe,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Take Photo"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Use camera"})]})]})}),e.jsx("button",{type:"button",onClick:Ne,className:"border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-orange-500 transition-colors",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl shadow-lg mx-auto",children:e.jsx(W,{className:"w-8 h-8 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"From Gallery"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Choose photo"})]})]})})]}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-xl p-8 sm:p-12 text-center hover:border-orange-500 transition-colors cursor-pointer",children:e.jsxs("label",{className:"cursor-pointer",children:[e.jsx("input",{type:"file",accept:"image/*,video/*",multiple:!0,onChange:je,className:"hidden"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-3 sm:gap-4 justify-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl shadow-lg",children:e.jsx(W,{className:"w-8 h-8 sm:w-10 sm:h-10 text-white"})}),e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl shadow-lg",children:e.jsx($e,{className:"w-8 h-8 sm:w-10 sm:h-10 text-white"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-base sm:text-lg font-semibold text-gray-900 mb-1",children:P.isNativePlatform()?"Or select files":"Upload a photo or video"}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-500",children:P.isNativePlatform()?"Browse your files":"Click to select a file from your device"})]})]})]})})]}):e.jsxs("div",{className:"space-y-2",children:[_.map((s,a)=>{const n=p[a],l=n==null?void 0:n.type.startsWith("video/");return e.jsxs("div",{className:"relative",children:[l?e.jsx("video",{src:s,controls:!0,className:"w-full aspect-square object-cover rounded-xl"}):e.jsx("img",{src:s,alt:`Preview ${a+1}`,className:"w-full aspect-square object-cover rounded-xl",loading:"lazy",decoding:"async"}),e.jsx("button",{onClick:re,className:"absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white rounded-full p-2",children:e.jsx(T,{className:"w-5 h-5"})})]},a)}),p.length<4&&e.jsxs("label",{className:"cursor-pointer",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:s=>{const a=Array.from(s.target.files||[]),n=4-p.length,l=a.slice(0,n),i=[],m=[];for(const r of l){if(r.size>10*1024*1024){t.error(`${r.name} is too large (max 10MB)`);continue}if(!r.type.startsWith("image/")){t.error(`${r.name} is not an image`);continue}i.push(r),m.push(URL.createObjectURL(r))}i.length>0&&(R([...p,...i]),F([..._,...m]),t.success(`Added ${i.length} image${i.length>1?"s":""}`))},className:"hidden"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-orange-500 transition-colors",children:[e.jsx(W,{className:"w-8 h-8 mx-auto text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Add More Photos"}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[p.length,"/4 selected"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-sm space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Add Music (optional)"}),e.jsxs("button",{onClick:()=>E(!0),className:"text-sm font-medium text-orange-600 hover:text-orange-700 flex items-center gap-1.5",children:[e.jsx(Me,{className:"w-5 h-5"}),c?"Change Music":"Add Music"]})]}),c&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("img",{src:(oe=c.album.images[0])==null?void 0:oe.url,loading:"lazy",decoding:"async",alt:"album",className:"w-12 h-12 rounded object-cover"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:c.name}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:c.artists[0].name})]}),e.jsx("button",{onClick:Se,className:"bg-green-600 hover:bg-green-700 text-white rounded-full p-2 transition-colors",children:B?e.jsx(De,{className:"w-4 h-4"}):e.jsx(Ie,{className:"w-4 h-4 ml-0.5"})}),e.jsx("button",{onClick:()=>O(null),className:"text-red-600",children:e.jsx(T,{className:"w-5 h-5"})}),e.jsx("audio",{ref:D,src:c.preview_url,onEnded:()=>M(!1),onPlay:()=>M(!0),onPause:()=>M(!1)})]})]}),e.jsxs("div",{className:"space-y-4 bg-white rounded-xl p-4 shadow-sm",children:[x==="post"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Title ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:U,onChange:s=>G(s.target.value),placeholder:"Enter a title for your post",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500",maxLength:200}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[U.length,"/200"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Caption"}),e.jsx(ze,{value:N,onChange:s=>J(s.target.value),placeholder:"Write a caption...",className:"min-h-24 resize-none",maxLength:2200}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[N.length,"/2200"]})]}),x==="post"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Link to Recipe (optional)"}),e.jsxs(Ee,{value:z,onValueChange:K,children:[e.jsx(Ve,{children:e.jsx(Oe,{placeholder:"Select a recipe from your collection"})}),e.jsx(Be,{children:X.length===0?e.jsx("div",{className:"p-4 text-center text-sm text-gray-500",children:"No recipes yet. Add some recipes first!"}):X.map(s=>e.jsx(Ae,{value:s.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.image_url&&e.jsx("img",{src:s.image_url,alt:s.title,className:"w-8 h-8 rounded object-cover",loading:"lazy",decoding:"async"}),e.jsx("span",{children:s.title})]})},s.id))})]})]})]}),p.length>0&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Le,{className:"w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-orange-900",children:"Ready to post"}),e.jsxs("p",{className:"text-xs text-orange-700 mt-1 truncate",children:[p.length," image",p.length>1?"s":""," selected"]}),"              "]})]})})]}),e.jsx("div",{className:"fixed left-0 right-0 px-4 pb-6 bg-gradient-to-t from-white via-white to-transparent z-[60] lg:z-10 lg:bottom-0",style:{bottom:"80px",paddingBottom:"max(1.5rem, env(safe-area-inset-bottom))"},children:e.jsx("div",{className:"max-w-lg mx-auto flex justify-center",children:e.jsx(We,{onClick:Ce,disabled:p.length===0||x==="post"&&!U.trim()||Y,className:"px-12 sm:px-16 py-5 sm:py-6 text-base sm:text-lg font-semibold bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 shadow-lg rounded-full",children:Y?"Submitting...":"Submit"})})})]}),fe&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white w-full md:max-w-lg rounded-2xl flex flex-col",style:{maxHeight:"85vh",paddingBottom:"env(safe-area-inset-bottom)"},children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between flex-shrink-0",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Choose Music"}),e.jsx("button",{onClick:()=>E(!1),children:e.jsx(T,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"p-4 flex-shrink-0",children:e.jsx("input",{type:"text",value:ee,onChange:s=>{be(s.target.value),Ue(s.target.value)},placeholder:"Search any song...",className:"w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500",autoFocus:!0})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 pb-4 space-y-2",children:[te&&e.jsx("p",{className:"text-center text-gray-500 py-8",children:"Searching..."}),se.map(s=>{var a;return e.jsxs("button",{onClick:()=>{O(s),E(!1),t.success("Music added!")},className:"w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition text-left",children:[e.jsx("img",{src:((a=s.album.images[0])==null?void 0:a.url)||"/placeholder.png",loading:"lazy",decoding:"async",alt:"album",className:"w-12 h-12 rounded flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:s.name}),e.jsx("p",{className:"text-xs text-gray-600 truncate",children:s.artists.map(n=>n.name).join(", ")})]}),e.jsx("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded flex-shrink-0",children:"30s Preview"})]},s.id)}),ee&&se.length===0&&!te&&e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No tracks found"})]})]})})]})})}export{ls as Upload};
