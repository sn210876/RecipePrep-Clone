import{j as e,C as xe,t as he,v as fe,m as pe,r,J as T,s as $,I as je,B as D,y as w,L as U,f as q,a as ge,Z as X,$ as be}from"./index-JyBq9rLv.js";import{T as Ne,a as ve,b as A,c as F}from"./tabs-CkHK2taX.js";import{C as G}from"./clock-BvjsmAqk.js";import{D as we,r as ye}from"./referralService-Dk4WL2zr.js";import{C as K}from"./circle-check-big-CmjSCXJ7.js";import{C as Q}from"./circle-x-DvndoaL5.js";import{A as ee,a as se,b as ae,E as Pe}from"./avatar-D1NO2EoY.js";import{B}from"./badge-CS5hCRJb.js";import{S as _e,a as Ce,b as Se,c as Te,d as k}from"./select-gEZz8QiH.js";import{S as De}from"./search-DuY4eVPz.js";import{f as M}from"./format-BKaUfGAF.js";import{D as ke,a as Me,b as Ae,c as Fe,d as Re}from"./dialog-cum2fHOB.js";import{T as Z}from"./textarea-RoGjTudR.js";import{S as E}from"./separator-El6l8p9D.js";import{A as qe,a as $e,b as Le,c as Ue,d as Ee,e as Ve,f as Be,g as He}from"./alert-dialog-CzNWkzeS.js";import{E as Ie}from"./external-link-CK9C3IEb.js";import{B as ze}from"./ban-BP5X1M2g.js";import"./index-BaoHEetE.js";import"./index-DDETzXho.js";import"./index-hoBPq4ct.js";import"./react-icons.esm-Dmzb-FaV.js";import"./index-B5V1zg6h.js";import"./index-CRMZdbwC.js";import"./index-BRw_8EMu.js";import"./index-BdQq_4o_.js";import"./index-BImAK-cm.js";import"./index-DUr4xt7P.js";import"./index-Dp6MyVgh.js";import"./en-US-wfBU2YNu.js";import"./index-BFZeJysM.js";function Oe({payouts:s}){const t=s.filter(a=>a.payout_status==="pending"),l=s.filter(a=>a.payout_status==="processing"),d=s.filter(a=>a.payout_status==="paid"),g=s.filter(a=>a.payout_status==="failed"),b=t.reduce((a,n)=>a+n.reward_amount,0);d.reduce((a,n)=>a+n.reward_amount,0);const j=new Date().getMonth(),y=new Date().getFullYear(),u=d.filter(a=>{if(!a.paid_at)return!1;const n=new Date(a.paid_at);return n.getMonth()===j&&n.getFullYear()===y}),C=u.reduce((a,n)=>a+n.reward_amount,0),x=[{title:"Pending Payouts",value:t.length,amount:`$${b.toFixed(2)}`,icon:G,color:"text-yellow-600",bgColor:"bg-yellow-100"},{title:"Processing",value:l.length,amount:`$${l.reduce((a,n)=>a+n.reward_amount,0).toFixed(2)}`,icon:we,color:"text-blue-600",bgColor:"bg-blue-100"},{title:"Paid This Month",value:u.length,amount:`$${C.toFixed(2)}`,icon:K,color:"text-green-600",bgColor:"bg-green-100"},{title:"Failed",value:g.length,amount:`$${g.reduce((a,n)=>a+n.reward_amount,0).toFixed(2)}`,icon:Q,color:"text-red-600",bgColor:"bg-red-100"}];return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:x.map(a=>e.jsxs(xe,{children:[e.jsxs(he,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(fe,{className:"text-sm font-medium",children:a.title}),e.jsx("div",{className:`p-2 rounded-full ${a.bgColor}`,children:e.jsx(a.icon,{className:`h-4 w-4 ${a.color}`})})]}),e.jsxs(pe,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a.value}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:a.amount})]})]},a.title))})}const te=r.forwardRef(({className:s,...t},l)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:l,className:T("w-full caption-bottom text-sm",s),...t})}));te.displayName="Table";const re=r.forwardRef(({className:s,...t},l)=>e.jsx("thead",{ref:l,className:T("[&_tr]:border-b",s),...t}));re.displayName="TableHeader";const le=r.forwardRef(({className:s,...t},l)=>e.jsx("tbody",{ref:l,className:T("[&_tr:last-child]:border-0",s),...t}));le.displayName="TableBody";const Ye=r.forwardRef(({className:s,...t},l)=>e.jsx("tfoot",{ref:l,className:T("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",s),...t}));Ye.displayName="TableFooter";const V=r.forwardRef(({className:s,...t},l)=>e.jsx("tr",{ref:l,className:T("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",s),...t}));V.displayName="TableRow";const S=r.forwardRef(({className:s,...t},l)=>e.jsx("th",{ref:l,className:T("h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",s),...t}));S.displayName="TableHead";const _=r.forwardRef(({className:s,...t},l)=>e.jsx("td",{ref:l,className:T("p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",s),...t}));_.displayName="TableCell";const We=r.forwardRef(({className:s,...t},l)=>e.jsx("caption",{ref:l,className:T("mt-4 text-sm text-muted-foreground",s),...t}));We.displayName="TableCaption";function R({payouts:s,onViewDetails:t,filterStatus:l="all"}){const[d,g]=r.useState(""),[b,j]=r.useState(l),[y,u]=r.useState([]),[C,x]=r.useState(!0);r.useEffect(()=>{a()},[s]),r.useEffect(()=>{j(l)},[l]);const a=async()=>{x(!0);const i=[...new Set(s.map(o=>o.user_id))],{data:h}=await $.from("profiles").select("id, username, email, photo_url").in("id",i),f=new Map((h==null?void 0:h.map(o=>[o.id,o]))||[]),p=s.map(o=>({...o,profile:f.get(o.user_id)||{id:o.user_id,username:"Unknown",email:""}}));u(p),x(!1)},n=y.filter(i=>{var p,o,N,c,v;const h=b==="all"||i.payout_status===b,f=!d||((o=(p=i.profile)==null?void 0:p.username)==null?void 0:o.toLowerCase().includes(d.toLowerCase()))||((c=(N=i.profile)==null?void 0:N.email)==null?void 0:c.toLowerCase().includes(d.toLowerCase()))||((v=i.payout_method)==null?void 0:v.toLowerCase().includes(d.toLowerCase()));return h&&f}),P=i=>{const h={pending:{variant:"secondary",label:"Pending"},processing:{variant:"default",label:"Processing"},paid:{variant:"default",label:"Paid"},failed:{variant:"destructive",label:"Failed"},cancelled:{variant:"outline",label:"Cancelled"}},f=h[i]||h.pending;return e.jsx(B,{variant:f.variant,className:i==="paid"?"bg-green-600 hover:bg-green-700":i==="processing"?"bg-blue-600 hover:bg-blue-700":"",children:f.label})};return C?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(De,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(je,{placeholder:"Search by username, email, or payment method...",value:d,onChange:i=>g(i.target.value),className:"pl-10"})]}),e.jsxs(_e,{value:b,onValueChange:j,children:[e.jsx(Ce,{className:"w-full sm:w-[180px]",children:e.jsx(Se,{placeholder:"Filter by status"})}),e.jsxs(Te,{children:[e.jsx(k,{value:"all",children:"All Status"}),e.jsx(k,{value:"pending",children:"Pending"}),e.jsx(k,{value:"processing",children:"Processing"}),e.jsx(k,{value:"paid",children:"Paid"}),e.jsx(k,{value:"failed",children:"Failed"}),e.jsx(k,{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(te,{children:[e.jsx(re,{children:e.jsxs(V,{children:[e.jsx(S,{children:"User"}),e.jsx(S,{children:"Amount"}),e.jsx(S,{children:"Payment Method"}),e.jsx(S,{children:"Payment Details"}),e.jsx(S,{children:"Status"}),e.jsx(S,{children:"Requested"}),e.jsx(S,{className:"text-right",children:"Actions"})]})}),e.jsx(le,{children:n.length===0?e.jsx(V,{children:e.jsx(_,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:"No payout requests found"})}):n.map(i=>{var h,f,p,o,N;return e.jsxs(V,{children:[e.jsx(_,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ee,{className:"h-8 w-8",children:[e.jsx(se,{src:(h=i.profile)==null?void 0:h.photo_url}),e.jsx(ae,{children:((p=(f=i.profile)==null?void 0:f.username)==null?void 0:p.substring(0,2).toUpperCase())||"U"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:((o=i.profile)==null?void 0:o.username)||"Unknown"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:((N=i.profile)==null?void 0:N.email)||"No email"})]})]})}),e.jsxs(_,{className:"font-semibold",children:["$",i.reward_amount.toFixed(2)]}),e.jsx(_,{className:"capitalize",children:i.payout_method||"N/A"}),e.jsx(_,{className:"max-w-[200px] truncate",children:i.payout_email||"N/A"}),e.jsx(_,{children:P(i.payout_status)}),e.jsx(_,{children:M(new Date(i.requested_at),"MMM d, yyyy")}),e.jsx(_,{className:"text-right",children:e.jsxs(D,{variant:"ghost",size:"sm",onClick:()=>t(i),children:[e.jsx(Pe,{className:"h-4 w-4 mr-1"}),"View"]})})]},i.id)})})]})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",n.length," of ",y.length," payout requests"]})]})}function Je({payout:s,open:t,onClose:l,onSuccess:d}){var I,z,O,Y,W,J;const[g,b]=r.useState(""),[j,y]=r.useState(""),[u,C]=r.useState(!1),[x,a]=r.useState(null),[n,P]=r.useState([]),[i,h]=r.useState(!1),[f,p]=r.useState([]);r.useEffect(()=>{s&&t&&(b(s.admin_notes||""),y(s.failure_reason||""),o(),N())},[s,t]);const o=async()=>{if(!s)return;h(!0);const{data:m,error:L}=await $.from("referrals").select("*").eq("referrer_id",s.user_id).eq("status","completed").eq("reward_granted",!0).order("completed_at",{ascending:!1}).limit(10);!L&&m&&P(m),h(!1)},N=async()=>{if(!s)return;const{data:m}=await $.from("referral_rewards").select("*").eq("user_id",s.user_id).neq("id",s.id).order("requested_at",{ascending:!1}).limit(5);m&&p(m)},c=async m=>{if(!s)return;C(!0);const L=await ye.adminProcessPayout(s.id,m,g||void 0,m==="failed"&&j||void 0);C(!1),L.success?(q.success(`Payout ${m} successfully`),d(),l()):q.error(`Failed to process payout: ${L.error}`)},v=()=>{a({action:"processing",title:"Mark as Processing",description:"This will mark the payout as being processed. Continue?"})},ie=()=>{a({action:"paid",title:"Mark as Paid",description:"This will mark the payout as completed and paid. Make sure payment has been sent. Continue?"})},ne=()=>{if(!j.trim()){q.error("Please provide a failure reason");return}a({action:"failed",title:"Mark as Failed",description:"This will mark the payout as failed. The user will be notified. Continue?"})},oe=()=>{a({action:"cancelled",title:"Cancel Payout",description:"This will cancel the payout request. This action cannot be undone. Continue?"})},de=async()=>{x&&(await c(x.action),a(null))};if(!s)return null;const ce=s.payout_status==="pending",me=s.payout_status==="pending"||s.payout_status==="processing",H=s.payout_status==="pending"||s.payout_status==="processing",ue=s.payout_status==="pending";return e.jsxs(e.Fragment,{children:[e.jsx(ke,{open:t,onOpenChange:l,children:e.jsxs(Me,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ae,{children:[e.jsx(Fe,{children:"Payout Request Details"}),e.jsx(Re,{children:"Review and process this payout request"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs(ee,{className:"h-16 w-16",children:[e.jsx(se,{src:(I=s.profile)==null?void 0:I.photo_url}),e.jsx(ae,{className:"text-lg",children:((O=(z=s.profile)==null?void 0:z.username)==null?void 0:O.substring(0,2).toUpperCase())||"U"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold",children:((Y=s.profile)==null?void 0:Y.username)||"Unknown User"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:((W=s.profile)==null?void 0:W.email)||"No email"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Member since ",(J=s.profile)!=null&&J.created_at?M(new Date(s.profile.created_at),"MMM d, yyyy"):"Unknown"]}),e.jsxs(D,{variant:"link",size:"sm",className:"p-0 h-auto mt-1",onClick:()=>window.open(`/profile/${s.user_id}`,"_blank"),children:["View Profile ",e.jsx(Ie,{className:"h-3 w-3 ml-1"})]})]}),e.jsx(B,{variant:s.payout_status==="paid"||s.payout_status==="processing"?"default":s.payout_status==="failed"?"destructive":"secondary",className:s.payout_status==="paid"?"bg-green-600":s.payout_status==="processing"?"bg-blue-600":"",children:s.payout_status})]}),e.jsx(E,{}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Amount"}),e.jsxs("p",{className:"text-2xl font-bold",children:["$",s.reward_amount.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Referral Count"}),e.jsx("p",{className:"text-2xl font-bold",children:s.referral_count})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Payment Method"}),e.jsx("p",{className:"font-medium capitalize",children:s.payout_method||"Not specified"})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Payment Details"}),e.jsx("p",{className:"font-medium",children:s.payout_email||"Not provided"})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Requested At"}),e.jsx("p",{className:"text-sm",children:M(new Date(s.requested_at),"PPpp")})]}),s.processed_at&&e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Processed At"}),e.jsx("p",{className:"text-sm",children:M(new Date(s.processed_at),"PPpp")})]}),s.paid_at&&e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground",children:"Paid At"}),e.jsx("p",{className:"text-sm",children:M(new Date(s.paid_at),"PPpp")})]})]}),f.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(E,{}),e.jsxs("div",{children:[e.jsx(w,{className:"text-muted-foreground mb-2 block",children:"Previous Payouts"}),e.jsx("div",{className:"space-y-2",children:f.map(m=>e.jsxs("div",{className:"flex items-center justify-between text-sm p-2 bg-muted rounded",children:[e.jsxs("span",{children:["$",m.reward_amount.toFixed(2)]}),e.jsx(B,{variant:"outline",children:m.payout_status}),e.jsx("span",{className:"text-muted-foreground",children:M(new Date(m.requested_at),"MMM d, yyyy")})]},m.id))})]})]}),e.jsx(E,{}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"admin-notes",children:"Admin Notes"}),e.jsx(Z,{id:"admin-notes",placeholder:"Add notes about this payout (optional)",value:g,onChange:m=>b(m.target.value),rows:3,className:"mt-2"})]}),(H||s.payout_status==="failed")&&e.jsxs("div",{children:[e.jsx(w,{htmlFor:"failure-reason",children:"Failure Reason"}),e.jsx(Z,{id:"failure-reason",placeholder:"Required if marking as failed",value:j,onChange:m=>y(m.target.value),rows:2,className:"mt-2"})]}),e.jsx(E,{}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[ce&&e.jsxs(D,{onClick:v,disabled:u,variant:"outline",children:[u?e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(G,{className:"h-4 w-4 mr-2"}),"Mark as Processing"]}),me&&e.jsxs(D,{onClick:ie,disabled:u,className:"bg-green-600 hover:bg-green-700",children:[u?e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(K,{className:"h-4 w-4 mr-2"}),"Mark as Paid"]}),H&&e.jsxs(D,{onClick:ne,disabled:u,variant:"destructive",children:[u?e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Mark as Failed"]}),ue&&e.jsxs(D,{onClick:oe,disabled:u,variant:"outline",children:[u?e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Cancel Payout"]})]})]})]})}),e.jsx(qe,{open:!!x,onOpenChange:()=>a(null),children:e.jsxs($e,{children:[e.jsxs(Le,{children:[e.jsx(Ue,{children:x==null?void 0:x.title}),e.jsx(Ee,{children:x==null?void 0:x.description})]}),e.jsxs(Ve,{children:[e.jsx(Be,{children:"Cancel"}),e.jsx(He,{onClick:de,children:"Continue"})]})]})})]})}function _s(){const{isAdmin:s}=ge(),[t,l]=r.useState([]),[d,g]=r.useState(!0),[b,j]=r.useState(null),[y,u]=r.useState(!1),[C,x]=r.useState("pending");r.useEffect(()=>{s&&(a(),n())},[s]);const a=async()=>{g(!0);const{data:c,error:v}=await $.from("referral_rewards").select("*").order("requested_at",{ascending:!1});v?(console.error("Error loading payouts:",v),q.error("Failed to load payouts")):l(c||[]),g(!1)},n=()=>{const c=$.channel("admin-payouts").on("postgres_changes",{event:"*",schema:"public",table:"referral_rewards"},v=>{console.log("Payout changed:",v),v.eventType==="INSERT"&&q.info("New payout request received"),a()}).subscribe();return()=>{c.unsubscribe()}},P=c=>{j(c),u(!0)},i=()=>{u(!1),j(null)},h=()=>{a()};if(!s)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(X,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-muted-foreground",children:"You need admin privileges to view this page."})]})});const f=t.filter(c=>c.payout_status==="pending"),p=t.filter(c=>c.payout_status==="processing"),o=t.filter(c=>c.payout_status==="paid"),N=t.filter(c=>c.payout_status==="failed");return e.jsxs("div",{className:"container mx-auto py-8 px-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(X,{className:"h-8 w-8"}),"Admin Payout Dashboard"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage and process referral payout requests"})]}),e.jsxs(D,{onClick:a,disabled:d,variant:"outline",size:"sm",children:[e.jsx(be,{className:`h-4 w-4 mr-2 ${d?"animate-spin":""}`}),"Refresh"]})]}),e.jsx(Oe,{payouts:t}),e.jsxs(Ne,{value:C,onValueChange:x,className:"space-y-4",children:[e.jsxs(ve,{children:[e.jsxs(A,{value:"pending",children:["Pending (",f.length,")"]}),e.jsxs(A,{value:"processing",children:["Processing (",p.length,")"]}),e.jsxs(A,{value:"paid",children:["Paid (",o.length,")"]}),e.jsxs(A,{value:"failed",children:["Failed (",N.length,")"]}),e.jsxs(A,{value:"all",children:["All (",t.length,")"]})]}),e.jsx(F,{value:"pending",children:d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}):e.jsx(R,{payouts:f,onViewDetails:P,filterStatus:"pending"})}),e.jsx(F,{value:"processing",children:d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}):e.jsx(R,{payouts:p,onViewDetails:P,filterStatus:"processing"})}),e.jsx(F,{value:"paid",children:d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}):e.jsx(R,{payouts:o,onViewDetails:P,filterStatus:"paid"})}),e.jsx(F,{value:"failed",children:d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}):e.jsx(R,{payouts:N,onViewDetails:P,filterStatus:"failed"})}),e.jsx(F,{value:"all",children:d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})}):e.jsx(R,{payouts:t,onViewDetails:P,filterStatus:"all"})})]}),e.jsx(Je,{payout:b,open:y,onClose:i,onSuccess:h})]})}export{_s as default};
