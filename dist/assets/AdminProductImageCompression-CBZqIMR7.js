import{r as g,j as e,a2 as H,J as K,a as X,Z as G,C as y,t as P,v as $,m as _,E as W,B as q,L as J,s as C,f as I}from"./index-RGevgwjF.js";import{i as Y}from"./browser-image-compression-BzWLnoYn.js";import{I as k}from"./image-yQtBVqJu.js";import{C as Z}from"./circle-check-big-VLTMNfKi.js";import{C as Q}from"./circle-x-C-e218rT.js";function ee(r,a=[]){let d=[];function c(x,m){const t=g.createContext(m);t.displayName=x+"Context";const l=d.length;d=[...d,m];const j=w=>{var n;const{scope:v,children:S,...h}=w,s=((n=v==null?void 0:v[r])==null?void 0:n[l])||t,o=g.useMemo(()=>h,Object.values(h));return e.jsx(s.Provider,{value:o,children:S})};j.displayName=x+"Provider";function z(w,v){var s;const S=((s=v==null?void 0:v[r])==null?void 0:s[l])||t,h=g.useContext(S);if(h)return h;if(m!==void 0)return m;throw new Error(`\`${w}\` must be used within \`${x}\``)}return[j,z]}const i=()=>{const x=d.map(m=>g.createContext(m));return function(t){const l=(t==null?void 0:t[r])||x;return g.useMemo(()=>({[`__scope${r}`]:{...t,[r]:l}}),[t,l])}};return i.scopeName=r,[c,se(i,...a)]}function se(...r){const a=r[0];if(r.length===1)return a;const d=()=>{const c=r.map(i=>({useScope:i(),scopeName:i.scopeName}));return function(x){const m=c.reduce((t,{useScope:l,scopeName:j})=>{const w=l(x)[`__scope${j}`];return{...t,...w}},{});return g.useMemo(()=>({[`__scope${a.scopeName}`]:m}),[m])}};return d.scopeName=a.scopeName,d}var re=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],F=re.reduce((r,a)=>{const d=H(`Primitive.${a}`),c=g.forwardRef((i,x)=>{const{asChild:m,...t}=i,l=m?d:a;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(l,{...t,ref:x})});return c.displayName=`Primitive.${a}`,{...r,[a]:c}},{}),E="Progress",O=100,[te]=ee(E),[ae,oe]=te(E),U=g.forwardRef((r,a)=>{const{__scopeProgress:d,value:c=null,max:i,getValueLabel:x=ie,...m}=r;(i||i===0)&&!B(i)&&console.error(ne(`${i}`,"Progress"));const t=B(i)?i:O;c!==null&&!R(c,t)&&console.error(le(`${c}`,"Progress"));const l=R(c,t)?c:null,j=M(l)?x(l,t):void 0;return e.jsx(ae,{scope:d,value:l,max:t,children:e.jsx(F.div,{"aria-valuemax":t,"aria-valuemin":0,"aria-valuenow":M(l)?l:void 0,"aria-valuetext":j,role:"progressbar","data-state":T(l,t),"data-value":l??void 0,"data-max":t,...m,ref:a})})});U.displayName=E;var A="ProgressIndicator",D=g.forwardRef((r,a)=>{const{__scopeProgress:d,...c}=r,i=oe(A,d);return e.jsx(F.div,{"data-state":T(i.value,i.max),"data-value":i.value??void 0,"data-max":i.max,...c,ref:a})});D.displayName=A;function ie(r,a){return`${Math.round(r/a*100)}%`}function T(r,a){return r==null?"indeterminate":r===a?"complete":"loading"}function M(r){return typeof r=="number"}function B(r){return M(r)&&!isNaN(r)&&r>0}function R(r,a){return M(r)&&!isNaN(r)&&r<=a&&r>=0}function ne(r,a){return`Invalid prop \`max\` of value \`${r}\` supplied to \`${a}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${O}\`.`}function le(r,a){return`Invalid prop \`value\` of value \`${r}\` supplied to \`${a}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${O} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var L=U,ce=D;const V=g.forwardRef(({className:r,value:a,...d},c)=>e.jsx(L,{ref:c,className:K("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",r),...d,children:e.jsx(ce,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(a||0)}%)`}})}));V.displayName=L.displayName;function pe(){const{isAdmin:r}=X(),[a,d]=g.useState(!1),[c,i]=g.useState(0),[x,m]=g.useState([]),[t,l]=g.useState({total:0,processed:0,success:0,failed:0,totalOriginalSize:0,totalCompressedSize:0});if(!r)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(G,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-muted-foreground",children:"You need admin privileges to view this page."})]})});async function j(s){const o=await fetch(s);if(!o.ok)throw new Error(`Failed to download image: ${o.statusText}`);return await o.blob()}async function z(s){const o=new File([s],"image.jpg",{type:s.type}),n={maxSizeMB:s.size/1024/1024/4,useWebWorker:!0,maxIteration:10,fileType:s.type,preserveExif:!1};try{return await Y(o,n)}catch(u){throw console.error("Compression error:",u),u}}async function w(s,o){const n=`amazon-products/${o}-${Date.now()}.jpg`,{data:u,error:p}=await C.storage.from("recipe-images").upload(n,s,{contentType:s.type,upsert:!1});if(p)throw new Error(`Upload failed: ${p.message}`);const{data:b}=C.storage.from("recipe-images").getPublicUrl(u.path);return b.publicUrl}async function v(s){const o={productId:s.id,productName:s.product_name,originalUrl:s.image_url,success:!1};try{if(!s.image_url)throw new Error("No image URL");console.log(`Processing: ${s.product_name}`);const n=await j(s.image_url);o.originalSize=n.size,console.log(`Original size: ${(n.size/1024).toFixed(2)} KB`);const u=await z(n);o.compressedSize=u.size;const p=(n.size-u.size)/n.size*100;if(o.savings=p,console.log(`Compressed size: ${(u.size/1024).toFixed(2)} KB (${p.toFixed(1)}% savings)`),u.size>=n.size*.9)return console.log("Skipping - compression not significant"),o.success=!0,o.newUrl=s.image_url,o;const b=await w(u,s.id);o.newUrl=b;const{error:N}=await C.from("amazon_products").update({image_url:b}).eq("id",s.id);if(N)throw new Error(`Database update failed: ${N.message}`);if(s.image_url.includes("supabase"))try{const f=s.image_url.split("/recipe-images/")[1];f&&await C.storage.from("recipe-images").remove([f])}catch(f){console.log("Could not delete old image:",f)}o.success=!0,console.log(`✓ Successfully compressed and updated ${s.product_name}`)}catch(n){console.error(`✗ Failed to process ${s.product_name}:`,n),o.error=n.message,o.success=!1}return o}const S=async()=>{d(!0),i(0),m([]),l({total:0,processed:0,success:0,failed:0,totalOriginalSize:0,totalCompressedSize:0});try{const{data:s,error:o}=await C.from("amazon_products").select("id, product_name, image_url").not("image_url","is",null);if(o)throw o;if(!s||s.length===0){I.error("No products found with images");return}const n=s.length;l(p=>({...p,total:n})),I.info(`Found ${n} products to process`);const u=[];for(let p=0;p<s.length;p++){const b=s[p],N=await v(b);u.push(N),l(f=>({...f,processed:p+1,success:f.success+(N.success?1:0),failed:f.failed+(N.success?0:1),totalOriginalSize:f.totalOriginalSize+(N.originalSize||0),totalCompressedSize:f.totalCompressedSize+(N.compressedSize||0)})),i((p+1)/n*100),m([...u]),await new Promise(f=>setTimeout(f,500))}I.success(`Compression complete! Processed ${n} images`)}catch(s){console.error("Compression process failed:",s),I.error("Compression failed: "+s.message)}finally{d(!1)}},h=s=>{if(s===0)return"0 Bytes";const o=1024,n=["Bytes","KB","MB"],u=Math.floor(Math.log(s)/Math.log(o));return Math.round(s/Math.pow(o,u)*100)/100+" "+n[u]};return e.jsxs("div",{className:"container mx-auto py-8 px-4 max-w-6xl",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(k,{className:"h-8 w-8"}),"Amazon Product Image Compression"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Compress product catalog images by ~75% while maintaining dimensions"})]}),e.jsxs("div",{className:"grid gap-6",children:[e.jsxs(y,{children:[e.jsx(P,{children:e.jsx($,{children:"Compression Settings"})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-semibold mb-2 flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5 text-blue-600"}),"How it works"]}),e.jsxs("ul",{className:"text-sm space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• Downloads each product image"}),e.jsx("li",{children:"• Compresses to ~75% smaller file size"}),e.jsx("li",{children:"• Maintains original width and height"}),e.jsx("li",{children:"• Uploads to Supabase storage"}),e.jsx("li",{children:"• Updates database with new URLs"}),e.jsx("li",{children:"• Deletes old images from storage"})]})]}),e.jsx(q,{onClick:S,disabled:a,size:"lg",className:"w-full",children:a?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"mr-2 h-4 w-4 animate-spin"}),"Compressing Images..."]}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"mr-2 h-4 w-4"}),"Start Compression"]})})]})]}),a&&e.jsxs(y,{children:[e.jsx(P,{children:e.jsx($,{children:"Progress"})}),e.jsxs(_,{className:"space-y-4",children:[e.jsx(V,{value:c,className:"w-full"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.processed}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Processed"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:t.success}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Success"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:t.failed}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Failed"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[Math.round(c),"%"]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Complete"})]})]})]})]}),t.processed>0&&e.jsxs(y,{children:[e.jsx(P,{children:e.jsx($,{children:"Storage Savings"})}),e.jsx(_,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-gray-50 dark:bg-gray-900 rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Original Size"}),e.jsx("div",{className:"text-2xl font-bold",children:h(t.totalOriginalSize)})]}),e.jsxs("div",{className:"text-center p-4 bg-green-50 dark:bg-green-950 rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Compressed Size"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:h(t.totalCompressedSize)})]}),e.jsxs("div",{className:"text-center p-4 bg-blue-50 dark:bg-blue-950 rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Total Savings"}),e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[t.totalOriginalSize>0?Math.round((t.totalOriginalSize-t.totalCompressedSize)/t.totalOriginalSize*100):0,"%"]})]})]})})]}),x.length>0&&e.jsxs(y,{children:[e.jsx(P,{children:e.jsxs($,{children:["Results (",x.length,")"]})}),e.jsx(_,{children:e.jsx("div",{className:"space-y-2 max-h-[500px] overflow-y-auto",children:x.map(s=>{var o;return e.jsx("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[s.success?e.jsx(Z,{className:"h-5 w-5 text-green-600 flex-shrink-0"}):e.jsx(Q,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:s.productName}),s.error&&e.jsx("div",{className:"text-sm text-red-600 truncate",children:s.error}),s.originalSize&&s.compressedSize&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[h(s.originalSize)," → ",h(s.compressedSize)," ","(",(o=s.savings)==null?void 0:o.toFixed(1),"% savings)"]})]})]})},s.productId)})})})]})]})]})}export{pe as default};
