const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CW8L4bB6.js","assets/index-DYGrGf0R.css"])))=>i.map(i=>d[i]);
import{c as Ae,r as m,j as e,B as V,h as os,s as c,f as k,P as Ye,a as Es,_ as Ms,X as es}from"./index-CW8L4bB6.js";import{m as Ps}from"./hashtags-DrgQ9Rs2.js";import{C as ls}from"./CommentModal-G0K_psNe.js";import{R as Ds}from"./RecipeDetailModal-B3ilGgNt.js";import{C as Le,P as is,a as Ls}from"./PostLightbox-BI4wA8_l.js";import{D as Te,a as Ue,b as $e,c as Fe}from"./dialog-CaISh0_x.js";import{A as ss}from"./arrow-left-BJulsvlZ.js";import{S as qe}from"./send-DF-fzPFJ.js";import{H as ns}from"./heart-X2JZeEsh.js";import{T as Ke}from"./trash-2-CyWUO_Yr.js";import{D as qs,a as Ts,b as Us,c as ts}from"./dropdown-menu-EeDLPGpt.js";import{A as $s,a as Fs,b as As,c as zs,d as Is,e as Bs,f as Rs,g as Os}from"./alert-dialog-B3PzfpTk.js";import{T as Hs}from"./textarea-CrgtQUpX.js";import{S as Vs}from"./search-Um1noaow.js";import{E as Ws}from"./ellipsis-vertical-CzE7m4q-.js";import{E as Js}from"./external-link-D7l8Ysa1.js";import{C as as}from"./check-BERLdb81.js";import{C as Xs}from"./copy-DzOkUav3.js";import"./chevron-right-FdUzPAeO.js";import"./play-CRGnbr43.js";import"./badge-CCbSzKAZ.js";import"./separator-BobuXH8M.js";import"./checkbox--KyWWxqD.js";import"./index-jXP5tAhI.js";import"./react-icons.esm-yaV6Bvoj.js";import"./index-Dos5rrrf.js";import"./index-o213BMLK.js";import"./index-B-aFWGSQ.js";import"./index-CMpv38SS.js";import"./volume-2-55irNRP0.js";import"./users-Bj-rogA-.js";import"./minus-DOpcOxIS.js";import"./circle-check-FIgyQpiE.js";import"./clock-Eck8d3xq.js";import"./circle-play-DxQYCZLF.js";import"./index-CwG-koAv.js";import"./index-DRuSg55n.js";import"./index-DO0wffCS.js";import"./index-CwkIMqiz.js";import"./index-CjfMKqIt.js";/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=Ae("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ks=Ae("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qs=Ae("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]);/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gs=Ae("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);function Zs({userId:x,currentUserId:v,posts:M,isFollowing:L,onBack:ae,onToggleFollow:W,onMessage:F,onRefresh:J}){var ge,oe;const z=M.filter(r=>r.user_id===x),[C,ke]=m.useState(null),[re,R]=m.useState(null),[w,we]=m.useState(new Set),[G,X]=m.useState(null),[ce,ze]=m.useState(0),[de,ve]=m.useState(0),[g,A]=m.useState(!1),[Se,ue]=m.useState(!1),[ye,be]=m.useState([]),[me,Ce]=m.useState([]),[je,he]=m.useState(null);m.useEffect(()=>{const r=async()=>{const{data:_}=await c.from("profiles").select("username, avatar_url, bio, banner_url").eq("id",x).maybeSingle();_&&ke(_)},N=async()=>{const{count:_}=await c.from("follows").select("*",{count:"exact",head:!0}).eq("following_id",x),{count:q}=await c.from("follows").select("*",{count:"exact",head:!0}).eq("follower_id",x);ze(_||0),ve(q||0)},j=async()=>{if(!v)return;const{data:_}=await c.from("likes").select("post_id").eq("user_id",v).in("post_id",z.map(q=>q.id));_&&we(new Set(_.map(q=>q.post_id)))};r(),N(),j()},[x,v,z.length]);const fe=async()=>{const{data:r}=await c.from("follows").select("follower_id, profiles:follower_id(id, username, avatar_url)").eq("following_id",x);be(r||[]),A(!0)},pe=async()=>{const{data:r}=await c.from("follows").select("following_id, profiles:following_id(id, username, avatar_url)").eq("follower_id",x);Ce(r||[]),ue(!0)},Ie=async r=>{if(!v)return;const{error:N}=await c.from("comments").delete().eq("id",r).eq("user_id",v);N?k.error("Failed to delete comment"):(k.success("Comment deleted"),J&&J())},Z=async r=>{if(!v)return;const N=w.has(r);try{if(N)await c.from("likes").delete().match({post_id:r,user_id:v}),we(j=>{const _=new Set(j);return _.delete(r),_});else{await c.from("likes").insert({post_id:r,user_id:v});const j=z.find(_=>_.id===r);j&&j.user_id!==v&&await c.from("notifications").insert({user_id:j.user_id,actor_id:v,type:"like",post_id:r}),we(_=>new Set(_).add(r))}}catch(j){console.error("Error toggling like:",j),k.error("Failed to update like")}};return e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-20",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 px-4 py-3 shadow-sm",children:e.jsxs(V,{onClick:ae,variant:"ghost",className:"min-h-[44px] gap-2 touch-manipulation active:scale-95 transition-all",children:[e.jsx(ss,{className:"w-5 h-5"}),"Back to Feed"]})}),e.jsxs("div",{className:"bg-white border-b border-gray-200",children:[e.jsx("div",{className:"relative h-32",children:C!=null&&C.banner_url?e.jsx("img",{src:C.banner_url,alt:"Banner",className:"w-full h-full object-cover",loading:"lazy"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-orange-100 to-amber-100"})}),e.jsxs("div",{className:"relative px-4 pb-3",children:[e.jsxs("div",{className:"flex items-start gap-3 -mt-10",children:[e.jsx("div",{className:"relative flex-shrink-0",children:C!=null&&C.avatar_url?e.jsx("img",{src:C.avatar_url,alt:C.username,className:"w-20 h-20 rounded-full object-cover border-4 border-white shadow-lg"}):e.jsx("div",{className:"w-20 h-20 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white text-2xl font-bold border-4 border-white shadow-lg",children:(oe=(ge=C==null?void 0:C.username)==null?void 0:ge[0])==null?void 0:oe.toUpperCase()})}),e.jsx("div",{className:"flex-1 pt-10 min-w-0",children:C!=null&&C.bio?e.jsx("p",{className:"text-sm text-gray-700 line-clamp-2 break-words",children:C.bio}):e.jsx("p",{className:"text-sm text-gray-400 italic",children:"No bio"})})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 truncate",children:(C==null?void 0:C.username)||"Loading..."}),x==="51ad04fa-6d63-4c45-9423-76183eea7b39"&&e.jsx(Le,{className:"w-5 h-5 text-yellow-500 fill-yellow-500 flex-shrink-0"})]}),x!==v&&e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs(V,{onClick:()=>{F&&C&&F(x,C.username)},variant:"outline",size:"sm",className:"flex-1 min-h-[44px] touch-manipulation active:scale-95 transition-all",children:[e.jsx(qe,{className:"w-4 h-4 mr-2 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:"Message"})]}),e.jsx(V,{onClick:()=>W(x),variant:L?"outline":"default",size:"sm",className:`flex-1 min-h-[44px] touch-manipulation active:scale-95 transition-all ${L?"":"bg-orange-500 hover:bg-orange-600"}`,children:L?e.jsxs(e.Fragment,{children:[e.jsx(Qs,{className:"w-4 h-4 mr-2 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:"Supporting"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Gs,{className:"w-4 h-4 mr-2 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:"Support"})]})})]})]}),e.jsx("div",{className:"px-4 py-3 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-center gap-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-base font-bold",children:z.length}),e.jsx("div",{className:"text-xs text-gray-500",children:"posts"})]}),e.jsxs("button",{onClick:fe,className:"text-center hover:bg-gray-50 px-3 py-1 rounded-lg transition-colors min-h-[44px] touch-manipulation active:scale-95",children:[e.jsx("div",{className:"text-base font-bold",children:ce}),e.jsx("div",{className:"text-xs text-gray-500",children:"supporters"})]}),e.jsxs("button",{onClick:pe,className:"text-center hover:bg-gray-50 px-3 py-1 rounded-lg transition-colors min-h-[44px] touch-manipulation active:scale-95",children:[e.jsx("div",{className:"text-base font-bold",children:de}),e.jsx("div",{className:"text-xs text-gray-500",children:"supporting"})]})]})})]}),e.jsx("div",{className:"p-4",children:z.length===0?e.jsx("div",{className:"text-center py-12 text-gray-500",children:"No posts yet"}):e.jsx("div",{className:"space-y-4",children:z.map(r=>{var j,_,q;const N=w.has(r.id);return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"relative",children:[(()=>{const D=[],U=[];if(r.image_url)try{const Y=JSON.parse(r.image_url);Array.isArray(Y)?Y.forEach(I=>{D.push(I),U.push("image")}):(D.push(Y),U.push("image"))}catch{D.push(r.image_url),U.push("image")}r.video_url&&(D.push(r.video_url),U.push("video"));const le=D[0];return U[0]==="video"?e.jsx("video",{src:le,controls:!0,className:"w-full aspect-square object-cover"}):e.jsx("img",{src:le,alt:r.title||"Post",className:"w-full aspect-square object-cover cursor-pointer",loading:"lazy",onClick:()=>{X({media:D.map((Y,I)=>({url:Y,type:U[I]})),initialIndex:0,postId:r.id})}})})(),r.title&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent px-3 py-2",children:e.jsx("h3",{className:"text-white text-sm font-semibold line-clamp-2",children:r.title})})]}),e.jsxs("div",{className:"p-3",children:[e.jsxs("div",{className:"flex gap-4 mb-2",children:[e.jsx("button",{onClick:()=>Z(r.id),className:"transition-transform hover:scale-110 active:scale-95 min-h-[44px] min-w-[44px] flex items-center justify-center -ml-2 touch-manipulation",children:e.jsx(ns,{className:`w-6 h-6 ${N?"fill-red-500 text-red-500":"text-gray-600"}`})}),e.jsx("button",{onClick:()=>R(r.id),className:"transition-transform hover:scale-110 active:scale-95 min-h-[44px] min-w-[44px] flex items-center justify-center -ml-2 touch-manipulation",children:e.jsx(os,{className:"w-6 h-6 text-gray-600"})})]}),e.jsxs("div",{className:"text-sm text-gray-600 mb-2",children:[((j=r._count)==null?void 0:j.likes)||0," ",((_=r._count)==null?void 0:_.likes)===1?"like":"likes"]}),r.caption&&e.jsx("p",{className:"text-sm leading-relaxed break-words",children:r.caption}),r.latest_comment&&e.jsxs("div",{className:"mt-3 relative",onTouchStart:()=>{var D;return((D=r.latest_comment)==null?void 0:D.user_id)===v&&he(r.latest_comment.id)},onTouchEnd:()=>setTimeout(()=>he(null),3e3),children:[e.jsxs("div",{className:"flex items-start gap-2 pr-10",children:[e.jsx("span",{className:"font-semibold text-sm flex-shrink-0",children:(q=r.latest_comment.profiles)==null?void 0:q.username}),e.jsx("span",{className:"text-sm text-gray-700 break-words",children:r.latest_comment.text})]}),r.latest_comment.user_id===v&&je===r.latest_comment.id&&e.jsx("button",{onClick:D=>{D.stopPropagation(),Ie(r.latest_comment.id)},className:"absolute top-0 right-0 w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 active:scale-90 z-10 touch-manipulation",title:"Delete comment",children:e.jsx(Ke,{className:"w-4 h-4"})})]}),r._count&&r._count.comments>0&&e.jsxs("button",{onClick:()=>R(r.id),className:"text-sm text-gray-500 mt-2 hover:text-gray-700 block min-h-[36px] touch-manipulation",children:["View all ",r._count.comments," ",r._count.comments===1?"comment":"comments"]})]})]},r.id)})})}),re&&(()=>{const r=z.find(j=>j.id===re),N=r&&v&&v===r.user_id;return r?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden",children:[e.jsx(ls,{postId:re,isOpen:!0,onClose:()=>R(null)}),e.jsx("button",{onClick:()=>R(null),className:"absolute top-3 left-3 bg-black/50 backdrop-blur-md text-white p-2.5 rounded-full shadow hover:bg-black/70 z-[100] min-h-[44px] min-w-[44px] touch-manipulation active:scale-95",title:"Close",children:e.jsx(ss,{className:"w-5 h-5"})}),N&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{const j=prompt("Edit your caption:");j&&c.from("posts").update({caption:j}).eq("id",re).eq("user_id",v).then(({error:_})=>{_?k.error("Failed to update post"):(k.success("Post updated"),J&&J())})},className:"absolute top-3 right-14 bg-blue-600 text-white p-2.5 rounded-full shadow hover:bg-blue-700 z-[100] min-h-[44px] min-w-[44px] touch-manipulation active:scale-95",title:"Edit post",children:"âœï¸"}),e.jsx("button",{onClick:async()=>{if(!confirm("Delete this post?"))return;const{error:j}=await c.from("posts").delete().eq("id",re);j?(console.error("Delete error:",j),k.error("Failed to delete post")):(k.success("Post deleted"),R(null),J&&J())},className:"absolute top-3 right-3 bg-red-600 text-white p-2.5 rounded-full shadow hover:bg-red-700 z-[100] min-h-[44px] min-w-[44px] touch-manipulation active:scale-95",title:"Delete post",children:e.jsx(Ke,{className:"w-5 h-5"})})]})]})}):null})(),e.jsx(Te,{open:g,onOpenChange:A,children:e.jsxs(Ue,{className:"max-w-sm",style:{pointerEvents:"auto"},onPointerDown:r=>r.stopPropagation(),children:[e.jsx($e,{children:e.jsx(Fe,{children:"Supporters"})}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",style:{pointerEvents:"auto"},children:ye.length===0?e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No supporters yet"}):ye.map(r=>{var _,q,D;const N=(_=r.profiles)==null?void 0:_.username,j=(q=r.profiles)==null?void 0:q.avatar_url;return e.jsxs("div",{onPointerDown:U=>{U.stopPropagation(),console.log("CLICK DETECTED - Supporter:",N),A(!1),window.location.href=`/${N}`},className:"flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors select-none",style:{pointerEvents:"auto",touchAction:"manipulation",userSelect:"none"},children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-bold flex-shrink-0 overflow-hidden pointer-events-none",children:j?e.jsx("img",{src:j,alt:N,className:"w-full h-full object-cover pointer-events-none",draggable:!1}):((D=N==null?void 0:N[0])==null?void 0:D.toUpperCase())||e.jsx(Ye,{className:"w-5 h-5"})}),e.jsx("span",{className:"font-medium truncate pointer-events-none",children:N||"User"})]},r.follower_id)})})]})}),e.jsx(Te,{open:Se,onOpenChange:ue,children:e.jsxs(Ue,{className:"max-w-sm",style:{pointerEvents:"auto"},onPointerDown:r=>r.stopPropagation(),children:[e.jsx($e,{children:e.jsx(Fe,{children:"Supporting"})}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",style:{pointerEvents:"auto"},children:me.length===0?e.jsx("p",{className:"text-center text-gray-500 py-8",children:"Not supporting anyone yet"}):me.map(r=>{var _,q,D;const N=(_=r.profiles)==null?void 0:_.username,j=(q=r.profiles)==null?void 0:q.avatar_url;return e.jsxs("div",{onPointerDown:U=>{U.stopPropagation(),console.log("CLICK DETECTED - Following:",N),ue(!1),window.location.href=`/${N}`},className:"flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors select-none",style:{pointerEvents:"auto",touchAction:"manipulation",userSelect:"none"},children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-bold flex-shrink-0 overflow-hidden pointer-events-none",children:j?e.jsx("img",{src:j,alt:N,className:"w-full h-full object-cover pointer-events-none",draggable:!1}):((D=N==null?void 0:N[0])==null?void 0:D.toUpperCase())||e.jsx(Ye,{className:"w-5 h-5"})}),e.jsx("span",{className:"font-medium truncate pointer-events-none",children:N||"User"})]},r.following_id)})})]})}),G&&e.jsx(is,{media:G.media,initialIndex:G.initialIndex,postId:G.postId,open:!!G,onOpenChange:r=>{r||X(null)},onLikeUpdate:()=>{J&&J()}})]})}const rs={async getBlockedUserIds(x){try{const{data:v,error:M}=await c.from("blocked_users").select("blocked_id").eq("blocker_id",x);if(M)throw M;return(v==null?void 0:v.map(L=>L.blocked_id))||[]}catch(v){return console.error("Error fetching blocked users:",v),[]}},async getUsersWhoBlockedMe(x){try{const{data:v,error:M}=await c.from("blocked_users").select("blocker_id").eq("blocked_id",x);if(M)throw M;return(v==null?void 0:v.map(L=>L.blocker_id))||[]}catch(v){return console.error("Error fetching users who blocked me:",v),[]}},async isUserBlocked(x,v){try{const{data:M,error:L}=await c.from("blocked_users").select("id").eq("blocker_id",x).eq("blocked_id",v).maybeSingle();if(L)throw L;return!!M}catch(M){return console.error("Error checking if user is blocked:",M),!1}},async amIBlockedBy(x,v){try{const{data:M,error:L}=await c.from("blocked_users").select("id").eq("blocker_id",v).eq("blocked_id",x).maybeSingle();if(L)throw L;return!!M}catch(M){return console.error("Error checking if blocked by user:",M),!1}},filterBlockedUsers(x,v,M){return x.filter(L=>{const ae=L.user_id||L.id;return ae?!v.includes(ae)&&!M.includes(ae):!0})}},De=x=>x?x.includes("/functions/v1/image-proxy")||x.includes("supabase.co/storage/v1/object/public/")?x:x.includes("instagram.com")||x.includes("cdninstagram.com")||x.includes("fbcdn.net")?`https://vohvdarghgqskzqjclux.supabase.co/functions/v1/image-proxy?url=${encodeURIComponent(x)}`:(console.log("[Discover] VITE_SUPABASE_URL:","https://vohvdarghgqskzqjclux.supabase.co"),x):null;function Rt({onNavigateToMessages:x,onNavigate:v,sharedPostId:M,onPostViewed:L}={}){const{isAdmin:ae}=Es(),[W,F]=m.useState([]),[J,z]=m.useState(!0),[C,ke]=m.useState(0),[re,R]=m.useState(!0),[w,we]=m.useState(null),[G,X]=m.useState(null),[ce,ze]=m.useState({}),[de,ve]=m.useState(null),[g,A]=m.useState(null),[Se,ue]=m.useState(!1),[ye,be]=m.useState(new Set),[me,Ce]=m.useState(null),[je,he]=m.useState(""),[fe,pe]=m.useState([]),[Ie,Z]=m.useState(!1),[ge,oe]=m.useState(null),r=m.useRef(null),N=m.useRef(null),[j,_]=m.useState(null),[q,D]=m.useState(0),[U,le]=m.useState(!1),[Be,Y]=m.useState([]),[I,Re]=m.useState(null),[Ee,Oe]=m.useState("followers"),[He,cs]=m.useState([]),[O,Ve]=m.useState(new Set),[et,st]=m.useState(new Map),[ds,We]=m.useState(!1),[us,ms]=m.useState({}),[Ne,Je]=m.useState(null),Xe=10;m.useEffect(()=>{c.auth.getUser().then(async({data:s})=>{var a;const t=((a=s.user)==null?void 0:a.id)||null;if(we(t),t){const{data:f}=await c.from("follows").select("following_id").eq("follower_id",t);f&&be(new Set(f.map(n=>n.following_id)))}})},[]),m.useEffect(()=>{const s=t=>{N.current&&!N.current.contains(t.target)&&le(!1)};return U&&document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[U]),m.useEffect(()=>{const s=()=>{const f=window.location.pathname.match(/^\/post\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})$/i);if(f){const n=f[1];console.log("[Discover] Opening shared post from URL:",n),X(n),window.history.replaceState({},"","/discover")}};s(),window.addEventListener("popstate",s);const t=a=>{a.detail&&X(a.detail)};return window.addEventListener("open-shared-post",t),()=>{window.removeEventListener("popstate",s),window.removeEventListener("open-shared-post",t)}},[]),m.useEffect(()=>{if(!w)return;const s=async()=>{try{const{data:a,error:f}=await c.from("notifications").select("*").eq("user_id",w).neq("type","message").order("created_at",{ascending:!1}).limit(20);if(f){console.error("[Notifications] Error loading notifications:",f);return}if(a){console.log("[Notifications] Loaded notifications:",a),console.log("[Notifications] Unread count:",a.filter(h=>!h.read).length);const n=[...new Set(a.map(h=>h.actor_id).filter(Boolean))];if(n.length>0){const{data:h}=await c.from("profiles").select("id, username, avatar_url").in("id",n),S=new Map((h||[]).map(y=>[y.id,y])),b=a.map(y=>({...y,actor:y.actor_id?S.get(y.actor_id):null}));Y(b)}else Y(a);const d=a.filter(h=>!h.read).length;console.log("[Notifications] Setting unread count to:",d),D(d)}}catch(a){console.error("[Notifications] Exception:",a)}};s();const t=c.channel("notifications-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${w}`},()=>{s()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"notifications",filter:`user_id=eq.${w}`},()=>{s()}).subscribe();return()=>{c.removeChannel(t)}},[w]),m.useEffect(()=>{M&&w&&(async()=>{const{data:t}=await c.from("posts").select("*, profiles(username, avatar_url), likes(user_id), comments(id)").eq("id",M).maybeSingle();t&&(X(M),L&&L())})()},[M,w,L]);const _e=m.useCallback(async(s,t=!1)=>{try{let a=[];if(j){const{data:u}=await c.from("hashtags").select("id").eq("tag",j.toLowerCase()).maybeSingle();if(u){const{data:ne}=await c.from("post_hashtags").select("post_id").eq("hashtag_id",u.id);if(a=(ne||[]).map(te=>te.post_id),a.length===0){F([]),R(!1),z(!1);return}}else{F([]),R(!1),z(!1);return}}let f=c.from("posts").select("*").order("created_at",{ascending:!1}).range(s*Xe,(s+1)*Xe-1);a.length>0&&(f=f.in("id",a));const{data:n,error:d}=await f;if(d)throw console.error("Error fetching posts:",d),d;if(!n||n.length===0){t&&F([]),R(!1),z(!1);return}const h=n.map(u=>u.id),S=[...new Set(n.map(u=>u.user_id))],{data:{user:b}}=await c.auth.getUser(),y=b?await rs.getBlockedUserIds(b.id):[],ee=b?await rs.getUsersWhoBlockedMe(b.id):[],K=n.filter(u=>!y.includes(u.user_id)&&!ee.includes(u.user_id));if(K.length===0){t&&F([]),R(!1),z(!1);return}const Q=K.map(u=>u.id),se=[...new Set(K.map(u=>u.user_id))],H=[];se.length>0?H.push(c.from("profiles").select("id, username, avatar_url").in("id",se)):H.push(Promise.resolve({data:[],error:null})),Q.length>0?H.push(c.from("likes").select("user_id, post_id").in("post_id",Q),c.from("comments").select("id, text, created_at, user_id, post_id, rating").in("post_id",Q).order("created_at",{ascending:!1}),c.from("post_ratings").select("rating, post_id").in("post_id",Q)):H.push(Promise.resolve({data:[],error:null}),Promise.resolve({data:[],error:null}),Promise.resolve({data:[],error:null}));const[Me,o,p,T]=await Promise.all(H),P=[...new Set((p.data||[]).map(u=>u.user_id))],{data:ie}=await c.from("profiles").select("id, username").in("id",P),i=new Map((Me.data||[]).map(u=>[u.id,u])),l=new Map((ie||[]).map(u=>[u.id,u])),E=new Map;(o.data||[]).forEach(u=>{E.has(u.post_id)||E.set(u.post_id,[]),E.get(u.post_id).push(u)});const B=new Map;(p.data||[]).forEach(u=>{B.has(u.post_id)||B.set(u.post_id,[]);const ne={...u,profiles:l.get(u.user_id)||{username:"User"}};B.get(u.post_id).push(ne)});const $=new Map;(T.data||[]).forEach(u=>{$.has(u.post_id)||$.set(u.post_id,[]),$.get(u.post_id).push(u.rating)});const xe={};$.forEach((u,ne)=>{const te=u.length,Pe=te>0?u.reduce((Ss,Cs)=>Ss+Cs,0)/te:0;xe[ne]={average:Pe,count:te}});const Ze=K.map(u=>{const ne=i.get(u.user_id)||{username:"User",avatar_url:null},te=E.get(u.id)||[],Pe=B.get(u.id)||[];return{...u,profiles:ne,likes:te,comments:Pe.slice(0,2),_count:{likes:te.length,comments:Pe.length}}});ze(u=>({...u,...xe})),t?(F(Ze),ke(0)):F(u=>[...u,...Ze]),R(K.length===Xe)}catch(a){console.error("Error fetching posts:",a),k.error("Failed to load posts")}finally{z(!1)}},[j]);m.useEffect(()=>{let s=!0,t=null;return(async()=>{s&&await _e(0,!0)})(),t=c.channel("posts-and-comments-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"posts"},async f=>{if(!s)return;const n=f.new,{data:d}=await c.from("profiles").select("username, avatar_url").eq("id",n.user_id).maybeSingle(),h={...n,profiles:d||{username:"User",avatar_url:null},likes:[],comments:[],_count:{likes:0,comments:0}};F(S=>S.some(b=>b.id===h.id)?S:[h,...S])}).subscribe(),()=>{s=!1,t&&c.removeChannel(t)}},[_e]);const hs=()=>{const s=C+1;ke(s),_e(s)},fs=async s=>{if(w)try{if(ye.has(s)){const{error:a}=await c.from("follows").delete().eq("follower_id",w).eq("following_id",s);if(a)throw a;be(f=>{const n=new Set(f);return n.delete(s),n}),k.success("Unsupported")}else{const{error:a}=await c.from("follows").insert({follower_id:w,following_id:s});if(a)throw a;await c.from("notifications").insert({user_id:s,actor_id:w,type:"follow"}),be(f=>new Set([...f,s])),k.success("Supporting!")}}catch(t){console.error("Error toggling follow:",t),k.error("Failed to update follow status")}},ps=async()=>{if(de)try{const{error:s}=await c.from("posts").delete().eq("id",de);if(s)throw s;F(t=>t.filter(a=>a.id!==de)),k.success("Post deleted"),ve(null)}catch(s){console.error("Error deleting post:",s),k.error("Failed to delete post")}},gs=async()=>{if(g)try{ue(!0);const s=[],t=[];for(let b=0;b<g.newMediaFiles.length;b++){const y=g.newMediaFiles[b],ee=g.newMediaTypes[b],K=y.name.split(".").pop(),Q=`${w}/${Date.now()}-${Math.random().toString(36).substring(7)}.${K}`,{error:se}=await c.storage.from("posts").upload(Q,y);if(se)throw se;const{data:H}=c.storage.from("posts").getPublicUrl(Q);ee==="video"?t.push(H.publicUrl):s.push(H.publicUrl)}const a=g.currentMedia.filter(b=>b.type==="image"&&!g.deletedMedia.includes(b.url)).map(b=>b.url),f=g.currentMedia.filter(b=>b.type==="video"&&!g.deletedMedia.includes(b.url)).map(b=>b.url),n=[...a,...s],d=[...f,...t],h={title:g.title.trim()||null,caption:g.caption.trim()||null,recipe_url:g.recipeUrl.trim()||null,image_url:n.length>0?JSON.stringify(n):null,video_url:d.length>0?JSON.stringify(d):null},{error:S}=await c.from("posts").update(h).eq("id",g.id);if(S)throw S;F(b=>b.map(y=>y.id===g.id?{...y,...h}:y)),k.success("Post updated"),A(null)}catch(s){console.error("Error updating post:",s),k.error("Failed to update post")}finally{ue(!1)}},xs=async s=>{var f;if(!w)return;const t=W.find(n=>n.id===s),a=(f=t==null?void 0:t.likes)==null?void 0:f.some(n=>n.user_id===w);F(n=>n.map(d=>d.id===s?{...d,likes:a?d.likes.filter(h=>h.user_id!==w):[...d.likes,{user_id:w}],_count:{...d._count,likes:a?d._count.likes-1:d._count.likes+1}}:d));try{a?await c.from("likes").delete().match({post_id:s,user_id:w}):(await c.from("likes").insert({post_id:s,user_id:w}),t&&t.user_id!==w&&await c.from("notifications").insert({user_id:t.user_id,actor_id:w,type:"like",post_id:s}))}catch(n){console.error("Error toggling like:",n),k.error("Failed to update like"),F(d=>d.map(h=>h.id===s?{...h,likes:a?[...h.likes,{user_id:w}]:h.likes.filter(S=>S.user_id!==w),_count:{...h._count,likes:a?h._count.likes+1:h._count.likes-1}}:h))}},ws=()=>e.jsxs("div",{className:"bg-white border-4 border-orange-500 mb-2 animate-pulse",children:[e.jsxs("div",{className:"px-4 py-3 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gray-300"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-32"}),e.jsx("div",{className:"h-3 bg-gray-300 rounded w-24"})]})]}),e.jsx("div",{className:"bg-gray-300 h-96 w-full"}),e.jsxs("div",{className:"px-4 py-3 space-y-3",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-full"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-9 w-20 bg-gray-300 rounded-full"}),e.jsx("div",{className:"h-9 w-20 bg-gray-300 rounded-full"}),e.jsx("div",{className:"h-9 w-20 bg-gray-300 rounded-full ml-auto"})]})]})]});if(J&&W.length===0)return e.jsx("div",{className:"min-h-screen bg-gray-50 pb-32",children:e.jsx("div",{className:"max-w-sm mx-auto w-full pt-24",children:[...Array(3)].map((s,t)=>e.jsx(ws,{},t))})});const Qe=async s=>{try{const{data:t,error:a}=await c.from("profiles").select("id, username, avatar_url").ilike("username",`${s}%`).limit(10);if(a){console.error("[Search] Error:",a),k.error("Search failed"),pe([]),Z(!1);return}pe(t||[]),Z(!0)}catch(t){console.error("[Search] Exception:",t),pe([]),Z(!1)}},vs=s=>{if(he(s),r.current&&clearTimeout(r.current),!s.trim()){pe([]),Z(!1);return}r.current=setTimeout(()=>{Qe(s)},300)},ys=async s=>{await c.from("notifications").update({read:!0}).eq("id",s),Y(t=>t.map(a=>a.id===s?{...a,read:!0}:a)),D(t=>Math.max(0,t-1))},bs=s=>{s.key==="Enter"&&je.trim()&&(s.preventDefault(),r.current&&clearTimeout(r.current),fe.length>0?(oe(fe[0].id),Z(!1),he("")):Qe(je))},js=async s=>{if(Re(s),Oe("followers"),Ve(new Set),We(!1),w){const{data:t}=await c.from("follows").select("following_id, profiles:following_id(id, username, avatar_url)").eq("follower_id",w);cs(t||[])}},Ns=async s=>{var d,h;const t=W.find(S=>S.id===s);if(!t)return;const a=((d=t.profiles)==null?void 0:d.username)||"someone",f=`${window.location.origin}/${a}?post=${s}`,n={title:t.title||"Check out this recipe on MealScrape!",text:t.caption?`${t.caption}

Shared via MealScrape`:"I found this fire recipe on MealScrape!",url:f};if(navigator.share&&((h=navigator.canShare)!=null&&h.call(navigator,n)))try{await navigator.share(n),k.success("Shared successfully!")}catch(S){S.name!=="AbortError"&&(console.error("Native share failed:",S),Ge(f))}else Ge(f)},Ge=s=>{navigator.clipboard.writeText(s).then(()=>{k.success("Link copied to clipboard!")}).catch(()=>{k.error("Failed to copy link")})},_s=s=>{var n;const t=W.find(d=>d.id===s);if(!t)return;const f=`https://mealscrape.com/${((n=t.profiles)==null?void 0:n.username)||"user"}?post=${s}`;navigator.clipboard.writeText(f).then(()=>{We(!0),k.success("Link copied!"),setTimeout(()=>We(!1),2e3)}).catch(d=>{console.error("Failed to copy:",d),k.error("Failed to copy link")})},ks=async()=>{var n;if(!I||O.size===0)return;const s=W.find(d=>d.id===I);if(!s)return;const a=`https://mealscrape.com/${((n=s.profiles)==null?void 0:n.username)||"user"}?post=${I}`,f=`Check out this recipe: ${s.title||"Shared post"}
${a}`;try{for(const d of O){let h=null;const{data:S}=await c.from("conversations").select("id").or(`and(user1_id.eq.${w},user2_id.eq.${d}),and(user1_id.eq.${d},user2_id.eq.${w})`).maybeSingle();if(S)h=S.id;else{const{data:b,error:y}=await c.from("conversations").insert({user1_id:w,user2_id:d}).select().single();if(y)throw y;h=b.id}await c.from("direct_messages").insert({conversation_id:h,sender_id:w,content:f}),await c.from("conversations").update({updated_at:new Date().toISOString(),last_message_at:new Date().toISOString()}).eq("id",h)}if(k.success(`Shared with ${O.size} ${O.size===1?"person":"people"}!`),Re(null),Ve(new Set),O.size===1&&x){const d=Array.from(O)[0],h=He.find(S=>S.following_id===d);h!=null&&h.profiles&&x(d,h.profiles.username)}}catch(d){console.error("Error sharing post:",d),k.error("Failed to share post")}};return e.jsx("div",{className:"min-h-screen bg-gray-50 pb-32 overflow-x-hidden",children:e.jsxs("div",{className:"max-w-sm lg:max-w-md mx-auto w-full",onClick:()=>{le(!1),Z(!1)},children:[e.jsx("div",{className:"fixed top-14 left-0 right-0 z-20 bg-white border-b border-gray-200 p-3 lg:px-6 max-w-sm lg:max-w-md mx-auto shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Vs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:je,onChange:s=>vs(s.target.value),onKeyDown:bs,placeholder:"Search users...",className:"w-full pl-9 pr-3 py-2.5 text-sm bg-gray-50 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-white transition-colors"}),Ie&&e.jsx("div",{className:"absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-lg max-h-60 overflow-y-auto shadow-lg z-50",children:fe.length>0?fe.map(s=>e.jsxs("button",{onClick:()=>{oe(s.id),Z(!1),he("")},className:"w-full flex items-center gap-2 p-2 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-0",children:[e.jsx("div",{className:"w-7 h-7 rounded-full bg-gradient-to-br from-orange-400 to-red-400 overflow-hidden flex items-center justify-center",children:s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:s.username,className:"w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("span",{className:"text-white font-semibold text-sm",children:s.username.charAt(0).toUpperCase()})}),e.jsx("span",{className:"font-medium text-gray-900",children:s.username})]},s.id)):e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No users found"})})]}),e.jsxs("div",{ref:N,className:"relative",children:[e.jsxs("button",{onClick:async s=>{s.stopPropagation(),!U&&w&&(await c.from("notifications").update({read:!0}).eq("user_id",w).eq("read",!1).neq("type","message"),D(0),Y(t=>t.map(a=>({...a,read:!0})))),le(!U)},className:"relative p-2.5 hover:bg-gray-100 rounded-full transition-colors flex-shrink-0 bg-gray-50",children:[e.jsx(Ys,{className:"w-5 h-5 text-gray-700"}),q>0&&e.jsx("span",{className:"absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-semibold",children:q>9?"9+":q})]}),U&&e.jsx("div",{className:"absolute right-0 top-full mt-3 w-80 bg-white border border-gray-200 rounded-xl max-h-80 overflow-y-auto shadow-2xl z-[100]",children:Be.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No notifications yet"}):Be.map(s=>{var t;return e.jsx("div",{onClick:()=>{var a;s.read||ys(s.id),le(!1),s.post_id&&(s.type==="like"||s.type==="comment")?X(s.post_id):s.type==="follow"&&((a=s.actor)!=null&&a.username)&&(window.location.href=`/${s.actor.username}`)},className:`p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${s.read?"":"bg-blue-50"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:((t=s.actor)==null?void 0:t.username)||"Someone"}),s.type==="follow"&&" started following you",s.type==="like"&&" loved your post",s.type==="comment"&&" commented on your post",s.type==="message"&&" sent you a message"]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[new Date(s.created_at).toLocaleDateString()," at"," ",new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]}),!s.read&&e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"})]})},s.id)})})]})]})}),e.jsxs("div",{className:"pt-24",style:{paddingTop:"calc(5rem + env(safe-area-inset-top))"},children:[j&&e.jsxs("div",{className:"bg-blue-50 border-b border-blue-200 p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ks,{className:"w-4 h-4 text-blue-600"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-900",children:["Posts tagged with #",j]})]}),e.jsx(V,{variant:"ghost",size:"sm",onClick:()=>_(null),className:"text-blue-600 hover:text-blue-700",children:"Clear"})]}),ge?e.jsx(Zs,{userId:ge,currentUserId:w,posts:W,isFollowing:ye.has(ge),onBack:()=>oe(null),onToggleFollow:fs,onMessage:(s,t)=>{x&&x(s,t)},onRefresh:()=>_e(0,!0)}):W.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No posts yet. Be the first to share!"})}):e.jsxs(e.Fragment,{children:[W.map(s=>{var n,d,h,S,b,y,ee,K,Q,se,H,Me;console.log("[Discover] Post ID:",s.id),console.log("[Discover] Raw image_url:",s.image_url),console.log("[Discover] Raw video_url:",s.video_url);const t=(n=s.likes)==null?void 0:n.some(o=>o.user_id===w),a=((d=s.comments)==null?void 0:d.slice(0,2))||[],f=s.user_id===w;return e.jsxs("div",{className:"bg-white border-4 border-orange-500 mb-2 flex flex-col min-h-0",children:[e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[(h=s.profiles)!=null&&h.avatar_url?e.jsx("img",{src:s.profiles.avatar_url,alt:s.profiles.username,loading:"lazy",decoding:"async",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-medium text-sm",children:((y=(b=(S=s.profiles)==null?void 0:S.username)==null?void 0:b[0])==null?void 0:y.toUpperCase())||e.jsx(Ye,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{var o;window.location.href=`/${(o=s.profiles)==null?void 0:o.username}`},className:"font-semibold text-sm hover:underline cursor-pointer",children:(ee=s.profiles)==null?void 0:ee.username}),s.user_id==="51ad04fa-6d63-4c45-9423-76183eea7b39"&&e.jsx(Le,{className:"w-4 h-4 text-yellow-500 fill-yellow-500"})]})]}),(f||ae)&&e.jsxs(qs,{children:[e.jsx(Ts,{asChild:!0,children:e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-full",children:e.jsx(Ws,{className:"w-5 h-5 text-gray-600"})})}),e.jsxs(Us,{align:"end",children:[e.jsxs(ts,{onClick:()=>{let o=[];if(s.image_url)try{const p=JSON.parse(s.image_url);Array.isArray(p)?o.push(...p.map(T=>({url:T,type:"image"}))):o.push({url:p,type:"image"})}catch{s.image_url.includes(",")?o.push(...s.image_url.split(",").map(p=>({url:p.trim(),type:"image"}))):o.push({url:s.image_url,type:"image"})}if(s.video_url)try{const p=JSON.parse(s.video_url);Array.isArray(p)?o.push(...p.map(T=>({url:T,type:"video"}))):o.push({url:p,type:"video"})}catch{s.video_url.includes(",")?o.push(...s.video_url.split(",").map(p=>({url:p.trim(),type:"video"}))):o.push({url:s.video_url,type:"video"})}A({id:s.id,title:s.title||"",caption:s.caption||"",recipeUrl:s.recipe_url||"",currentMedia:o,deletedMedia:[],newMediaFiles:[],newMediaPreviews:[],newMediaTypes:[]})},className:"cursor-pointer",children:[e.jsx(Ls,{className:"w-4 h-4 mr-2"}),"Edit post"]}),e.jsxs(ts,{onClick:()=>ve(s.id),className:"cursor-pointer text-red-600",children:[e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"Delete post"]})]})]})]}),e.jsxs("div",{className:"relative",children:[s.image_url||s.video_url?(()=>{let o=[],p=[];const T=i=>{const l=[".mp4",".mov",".webm",".avi",".mkv"],E=i.toLowerCase();return l.some(B=>E.includes(B))};if(s.image_url)try{const i=JSON.parse(s.image_url);if(Array.isArray(i))i.forEach(l=>{const E=De(l);E&&(o.push(E),p.push(T(l)?"video":"image"))});else{const l=De(i);l&&(o.push(l),p.push(T(i)?"video":"image"))}}catch{if(s.image_url.includes(","))s.image_url.split(",").forEach(i=>{const l=i.trim(),E=De(l);E&&(o.push(E),p.push(T(l)?"video":"image"))});else{const i=De(s.image_url);i&&(o.push(i),p.push(T(s.image_url)?"video":"image"))}}if(s.video_url)try{const i=JSON.parse(s.video_url);Array.isArray(i)?i.forEach(l=>{l.includes("instagram.com")||(o.push(l),p.push("video"))}):i.includes("instagram.com")||(o.push(i),p.push("video"))}catch{s.video_url.includes("instagram.com")||(o.push(s.video_url),p.push("video"))}if(o.length===0)return console.log("[Discover] âŒ NO MEDIA FOUND for post:",s.id),e.jsx("div",{className:"w-full aspect-square bg-gray-200 flex items-center justify-center",children:e.jsx("p",{className:"text-gray-500",children:"No media available"})});console.log("[Discover] ðŸ“Š Media parsed for post:",s.id),console.log("[Discover] ðŸ“Š mediaUrls:",o),console.log("[Discover] ðŸ“Š mediaTypes:",p),o.forEach((i,l)=>{p[l]==="video"&&console.log("[Discover] ðŸŽ¥ Video URL at index",l,":",i)});const P=us[s.id]||0,ie=i=>{ms(l=>({...l,[s.id]:typeof i=="function"?i(l[s.id]||0):i}))};return o.length===1?(console.log("[Discover] âœ“ Single media:",o[0]),p[0]==="video"?e.jsx("video",{src:o[0],controls:!0,playsInline:!0,className:"w-full aspect-square object-cover bg-black",preload:"auto",onClick:i=>{const l=i.target.getBoundingClientRect();if(i.clientY-l.top<l.height-40){const $=i.target;$.paused?$.play().catch(xe=>console.error("[Discover] Play failed:",xe)):$.pause()}},onError:i=>{const l=i.target;console.error("[Discover] Single video failed:",o[0]),console.error("[Discover] Video error details:",{error:l.error,networkState:l.networkState,readyState:l.readyState,src:l.src}),k.error("Video failed to load")},onLoadStart:()=>{console.log("[Discover] Single video loading:",o[0])},onCanPlay:()=>{console.log("[Discover] Single video can play:",o[0])}},o[0]):e.jsx("img",{src:o[0],alt:s.title||"Post",loading:"lazy",decoding:"async",className:"w-full aspect-square object-cover cursor-pointer",onClick:()=>{Je({media:o.map((i,l)=>({url:i,type:p[l]})),initialIndex:0,postId:s.id})},onError:i=>{var E;console.error("[Discover] Image failed to load:",o[0]);const l=i.target;l.style.display="none",(E=l.parentElement)==null||E.classList.add("bg-gray-200")}})):e.jsxs("div",{className:"relative w-full aspect-square bg-black",children:[p[P]==="video"?e.jsx("video",{src:o[P],controls:!0,playsInline:!0,className:"w-full h-full object-cover",preload:"auto",onClick:i=>{i.stopPropagation();const l=i.target.getBoundingClientRect();if(i.clientY-l.top<l.height-40){const $=i.target;$.paused?$.play().catch(xe=>console.error("[Discover] Play failed:",xe)):$.pause()}},onError:i=>{const l=i.target;console.error("[Discover] Carousel video failed:",o[P]),console.error("[Discover] Video error details:",{error:l.error,networkState:l.networkState,readyState:l.readyState,src:l.src}),k.error("Video failed to load")},onLoadStart:()=>{console.log("[Discover] Video loading...")},onCanPlay:()=>{console.log("[Discover] Video can play")}},o[P]):e.jsx("img",{src:o[P],loading:"lazy",decoding:"async",alt:`${s.title||"Post"} ${P+1}`,className:"w-full h-full object-cover cursor-pointer",onClick:()=>{Je({media:o.map((i,l)=>({url:i,type:p[l]})),initialIndex:P,postId:s.id})},onError:i=>{var E;console.error("[Discover] Carousel image failed:",o[P]);const l=i.target;l.style.display="none",(E=l.parentElement)==null||E.classList.add("bg-gray-200")}},o[P]),P>0&&e.jsx("button",{onClick:i=>{i.stopPropagation(),ie(l=>l-1)},className:"absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition-colors z-10",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),P<o.length-1&&e.jsx("button",{onClick:i=>{i.stopPropagation(),ie(l=>l+1)},className:"absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition-colors z-10",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}),e.jsx("div",{className:"absolute bottom-3 left-0 right-0 flex justify-center gap-1.5 z-10",children:o.map((i,l)=>e.jsx("button",{onClick:E=>{E.stopPropagation(),ie(l)},className:`w-2 h-2 rounded-full transition-all ${l===P?"bg-white w-6":"bg-white/50"}`},l))}),p[P]!=="video"&&e.jsx("div",{onTouchStart:i=>{const l=i.touches[0];i.currentTarget.touchStartX=l.clientX},onTouchEnd:i=>{const l=i.changedTouches[0],B=i.currentTarget.touchStartX-l.clientX;Math.abs(B)>50&&(B>0&&P<o.length-1?ie($=>$+1):B<0&&P>0&&ie($=>$-1))},className:"absolute inset-0"})]})})():e.jsx("div",{className:"w-full aspect-square bg-gray-200 flex items-center justify-center",children:e.jsx("p",{className:"text-gray-500",children:"No media"})}),s.spotify_preview_url&&e.jsxs("div",{className:"absolute top-4 right-4 z-10",children:[e.jsxs("button",{onClick:o=>{o.stopPropagation();const p=document.getElementById(`audio-${s.id}`),T=o.currentTarget.querySelector(".play-icon");document.querySelectorAll("audio").forEach(P=>{P.id!==`audio-${s.id}`&&P.pause()}),p.paused?(p.play(),T&&(T.textContent="â¸ï¸")):(p.pause(),T&&(T.textContent="â–¶ï¸"))},className:"bg-black/70 hover:bg-black/90 backdrop-blur-sm text-white px-3 py-2 rounded-full shadow-lg transition-all flex items-center gap-2",children:[e.jsx("span",{className:"text-xl play-icon",children:"â–¶ï¸"}),e.jsxs("div",{className:"text-left text-xs max-w-32",children:[e.jsx("div",{className:"font-semibold truncate",children:s.spotify_track_name}),e.jsx("div",{className:"text-white/80 truncate",children:s.spotify_artist_name})]})]}),e.jsx("audio",{id:`audio-${s.id}`,src:s.spotify_preview_url})]}),s.title&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent px-4 py-3",children:e.jsx("h3",{className:"text-white text-sm font-semibold",children:s.title})}),ce[s.id]&&ce[s.id].count>0&&e.jsx("div",{className:"absolute bottom-3 right-3 z-20",children:e.jsxs("div",{className:"flex items-center gap-1 bg-black/70 backdrop-blur-sm px-2.5 py-1.5 rounded-full shadow-lg",children:[e.jsx("span",{className:"text-lg",children:"ðŸ”¥"}),e.jsx("span",{className:"text-white text-xs font-bold",children:ce[s.id].average.toFixed(1)}),e.jsxs("span",{className:"text-white/70 text-xs",children:["(",ce[s.id].count,")"]})]})})]}),e.jsxs("div",{className:"px-4 py-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>xs(s.id),className:"transition-transform hover:scale-110 relative",children:[e.jsx(ns,{className:`w-7 h-7 ${t?"fill-red-500 text-red-500":"text-gray-700"}`}),((K=s._count)==null?void 0:K.likes)&&s._count.likes>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-yellow-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:s._count.likes})]}),e.jsxs("button",{onClick:()=>X(s.id),className:"transition-transform hover:scale-110 relative",children:[e.jsx(os,{className:"w-7 h-7 text-gray-700"}),((Q=s._count)==null?void 0:Q.comments)&&s._count.comments>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-yellow-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:s._count.comments})]}),e.jsx("button",{onClick:()=>js(s.id),className:"ml-auto transition-transform hover:scale-110",children:e.jsx(qe,{className:"w-7 h-7 text-gray-700 hover:text-orange-600 transition-colors"})})]}),s.caption&&e.jsxs("div",{className:"text-sm break-words overflow-wrap-anywhere",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:(se=s.profiles)==null?void 0:se.username}),s.user_id==="51ad04fa-6d63-4c45-9423-76183eea7b39"&&e.jsx(Le,{className:"w-3 h-3 text-yellow-500 fill-yellow-500"})]})," ",e.jsx("span",{className:"text-gray-700 break-all",children:Ps(s.caption,o=>{_(o),oe(null)})})]}),(((H=s._count)==null?void 0:H.comments)||0)>0&&e.jsxs("button",{onClick:()=>X(s.id),className:"text-sm text-gray-500 hover:text-gray-700",children:["View all ",(Me=s._count)==null?void 0:Me.comments," comments"]}),a.map(o=>{var p;return e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:(p=o.profiles)==null?void 0:p.username}),o.user_id==="51ad04fa-6d63-4c45-9423-76183eea7b39"&&e.jsx(Le,{className:"w-3 h-3 text-yellow-500 fill-yellow-500"})]})," ",e.jsx("span",{className:"text-gray-700",children:o.text})]},o.id)}),(s.recipe_id||s.recipe_url)&&e.jsxs(V,{onClick:async()=>{if(s.recipe_id){const{getRecipeById:o}=await Ms(async()=>{const{getRecipeById:T}=await import("./index-CW8L4bB6.js").then(P=>P.ai);return{getRecipeById:T}},__vite__mapDeps([0,1])),p=await o(s.recipe_id);p?Ce(p):k.error("Recipe not found")}else s.recipe_url&&window.open(s.recipe_url,"_blank")},variant:"outline",size:"sm",className:"w-full mt-2 border-orange-600 text-orange-600 hover:bg-orange-50",children:[e.jsx(Js,{className:"w-4 h-4 mr-2"}),"View Recipe"]}),e.jsx("div",{className:"text-xs text-gray-400 uppercase pt-1",children:new Date(s.created_at).toLocaleDateString()})]})]},s.id)}),re&&e.jsx("div",{className:"py-8 text-center",children:e.jsx(V,{onClick:hs,variant:"outline",children:"Load More"})})]})]}),G&&e.jsx(ls,{postId:G,isOpen:!!G,onClose:()=>X(null),onCommentPosted:()=>{}}),e.jsx($s,{open:!!de,onOpenChange:s=>!s&&ve(null),children:e.jsxs(Fs,{children:[e.jsxs(As,{children:[e.jsx(zs,{children:"Delete post?"}),e.jsx(Is,{children:"This action cannot be undone. This will permanently delete your post."})]}),e.jsxs(Bs,{children:[e.jsx(Rs,{children:"Cancel"}),e.jsx(Os,{onClick:ps,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})}),e.jsx(Te,{open:!!g,onOpenChange:s=>!s&&A(null),children:e.jsxs(Ue,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx($e,{children:e.jsx(Fe,{children:"Edit Post"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Title"}),e.jsx("input",{type:"text",value:(g==null?void 0:g.title)||"",onChange:s=>A(t=>t?{...t,title:s.target.value}:null),placeholder:"Recipe title...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Caption"}),e.jsx(Hs,{value:(g==null?void 0:g.caption)||"",onChange:s=>A(t=>t?{...t,caption:s.target.value}:null),placeholder:"Write a caption...",rows:3,className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Recipe Link"}),e.jsx("input",{type:"url",value:(g==null?void 0:g.recipeUrl)||"",onChange:s=>A(t=>t?{...t,recipeUrl:s.target.value}:null),placeholder:"https://...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"})]}),g&&g.currentMedia.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Current Media"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:g.currentMedia.filter(s=>!g.deletedMedia.includes(s.url)).map((s,t)=>e.jsxs("div",{className:"relative group",children:[s.type==="video"?e.jsx("video",{src:s.url,className:"w-full h-32 object-cover rounded-lg border border-gray-200",muted:!0}):e.jsx("img",{src:s.url,alt:`Media ${t+1}`,className:"w-full h-32 object-cover rounded-lg border border-gray-200",loading:"lazy"}),e.jsx("div",{className:"absolute top-1 left-1 bg-black/70 text-white text-xs px-2 py-0.5 rounded",children:s.type==="video"?"ðŸŽ¥":"ðŸ–¼ï¸"}),e.jsx("button",{onClick:()=>{A(a=>a?{...a,deletedMedia:[...a.deletedMedia,s.url]}:null)},className:"absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(es,{className:"w-4 h-4"})})]},t))})]}),g&&g.newMediaPreviews.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block text-green-600",children:"New Media to Add"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:g.newMediaPreviews.map((s,t)=>e.jsxs("div",{className:"relative group",children:[g.newMediaTypes[t]==="video"?e.jsx("video",{src:s,className:"w-full h-32 object-cover rounded-lg border-2 border-green-500",muted:!0}):e.jsx("img",{src:s,alt:`New media ${t+1}`,className:"w-full h-32 object-cover rounded-lg border-2 border-green-500",loading:"lazy"}),e.jsx("div",{className:"absolute top-1 left-1 bg-black/70 text-white text-xs px-2 py-0.5 rounded",children:g.newMediaTypes[t]==="video"?"ðŸŽ¥ New":"ðŸ–¼ï¸ New"}),e.jsx("button",{onClick:()=>{A(a=>a?(URL.revokeObjectURL(a.newMediaPreviews[t]),{...a,newMediaFiles:a.newMediaFiles.filter((f,n)=>n!==t),newMediaPreviews:a.newMediaPreviews.filter((f,n)=>n!==t),newMediaTypes:a.newMediaTypes.filter((f,n)=>n!==t)}):null)},className:"absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(es,{className:"w-4 h-4"})})]},t))})]}),g&&(()=>{const t=g.currentMedia.filter(a=>!g.deletedMedia.includes(a.url)).length+g.newMediaFiles.length;return t>=4?e.jsx("p",{className:"text-sm text-gray-500",children:"Maximum 4 media files reached"}):e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Add More Media"}),e.jsx("input",{type:"file",accept:"image/*,video/*",multiple:!0,onChange:a=>{const f=Array.from(a.target.files||[]),n=4-t,d=f.slice(0,n),h=[],S=[],b=[];for(const y of d){const ee=y.type.startsWith("video/")?52428800:10485760;if(y.size>ee){k.error(`${y.name} is too large (max ${y.type.startsWith("video/")?"50MB":"10MB"})`);continue}h.push(y),S.push(URL.createObjectURL(y)),b.push(y.type.startsWith("video/")?"video":"image")}h.length>0&&A(y=>y?{...y,newMediaFiles:[...y.newMediaFiles,...h],newMediaPreviews:[...y.newMediaPreviews,...S],newMediaTypes:[...y.newMediaTypes,...b]}:null),a.target.value=""},className:"w-full px-3 py-2 border border-gray-300 rounded-md"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Images: max 10MB | Videos: max 50MB | Total: ",t,"/4"]})]})})()]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(V,{variant:"outline",onClick:()=>A(null),children:"Cancel"}),e.jsx(V,{onClick:gs,disabled:Se,className:"bg-orange-500 hover:bg-orange-600",children:Se?"Saving...":"Save Changes"})]})]})}),me&&e.jsx(Ds,{recipe:me,open:!!me,onOpenChange:s=>!s&&Ce(null)}),e.jsx(Te,{open:!!I,onOpenChange:s=>!s&&Re(null),children:e.jsxs(Ue,{className:"sm:max-w-md max-h-[80vh] overflow-y-auto",children:[e.jsx($e,{children:e.jsx(Fe,{children:"Share"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2 border-b border-gray-200",children:[e.jsx("button",{onClick:()=>Oe("followers"),className:`flex-1 py-2 px-4 font-medium transition-colors ${Ee==="followers"?"text-orange-600 border-b-2 border-orange-600":"text-gray-500 hover:text-gray-700"}`,children:"Send to Followers"}),e.jsx("button",{onClick:()=>Oe("link"),className:`flex-1 py-2 px-4 font-medium transition-colors ${Ee==="link"?"text-orange-600 border-b-2 border-orange-600":"text-gray-500 hover:text-gray-700"}`,children:"Share Link"})]}),Ee==="followers"&&e.jsx("div",{className:"space-y-4",children:He.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"You don't have any followers yet"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2",children:He.map(s=>{var f,n;const t=s.profiles,a=O.has(s.following_id);return e.jsxs("button",{onClick:()=>{const d=new Set(O);a?d.delete(s.following_id):d.add(s.following_id),Ve(d)},className:`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${a?"bg-orange-50 border-2 border-orange-500":"hover:bg-gray-50 border-2 border-transparent"}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-semibold overflow-hidden",children:t!=null&&t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.username,className:"w-full h-full object-cover",loading:"lazy"}):(n=(f=t==null?void 0:t.username)==null?void 0:f[0])==null?void 0:n.toUpperCase()}),e.jsx("div",{className:"flex-1 text-left",children:e.jsx("div",{className:"font-semibold",children:t==null?void 0:t.username})}),a&&e.jsx(as,{className:"w-5 h-5 text-orange-600"})]},s.following_id)})}),e.jsxs(V,{onClick:ks,disabled:O.size===0,className:"w-full bg-orange-500 hover:bg-orange-600",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Send to ",O.size," ",O.size===1?"person":"people"]})]})}),Ee==="link"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(V,{onClick:()=>I&&Ns(I),className:"w-full bg-blue-500 hover:bg-blue-600",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Share via Apps"]}),e.jsx(V,{onClick:()=>I&&_s(I),variant:"outline",className:"w-full",children:ds?e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"w-4 h-4 mr-2"}),"Link Copied!"]}):e.jsxs(e.Fragment,{children:[e.jsx(Xs,{className:"w-4 h-4 mr-2"}),"Copy Link"]})})]})]})]})}),Ne&&e.jsx(is,{media:Ne.media,initialIndex:Ne.initialIndex,postId:Ne.postId,open:!!Ne,onOpenChange:s=>{s||Je(null)},onLikeUpdate:()=>{_e(1,!0)}})]})})}export{Rt as Discover};
