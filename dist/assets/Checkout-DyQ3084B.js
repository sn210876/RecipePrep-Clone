import{s as W,r as $,j as e,B as v,C as g,t as j,v as f,x as I,m as p,f as o}from"./index-BxbvCLt6.js";import{B as k}from"./badge-DnoLq4YS.js";import{T as O,a as C,c as Q,b as E}from"./instacartService-BCAuWllh.js";import{f as D,b as P}from"./amazonProductService-DRldnz8d.js";import{A as J}from"./arrow-left-B5t_ngwG.js";import{S as A}from"./shopping-bag-I2Rc3ZIr.js";import{L as B}from"./leaf-Dg9KlHth.js";import{P as _}from"./package-gBcstM8o.js";import{E as q}from"./external-link-Bd9oD5x8.js";const L="mealscrape-20";function M(a,c){const n=a.replace(/\([^)]*\)/g,"").replace(/\[[^\]]*\]/g,"").trim();let m="https://www.amazon.com/s",l=new URLSearchParams({k:n,tag:L});return c==="amazon_fresh"?l.set("i","amazonfresh"):c==="amazon_grocery"?l.set("i","grocery"):c==="whole_foods"&&l.set("i","wholefoods"),`${m}?${l.toString()}`}function H(a){const c="https://www.amazon.com/gp/aws/cart/add.html",n=new URLSearchParams;return a.forEach((m,l)=>{const r=l+1;n.append(`ASIN.${r}`,m.asin);const h=typeof m.quantity=="string"?parseInt(m.quantity)||1:m.quantity||1;n.append(`Quantity.${r}`,h.toString())}),n.append("tag",L),n.append("AssociateTag",L),`${c}?${n.toString()}`}function T(a,c){const n=a.filter(t=>t.asin).map(t=>({name:t.name,asin:t.asin,quantity:t.quantity||"1",unit:t.unit})),m=a.filter(t=>!t.asin),l=new Map;m.forEach(t=>{const i=t.name.toLowerCase().trim();l.has(i)||l.set(i,{ingredient:t.name,searchUrl:M(t.name,c),quantities:[]}),l.get(i).quantities.push({quantity:t.quantity,unit:t.unit})});const r=Array.from(l.values()).map(t=>{if(t.quantities.length===1)return{ingredient:t.ingredient,searchUrl:t.searchUrl,quantity:t.quantities[0].quantity,unit:t.quantities[0].unit};const i=t.quantities.reduce((w,U)=>{const z=parseFloat(U.quantity||"0");return w+(isNaN(z)?0:z)},0),y=t.quantities[0].unit||"";return{ingredient:t.ingredient,searchUrl:t.searchUrl,quantity:i>0?i.toString():void 0,unit:y}}),h=n.length>0?H(n):null;return{mappedItems:n,unmappedItems:r,cartUrl:h,hasCartItems:n.length>0,hasUnmappedItems:r.length>0}}async function V(a,c,n,m,l){const{error:r}=await W.from("amazon_service_clicks").insert({user_id:a,service_type:c,item_count:n,estimated_value:null,recipe_id:null,clicked_at:new Date().toISOString()});r&&console.error("Error tracking Amazon service click:",r)}function re({onNavigate:a}){const[c,n]=$.useState(!1),[m,l]=$.useState(null);if($.useEffect(()=>{(()=>{const b=localStorage.getItem("checkout_data");if(b)try{const u=JSON.parse(b);l(u)}catch(u){console.error("Failed to parse checkout data:",u),o.error("Failed to load checkout data"),a==null||a("grocery-list")}else o.error("No checkout data found"),a==null||a("grocery-list")})()},[a]),!m)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"Loading checkout..."})})});const{instacartItems:r,amazonItems:h,amazonFreshItems:t,amazonGroceryItems:i,wholeFoodsItems:y,userId:w,deliveryAddress:U}=m,z=[...h,...t,...i,...y],G=r.length+z.length,R=async()=>{if(r.length===0){o.error("No items for Instacart delivery");return}n(!0);try{o.info("Finding matching products for Instacart...");const s=[];for(const x of r){const d=await D(x.name,1);d.length>0&&s.push({product:d[0],quantity:x.quantity.toString(),unit:x.unit,deliveryService:"instacart"})}s.length>0&&(await P(w,s),o.success(`Added ${s.length} items to cart for Instacart`));const b=r.map(x=>({product_id:x.id,quantity:x.quantity,unit:x.unit})),u=await Q(b,w,U);window.open(u.checkout_url,"_blank"),o.success("Checkout window opened - you can return anytime")}catch(s){console.error("Error creating Instacart cart:",s),o.error("Failed to create Instacart cart. Please try again.")}finally{n(!1)}},S=async(s,b)=>{if(b.length===0){o.error(`No items for ${E(s)}`);return}n(!0);try{o.info("Finding matching Amazon products...");const u=[],x=[];for(const N of b){const F=await D(N.name,1);F.length>0?(x.push({product:F[0],quantity:N.quantity.toString(),unit:N.unit,deliveryService:s}),u.push({name:N.name,quantity:N.quantity.toString(),unit:N.unit,asin:F[0].asin})):u.push({name:N.name,quantity:N.quantity.toString(),unit:N.unit,asin:null})}x.length>0&&await P(w,x),await V(w,s,x.length);const d=T(u,s);localStorage.setItem("checkout_results",JSON.stringify({result:d,serviceName:E(s)})),a==null||a("checkout-results"),d.hasCartItems&&!d.hasUnmappedItems?o.success(`Added ${d.mappedItems.length} items to ${E(s)} cart`):d.hasCartItems&&d.hasUnmappedItems?o.info(`${d.mappedItems.length} items ready, ${d.unmappedItems.length} need manual search`):d.hasUnmappedItems&&o.info(`${d.unmappedItems.length} items need manual search on Amazon`)}catch(u){console.error(`Error processing ${s}:`,u),o.error("Failed to process items")}finally{n(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-orange-50 to-amber-50",children:e.jsxs("div",{className:"max-w-3xl mx-auto p-4 pb-safe",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(v,{variant:"ghost",onClick:()=>a==null?void 0:a("grocery-list"),className:"mb-4",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Back to Grocery List"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(O,{className:"w-6 h-6 text-orange-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Choose Delivery Service"})]}),e.jsxs("p",{className:"text-gray-600",children:["We've automatically sorted your ",G," items by freshness and delivery service"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.length>0&&e.jsxs(g,{children:[e.jsxs(j,{className:"pb-3",children:[e.jsxs(f,{className:"text-base flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-green-600"}),"Instacart"]}),e.jsx(I,{children:"Quick delivery"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:r.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),t.length>0&&e.jsxs(g,{children:[e.jsxs(j,{className:"pb-3",children:[e.jsxs(f,{className:"text-base flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-green-600"}),"Amazon Fresh"]}),e.jsx(I,{children:"Same-day delivery"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:t.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),i.length>0&&e.jsxs(g,{children:[e.jsxs(j,{className:"pb-3",children:[e.jsxs(f,{className:"text-base flex items-center gap-2",children:[e.jsx(_,{className:"w-4 h-4 text-orange-600"}),"Amazon Grocery"]}),e.jsx(I,{children:"Standard shipping"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:i.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),y.length>0&&e.jsxs(g,{children:[e.jsxs(j,{className:"pb-3",children:[e.jsxs(f,{className:"text-base flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-emerald-600"}),"Whole Foods"]}),e.jsx(I,{children:"Premium organic"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-600",children:y.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]}),h.length>0&&e.jsxs(g,{children:[e.jsxs(j,{className:"pb-3",children:[e.jsxs(f,{className:"text-base flex items-center gap-2",children:[e.jsx(_,{className:"w-4 h-4 text-orange-600"}),"Amazon"]}),e.jsx(I,{children:"General items"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:h.length}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"items"})]})]})]}),r.length>0&&e.jsxs(g,{children:[e.jsx(j,{children:e.jsxs(f,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-green-600"}),"Instacart Items (",r.length,")"]}),e.jsxs(v,{size:"sm",onClick:R,disabled:c,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(p,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:r.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:C(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(k,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),t.length>0&&e.jsxs(g,{children:[e.jsx(j,{children:e.jsxs(f,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-green-600"}),"Amazon Fresh (",t.length,")"]}),e.jsxs(v,{size:"sm",onClick:()=>S("amazon_fresh",t),disabled:c,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(p,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:t.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-green-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:C(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(k,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),i.length>0&&e.jsxs(g,{children:[e.jsx(j,{children:e.jsxs(f,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-4 h-4 text-orange-600"}),"Amazon Grocery (",i.length,")"]}),e.jsxs(v,{size:"sm",onClick:()=>S("amazon_grocery",i),disabled:c,className:"bg-orange-600 hover:bg-orange-700",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(p,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:i.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-orange-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:C(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(k,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),y.length>0&&e.jsxs(g,{children:[e.jsx(j,{children:e.jsxs(f,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-emerald-600"}),"Whole Foods (",y.length,")"]}),e.jsxs(v,{size:"sm",onClick:()=>S("whole_foods",y),disabled:c,className:"bg-emerald-600 hover:bg-emerald-700",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(p,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:y.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-emerald-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:C(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(k,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]}),h.length>0&&e.jsxs(g,{children:[e.jsx(j,{children:e.jsxs(f,{className:"text-sm flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-4 h-4 text-orange-600"}),"Amazon (",h.length,")"]}),e.jsxs(v,{size:"sm",onClick:()=>S("amazon",h),disabled:c,className:"bg-orange-600 hover:bg-orange-700",children:[e.jsx(q,{className:"w-3 h-3 mr-1"}),"Checkout"]})]})}),e.jsx(p,{children:e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:h.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg bg-orange-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:C(s.category)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.quantity," ",s.unit]})]})]}),e.jsx(k,{variant:"outline",className:"text-xs",children:s.category})]},s.id))})})]})]})]})})}export{re as Checkout};
