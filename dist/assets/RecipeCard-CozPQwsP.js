import{i as W,r as m,j as e,B as k,f as v,u as Z,a as V,k as X,C as Y,l as $,m as G,n as K}from"./index-BxbvCLt6.js";import{B as N}from"./badge-DnoLq4YS.js";import{g as Q,B as F,R as ee}from"./RecipeDetailModal-CPh69H4V.js";import{T as te}from"./textarea-DT8Gcu1W.js";import{D as se,a as ae,b as re,c as ie,d as oe}from"./dialog-BBumg-40.js";import{E as ne}from"./ellipsis-vertical-w319jIrZ.js";import{S as le}from"./square-pen-C9ZA8V0C.js";import{T as ce}from"./trash-2-D-f8tCue.js";import{C as de}from"./clock-BHyZMk5Q.js";const me="https://vohvdarghgqskzqjclux.supabase.co",ue="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvaHZkYXJnaGdxc2t6cWpjbHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4ODgwMDcsImV4cCI6MjA3ODQ2NDAwN30.6povbtgWFLTvq6lxVrqii_-PrOiLZrUo1n-BMlpK4gc",l=W(me,ue);async function ge(t){if(!l)return[];const{data:a,error:s}=await l.from("reviews").select("*").eq("recipe_id",t).order("created_at",{ascending:!1});if(s)throw s;return await Promise.all((a||[]).map(async r=>{const{data:d}=await l.from("review_images").select("id, image_url").eq("review_id",r.id);return{...r,images:d||[]}}))}async function he(t,a){if(!l)return null;const{data:s,error:i}=await l.from("reviews").select("*").eq("recipe_id",t).eq("user_id",a).maybeSingle();if(i)throw i;if(!s)return null;const{data:r}=await l.from("review_images").select("id, image_url").eq("review_id",s.id);return{...s,images:r||[]}}async function U(t){if(!l)throw new Error("Supabase not configured");const s=`reviews/${`${Date.now()}-${Math.random().toString(36).substr(2,9)}-${t.name}`}`,{error:i}=await l.storage.from("recipe-images").upload(s,t);if(i)throw i;const{data:r}=l.storage.from("recipe-images").getPublicUrl(s);return r.publicUrl}async function xe(t,a,s,i){if(!l)throw new Error("Supabase not configured");const{data:{user:r}}=await l.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:d,error:u}=await l.from("reviews").insert({recipe_id:t,user_id:r.id,rating:a,comment:s}).select().single();if(u)throw u;if(i.length>0){const n=await Promise.all(i.map(U)),{error:c}=await l.from("review_images").insert(n.map(g=>({review_id:d.id,image_url:g})));if(c)throw c}try{const{data:n}=await l.from("posts").select("id").eq("recipe_id",t);if(n&&n.length>0){const c=n[0].id,g="ðŸ”¥".repeat(a),h=s?` ${s}`:"";await l.from("comments").insert({post_id:c,user_id:r.id,text:`${g}${h}`,rating:a})}}catch(n){console.error("Failed to add review as comment to social post:",n)}return d}async function fe(t,a,s,i){if(!l)throw new Error("Supabase not configured");const{error:r}=await l.from("reviews").update({rating:a,comment:s,updated_at:new Date().toISOString()}).eq("id",t);if(r)throw r;if(i.length>0){const d=await Promise.all(i.map(U)),{error:u}=await l.from("review_images").insert(d.map(n=>({review_id:t,image_url:n})));if(u)throw u}return{id:t,rating:a,comment:s}}async function we(t){if(!l)return 0;const{data:a,error:s}=await l.from("reviews").select("rating").eq("recipe_id",t);if(s)throw s;if(!a||a.length===0)return 0;const i=a.reduce((r,d)=>r+d.rating,0)/a.length;return Math.round(i*10)/10}function pe({rating:t,size:a="md",interactive:s=!1,onRate:i}){const[r,d]=m.useState(0),u={sm:{text:"text-base",button:"w-8 h-8",gap:"gap-1"},md:{text:"text-xl",button:"w-10 h-10",gap:"gap-1.5"},lg:{text:"text-2xl",button:"w-12 h-12",gap:"gap-2"}}[a],n=c=>{s&&i&&i(c)};return e.jsx("div",{className:`flex ${u.gap}`,children:[1,2,3,4,5].map(c=>{const g=c<=(r||t);return e.jsx("button",{onClick:()=>n(c),onMouseEnter:()=>s&&d(c),onMouseLeave:()=>s&&d(0),disabled:!s,className:`
              flex items-center justify-center rounded-lg transition-all duration-200
              ${u.button}
              ${s?"cursor-pointer hover:scale-110 active:scale-95 touch-manipulation":"cursor-default"}
              ${s?"hover:bg-orange-50":""}
              ${u.text}
            `,"aria-label":`Rate ${c} out of 5`,children:e.jsx("span",{className:`transition-all duration-200 ${g?"opacity-100 scale-100":"opacity-20 grayscale scale-90"}`,children:"ðŸ”¥"})},c)})})}function ve({recipe:t,open:a,onOpenChange:s,onReviewSubmitted:i}){const[r,d]=m.useState(0),[u,n]=m.useState(""),[c,g]=m.useState(!1),[h,b]=m.useState(null);m.useEffect(()=>{a&&R()},[a,t.id]);const R=async()=>{try{const x=localStorage.getItem("userId");if(!x)return;const w=await he(t.id,x);w?(d(w.rating),n(w.comment||""),b(w.id)):(d(0),n(""),b(null))}catch(x){console.error("Failed to load existing review:",x)}},y=async()=>{if(r===0){v.error("Please select a rating");return}g(!0);try{h?(await fe(h,r,u,[]),v.success("Review updated successfully!")):(await xe(t.id,r,u,[]),v.success("Review submitted successfully!")),i==null||i(),s(!1),d(0),n("")}catch(x){console.error("Failed to submit review:",x),v.error("Failed to submit review. Please try again.")}finally{g(!1)}};return e.jsx(se,{open:a,onOpenChange:s,children:e.jsx(ae,{className:"max-w-full w-full max-h-full h-full p-0 gap-0 m-0 rounded-none sm:max-w-2xl sm:max-h-[90vh] sm:rounded-lg sm:m-4",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs(re,{className:"px-4 py-4 border-b border-gray-200 flex-shrink-0",children:[e.jsx(ie,{className:"text-xl",children:h?"Edit Your Review":"Write a Review"}),e.jsxs(oe,{className:"text-sm",children:["Share your experience with ",t.title]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-3 block",children:"Your Rating"}),e.jsx("div",{className:"flex justify-center py-2",children:e.jsx(pe,{rating:r,size:"lg",interactive:!0,onRate:d})}),r>0&&e.jsx("p",{className:"text-center text-sm text-gray-600 mt-2",children:r===5?"ðŸ”¥ Amazing!":r===4?"ðŸ˜Š Great!":r===3?"ðŸ‘ Good":r===2?"ðŸ˜ Okay":"ðŸ˜• Not great"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 mb-2 block",children:"Comments (Optional)"}),e.jsx(te,{value:u,onChange:x=>n(x.target.value),placeholder:"Share your experience with this recipe... What did you love? Any tips for others?",className:"min-h-32 text-base resize-none",disabled:c,maxLength:500}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1 text-right",children:[u.length,"/500 characters"]})]})]})}),e.jsx("div",{className:"px-4 py-4 border-t border-gray-200 flex-shrink-0 bg-white",children:e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-2 sm:justify-end",children:[e.jsx(k,{variant:"outline",onClick:()=>s(!1),disabled:c,className:"w-full sm:w-auto min-h-[48px] touch-manipulation active:scale-95 transition-all",children:"Cancel"}),e.jsx(k,{onClick:y,disabled:c||r===0,className:"w-full sm:w-auto min-h-[48px] bg-accent hover:bg-accent/90 touch-manipulation active:scale-95 transition-all",children:c?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Submitting..."]}):h?"Update Review":"Submit Review"})]})})]})})})}const be=({recipe:t,onSave:a,onCook:s,onDelete:i,onEdit:r,showReviewButton:d=!1,isAdmin:u=!1,preloadedSocialPost:n,requireAuth:c=!1})=>{var P;const{state:g}=Z(),{user:h}=V(),{t:b}=X(),[R,y]=m.useState(!1),[x,w]=m.useState(!1),[ye,q]=m.useState(0),[E,z]=m.useState(0),[f,L]=m.useState(null),[M,_]=m.useState(!0),[I,j]=m.useState(!1),[A,B]=m.useState(!1),O=t.prepTime+t.cookTime,C=g.savedRecipes.some(o=>o.id===t.id),[S,T]=m.useState(!1);h&&(t.userId,h.id);const J={Easy:"bg-orange-100 text-orange-700 border-orange-200",Medium:"bg-amber-100 text-amber-700 border-amber-200",Hard:"bg-red-100 text-red-700 border-red-200"},D=async()=>{try{const o=await ge(t.id);z(o.length);const p=await we(t.id);q(p)}catch(o){console.error("Failed to load review data:",o)}};m.useEffect(()=>{D(),n!==void 0&&L(n),_(!1)},[t.id,n]),m.useEffect(()=>{console.log("[RecipeCard] Recipe:",t.id,"Review count:",E,"Social post:",f?"EXISTS":"NULL")},[E,f]);const H=o=>{if(o.stopPropagation(),!f){console.error("[RecipeCard] No social post available");return}console.log("[RecipeCard] ðŸŽ¯ Opening post:",f.id),window.dispatchEvent(new CustomEvent("open-shared-post",{detail:f.id})),window.__pendingSharedPostId=f.id,setTimeout(()=>{delete window.__pendingSharedPostId},2e3),window.location.pathname!=="/discover"&&(console.log("[RecipeCard] Navigating to /discover"),window.history.pushState({},"","/discover"),window.dispatchEvent(new CustomEvent("navigate",{detail:"discover"})))};return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{className:"group overflow-hidden hover:shadow-xl transition-all duration-300 border-4 border-orange-500 bg-white cursor-pointer active:scale-[0.98] flex flex-col h-full",onClick:o=>{const p=o.target;if(!(p.closest("button")||p.closest('[role="menuitem"]'))){if(c&&!h){v.error("Please sign up or log in to view recipe details");return}y(!0)}},children:[e.jsxs("div",{className:"relative overflow-hidden aspect-square bg-gray-100",children:[!A&&t.imageUrl?e.jsx("img",{src:Q(t.imageUrl)||"",alt:t.title,className:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-110",loading:"lazy",decoding:"async",onError:()=>B(!0)}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300",children:e.jsx($,{className:"w-16 h-16 text-gray-400"})}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"}),d&&!M&&f&&e.jsx("div",{className:"absolute bottom-3 left-3 right-3 z-10",children:e.jsx(k,{variant:"outline",size:"sm",disabled:S,className:`w-full bg-white/95 backdrop-blur-sm border-orange-300 text-orange-600 hover:bg-white hover:border-orange-500 hover:text-orange-700 active:scale-95 transition-all touch-manipulation text-xs sm:text-sm shadow-lg ${S?"opacity-60 cursor-wait":""}`,onClick:async o=>{o.stopPropagation(),T(!0),await new Promise(p=>setTimeout(p,200)),H(o),setTimeout(()=>T(!1),500)},children:S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-orange-600 border-t-transparent rounded-full animate-spin mr-2 flex-shrink-0"}),e.jsx("span",{className:"leading-tight",children:"Loading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sm sm:text-base mr-1.5 sm:mr-2 flex-shrink-0",children:"ðŸ’¬"}),e.jsxs("span",{className:"flex items-center gap-1.5 sm:gap-2 truncate min-w-0 leading-tight",children:[e.jsx("span",{children:"See Reviews"}),((P=f._count)==null?void 0:P.comments)>0&&e.jsx("span",{className:"text-xs bg-orange-100 px-1.5 sm:px-2 py-0.5 rounded-full font-semibold flex-shrink-0",children:f._count.comments})]})]})})}),e.jsx("div",{className:"absolute top-3 left-3 z-10",children:a&&e.jsx("button",{onClick:o=>{o.stopPropagation(),a(t.id)},className:`${C?"bg-rose-500 hover:bg-rose-600":"bg-white/95 hover:bg-white"} backdrop-blur-sm rounded-full p-2.5 shadow-lg active:scale-95 transition-all touch-manipulation`,children:e.jsx(F,{className:`w-4 h-4 ${C?"text-white fill-white":"text-gray-700"}`})})}),e.jsxs("div",{className:"absolute top-3 right-3 flex gap-2",children:[C&&!a&&e.jsx("div",{className:"bg-white/95 backdrop-blur-sm rounded-full p-2 shadow-lg",children:e.jsx(F,{className:"w-4 h-4 text-rose-500 fill-rose-500"})}),u&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:o=>{o.stopPropagation(),j(!I)},className:"bg-white/95 backdrop-blur-sm rounded-full p-2.5 shadow-lg hover:bg-gray-100 active:scale-95 transition-all touch-manipulation",children:e.jsx(ne,{className:"w-4 h-4 text-gray-700"})}),I&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:o=>{o.stopPropagation(),j(!1)}}),e.jsxs("div",{className:"absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-xl border border-gray-200 z-50",children:[r&&e.jsxs("button",{onClick:o=>{o.stopPropagation(),j(!1),r(t.id)},className:"w-full flex items-center gap-2 px-4 py-3 hover:bg-gray-50 text-left text-sm text-gray-700 rounded-t-lg",children:[e.jsx(le,{className:"w-4 h-4"}),"Edit Recipe"]}),i&&e.jsxs("button",{onClick:o=>{o.stopPropagation(),j(!1),confirm("Are you sure you want to delete this recipe?")&&i(t.id)},className:"w-full flex items-center gap-2 px-4 py-3 hover:bg-red-50 text-left text-sm text-red-600 rounded-b-lg",children:[e.jsx(ce,{className:"w-4 h-4"}),b.common.delete]})]})]})]})]})]}),e.jsxs(G,{className:"p-4 space-y-3 flex-1",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200 font-medium text-xs",children:t.cuisineType}),e.jsx("h3",{className:"font-bold text-gray-900 leading-tight text-sm sm:text-base lg:text-lg xl:text-xl hyphens-auto break-words",children:K(t.title)})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(de,{className:"w-4 h-4 flex-shrink-0"}),e.jsxs("span",{className:"font-medium whitespace-nowrap",children:[O," min"]})]}),e.jsxs("div",{className:"hidden md:flex items-center gap-1.5",children:[e.jsx($,{className:"w-4 h-4 flex-shrink-0"}),e.jsx(N,{variant:"outline",className:`text-xs ${J[t.difficulty]}`,children:t.difficulty})]})]}),t.dietaryTags.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[t.dietaryTags.slice(0,3).map(o=>e.jsx(N,{variant:"secondary",className:"text-xs bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors",children:o},o)),t.dietaryTags.length>3&&e.jsxs(N,{variant:"secondary",className:"text-xs bg-gray-100 text-gray-700",children:["+",t.dietaryTags.length-3]})]})]})]}),e.jsx(ee,{recipe:t,open:R,onOpenChange:y}),e.jsx(ve,{recipe:t,open:x,onOpenChange:w,onReviewSubmitted:()=>{D()}})]})},Te=m.memo(be,(t,a)=>{var s,i;return t.recipe.id===a.recipe.id&&t.isAdmin===a.isAdmin&&t.showReviewButton===a.showReviewButton&&((s=t.preloadedSocialPost)==null?void 0:s.id)===((i=a.preloadedSocialPost)==null?void 0:i.id)});export{Te as R};
