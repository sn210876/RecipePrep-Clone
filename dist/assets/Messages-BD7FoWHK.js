import{r as c,s as i,j as s,B as Y,I as Z,f as u}from"./index-CW8L4bB6.js";import{D as ee,a as se,b as te,c as ae}from"./dropdown-menu-EeDLPGpt.js";import{A as re,a as ne,b as oe,c as ie,d as le,e as ce,f as de,g as me}from"./alert-dialog-B3PzfpTk.js";import{A as ue}from"./arrow-left-BJulsvlZ.js";import{E as ge}from"./ellipsis-vertical-CzE7m4q-.js";import{T as he}from"./trash-2-CyWUO_Yr.js";import{S as fe}from"./send-DF-fzPFJ.js";import{S as xe}from"./search-Um1noaow.js";import"./index-jXP5tAhI.js";import"./react-icons.esm-yaV6Bvoj.js";import"./index-DRuSg55n.js";import"./index-DO0wffCS.js";import"./index-o213BMLK.js";import"./index-B-aFWGSQ.js";import"./index-CwkIMqiz.js";import"./index-CMpv38SS.js";import"./index-CjfMKqIt.js";import"./index-CwG-koAv.js";function Re({recipientUserId:p,recipientUsername:v,onBack:M}){const[o,z]=c.useState(null),[q,k]=c.useState([]),[a,g]=c.useState(null),[h,m]=c.useState([]),[w,y]=c.useState(""),[F,B]=c.useState(!0),[f,b]=c.useState(""),[D,E]=c.useState([]),[K,_]=c.useState(!1),[V,j]=c.useState(!1),N=c.useRef(null);c.useEffect(()=>{(async()=>{console.log("[Messages] Component initializing");const{data:t}=await i.auth.getUser();t.user&&(console.log("[Messages] User authenticated:",t.user.id),z(t.user.id),await O(t.user.id),p&&v?(console.log("[Messages] Starting conversation with:",v),await I(p,v,t.user.id)):(console.log("[Messages] Initial load of conversations"),await R(t.user.id))),B(!1)})()},[p]);const O=async e=>{try{await i.from("notifications").update({read:!0}).eq("user_id",e).eq("type","message").eq("read",!1)}catch{}};c.useEffect(()=>{if(!a||!o)return;const e=i.channel(`messages:${a.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"direct_messages",filter:`conversation_id=eq.${a.id}`},async t=>{const n=t.new;m(r=>r.find(d=>d.id===n.id)?r:[...r,n]),n.sender_id!==o&&await i.from("direct_messages").update({read:!0}).eq("id",n.id)}).subscribe();return()=>{i.removeChannel(e)}},[a,o]),c.useEffect(()=>{a&&(console.log("[Messages] Conversation selected:",a.id),L(!0),g(e=>e&&{...e,unread_count:0}),k(e=>e.map(t=>t.id===a.id?{...t,unread_count:0}:t)),U(a.id),W(a.id))},[a==null?void 0:a.id]);const[A,Q]=c.useState(0),[T,L]=c.useState(!0);c.useEffect(()=>{var e,t;h.length>0&&(T?((e=N.current)==null||e.scrollIntoView({behavior:"auto"}),L(!1)):h.length>A&&((t=N.current)==null||t.scrollIntoView({behavior:"smooth"}))),Q(h.length)},[h,T,A]);const R=async e=>{console.log("[Messages] loadConversations called for userId:",e);const{data:t,error:n}=await i.from("conversations").select("*").or(`user1_id.eq.${e},user2_id.eq.${e}`).order("last_message_at",{ascending:!1});if(n){console.error("Error loading conversations:",n);return}const r=await Promise.all((t||[]).map(async l=>{const d=l.user1_id===e?l.user2_id:l.user1_id,{data:x}=await i.from("profiles").select("id, username, avatar_url").eq("id",d).maybeSingle(),{data:C}=await i.from("direct_messages").select("content, created_at").eq("conversation_id",l.id).order("created_at",{ascending:!1}).limit(1).maybeSingle(),{count:S}=await i.from("direct_messages").select("*",{count:"exact",head:!0}).eq("conversation_id",l.id).eq("read",!1).neq("sender_id",e);return{...l,other_user:x||{id:d,username:"Unknown",avatar_url:null},last_message:C,unread_count:S||0}}));k(r)};c.useEffect(()=>{const t=setTimeout(async()=>{if(!f.trim()||!o){E([]),_(!1);return}_(!0);const{data:n}=await i.from("profiles").select("id, username, avatar_url").ilike("username",`%${f}%`).neq("id",o).limit(20);E(n||[]),_(!1)},300);return()=>clearTimeout(t)},[f,o]);const I=async(e,t,n)=>{const r=n||o;if(!r)return;const[l,d]=r<e?[r,e]:[e,r];let{data:x}=await i.from("conversations").select("*").eq("user1_id",l).eq("user2_id",d).maybeSingle();if(!x){const{data:S,error:P}=await i.from("conversations").insert({user1_id:l,user2_id:d}).select().single();if(P){console.error("Error creating conversation:",P),u.error("Failed to start conversation");return}x=S}const{data:C}=await i.from("profiles").select("id, username, avatar_url").eq("id",e).maybeSingle();g({...x,other_user:C||{id:e,username:t,avatar_url:null},unread_count:0})},U=async e=>{const{data:t,error:n}=await i.from("direct_messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(n){console.error("Error loading messages:",n);return}m(t||[])},W=async e=>{if(!o){console.log("[Messages] markAsRead: No currentUserId");return}console.log("[Messages] Marking messages as read for conversation:",e,"currentUserId:",o);const{data:t,error:n}=await i.from("direct_messages").select("id, sender_id, read").eq("conversation_id",e).neq("sender_id",o).eq("read",!1);if(console.log("[Messages] Messages to mark as read:",t,"query error:",n),!t||t.length===0){console.log("[Messages] No unread messages found - they may already be marked as read");return}const{data:r,error:l}=await i.from("direct_messages").update({read:!0}).eq("conversation_id",e).neq("sender_id",o).eq("read",!1).select();l?console.error("[Messages] Error marking as read:",l):console.log("[Messages] Successfully marked",(r==null?void 0:r.length)||0,"messages as read:",r)},$=async()=>{if(!w.trim()||!a||!o)return;const e=w.trim();y("");const{error:t,data:n}=await i.from("direct_messages").insert({conversation_id:a.id,sender_id:o,content:e}).select();if(t){console.error("Error sending message:",t),u.error("Failed to send message"),y(e);return}n&&n[0]&&m(l=>[...l,n[0]]),await i.from("conversations").update({last_message_at:new Date().toISOString()}).eq("id",a.id);const r=a.user1_id===o?a.user2_id:a.user1_id;r!==o&&await i.from("notifications").insert({user_id:r,actor_id:o,type:"message",conversation_id:a.id})},H=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),$())},G=e=>{const t=/(https?:\/\/[^\s]+)/g;return e.split(t).map((r,l)=>r.match(t)?s.jsx("a",{href:r,target:"_blank",rel:"noopener noreferrer",className:"underline hover:opacity-80",onClick:d=>d.stopPropagation(),children:r},l):s.jsx("span",{children:r},l))},J=async e=>{if(!o)return;m(n=>n.filter(r=>r.id!==e));const{error:t}=await i.from("direct_messages").delete().eq("id",e).eq("sender_id",o);t?(console.error("Failed to delete message:",t),u.error("Could not delete message"),a&&U(a.id)):u.success("Message deleted")},X=async()=>{if(!(!o||!a)){j(!1);try{const{error:e}=await i.from("direct_messages").delete().eq("conversation_id",a.id);if(e)throw e;const{error:t}=await i.from("conversations").delete().eq("id",a.id);if(t)throw t;u.success("Conversation deleted"),g(null),m([]),await R(o)}catch(e){console.error("Failed to delete conversation:",e),u.error("Could not delete conversation")}}};return F?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center pb-20",children:s.jsx("div",{className:"text-gray-600",children:"Loading messages..."})}):a?s.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[s.jsx("div",{className:"fixed top-16 left-0 right-0 z-[60] bg-white border-b-2 border-gray-300 shadow-md",children:s.jsx("div",{className:"max-w-sm lg:max-w-md mx-auto px-3 py-2.5",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:()=>{console.log("[Messages] Back button clicked"),g(null),m([]),b(""),M&&p&&M()},className:"p-2.5 hover:bg-gray-100 rounded-lg bg-blue-50 border-2 border-blue-500 shadow-sm active:scale-95 transition-transform","aria-label":"Back to messages",children:s.jsx(ue,{className:"w-6 h-6 text-blue-600 font-bold",strokeWidth:3})}),s.jsxs("button",{onClick:()=>window.location.href=`/profile/${a.other_user.username}`,className:"flex items-center gap-2 flex-1 min-w-0 hover:opacity-80 transition-opacity",children:[s.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-semibold overflow-hidden",children:a.other_user.avatar_url?s.jsx("img",{src:a.other_user.avatar_url,alt:a.other_user.username,className:"w-full h-full object-cover"}):a.other_user.username.charAt(0).toUpperCase()}),s.jsx("span",{className:"font-semibold",children:a.other_user.username})]}),s.jsxs(ee,{children:[s.jsx(se,{asChild:!0,children:s.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:s.jsx(ge,{className:"w-5 h-5 text-gray-600"})})}),s.jsx(te,{align:"end",children:s.jsxs(ae,{onClick:()=>j(!0),className:"text-red-600 focus:text-red-600",children:[s.jsx(he,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})})]})]})})}),s.jsx("div",{className:"pt-44 flex-1 overflow-y-auto pb-32 lg:pb-24",children:s.jsx("div",{className:"max-w-sm lg:max-w-md mx-auto px-4",children:s.jsxs("div",{className:"space-y-4 py-4",children:[h.map(e=>s.jsx("div",{className:"flex justify-end",children:s.jsxs("div",{className:"relative group max-w-[75%]",onTouchStart:t=>{if(e.sender_id!==o)return;const n=setTimeout(()=>{var d;(d=t.target.closest(".group"))==null||d.classList.add("show-delete")},400),r=()=>{clearTimeout(n),document.removeEventListener("touchend",r)};document.addEventListener("touchend",r)},children:[s.jsxs("div",{className:`rounded-2xl px-4 py-2.5 text-sm leading-tight break-words shadow-sm ${e.sender_id===o?"bg-gray-200 text-gray-900":"bg-orange-500 text-white"}`,children:[s.jsx("p",{className:"whitespace-pre-wrap",children:G(e.content)}),s.jsx("span",{className:"text-xs opacity-70 mt-1 block text-right",children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.sender_id===o&&s.jsx("button",{onClick:t=>{t.stopPropagation(),J(e.id)},className:`
                absolute -top-3 -right-3 
                w-9 h-9 rounded-full 
                bg-red-500 text-white 
                flex items-center justify-center 
                shadow-lg text-lg
                opacity-0 
                group-hover:opacity-100 
                group-[.show-delete]:opacity-100 
                transition-all duration-200 
                hover:bg-red-600 active:scale-95
                z-10
              `,children:"ðŸ—‘ï¸"})]})},e.id)),s.jsx("div",{ref:N})]})})}),s.jsx("div",{className:"fixed left-0 right-0 py-3 z-[51]",style:{bottom:"88px"},children:s.jsxs("div",{className:"max-w-sm lg:max-w-md mx-auto px-4 flex gap-2",children:[s.jsx("input",{type:"text",value:w,onChange:e=>y(e.target.value),onKeyPress:H,placeholder:"Type a message...",className:"flex-1 px-4 py-2.5 bg-white border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm md:text-base opacity-80",style:{backgroundColor:"rgba(255, 255, 255, 0.8)"}}),s.jsx(Y,{onClick:$,disabled:!w.trim(),className:"rounded-full bg-orange-500 hover:bg-orange-600 text-white px-6 disabled:opacity-50 disabled:cursor-not-allowed opacity-80",style:{opacity:.8},children:s.jsx(fe,{className:"w-5 h-5"})})]})}),s.jsx(re,{open:V,onOpenChange:j,children:s.jsxs(ne,{children:[s.jsxs(oe,{children:[s.jsx(ie,{children:"Delete Conversation?"}),s.jsxs(le,{children:["This will permanently delete your conversation with ",a.other_user.username," and all messages. This action cannot be undone."]})]}),s.jsxs(ce,{children:[s.jsx(de,{children:"Cancel"}),s.jsx(me,{onClick:X,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]}):s.jsxs("div",{className:"min-h-screen bg-gray-50",children:[s.jsx("div",{className:"fixed top-14 sm:top-16 left-0 right-0 z-50 bg-white border-b border-gray-200",children:s.jsxs("div",{className:"max-w-sm lg:max-w-md mx-auto",children:[s.jsx("div",{className:"flex items-center gap-3 px-4 py-3"}),s.jsx("div",{className:"px-4 pb-3",children:s.jsxs("div",{className:"relative",children:[s.jsx(xe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),s.jsx(Z,{type:"text",placeholder:"Search users to message...",value:f,onChange:e=>b(e.target.value),className:"pl-10 h-10 text-sm border-gray-300"})]})})]})}),s.jsx("div",{className:"pt-40 sm:pt-44 pb-20 px-4 max-w-sm lg:max-w-md mx-auto",children:f.trim()?s.jsx("div",{className:"space-y-2",children:K?s.jsx("div",{className:"text-center py-12",children:s.jsx("p",{className:"text-gray-500",children:"Searching users..."})}):D.length===0?s.jsxs("div",{className:"text-center py-12",children:[s.jsx("p",{className:"text-gray-500",children:"No users found"}),s.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Try a different search term"})]}):D.map(e=>s.jsxs("button",{onClick:()=>{b(""),I(e.id,e.username)},className:"w-full flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg transition-colors",children:[s.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-semibold overflow-hidden",children:e.avatar_url?s.jsx("img",{src:e.avatar_url,alt:e.username,className:"w-full h-full object-cover"}):e.username.charAt(0).toUpperCase()}),s.jsxs("div",{className:"flex-1 text-left",children:[s.jsx("span",{className:"font-semibold",children:e.username}),s.jsx("p",{className:"text-sm text-gray-500",children:"Start a conversation"})]})]},e.id))}):q.length===0?s.jsxs("div",{className:"text-center py-12",children:[s.jsx("p",{className:"text-gray-500 mb-4",children:"No conversations yet"}),s.jsx("p",{className:"text-sm text-gray-400",children:"Search for users above to start messaging"})]}):s.jsx("div",{className:"space-y-2",children:q.map(e=>s.jsxs("button",{onClick:()=>g(e),className:"w-full flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg transition-colors",children:[s.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-semibold overflow-hidden",children:e.other_user.avatar_url?s.jsx("img",{src:e.other_user.avatar_url,alt:e.other_user.username,className:"w-full h-full object-cover"}):e.other_user.username.charAt(0).toUpperCase()}),s.jsxs("div",{className:"flex-1 text-left min-w-0",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"font-semibold truncate",children:e.other_user.username}),e.last_message&&s.jsx("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:new Date(e.last_message.created_at).toLocaleDateString()})]}),e.last_message&&s.jsx("p",{className:"text-sm text-gray-600 truncate",children:e.last_message.content}),e.unread_count>0&&s.jsx("span",{className:"inline-block mt-1 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full",children:e.unread_count})]})]},e.id))})})]})}export{Re as Messages};
