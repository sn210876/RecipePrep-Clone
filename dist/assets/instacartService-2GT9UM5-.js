import{c as l,s as c}from"./index-CFcEIvk0.js";/**
 * @license lucide-react v0.446.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=l("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]),m=["fresh","organic","produce","vegetable","fruit","greens","lettuce","tomato","cucumber","carrot","onion","garlic","bell pepper","mushroom","spinach","kale","broccoli","cauliflower"],u=["chicken","beef","pork","turkey","lamb","fish","salmon","shrimp","meat","steak","ground","breast","thigh","tenderloin"],_=["milk","cheese","yogurt","butter","cream","sour cream","cottage cheese","mozzarella","cheddar","parmesan","eggs"],y=["rice","pasta","flour","sugar","salt","pepper","oil","vinegar","sauce","canned","dried","spice","seasoning","baking powder","baking soda","vanilla extract"],h=["frozen","ice cream","popsicle","frozen peas","frozen corn","frozen berries","frozen vegetables"],g=["organic","grass-fed","free-range","pasture-raised","wild-caught","non-gmo","gluten-free","vegan","sustainable","local","artisan"];function f(r,e){const o=r.toLowerCase(),i=g.some(a=>o.includes(a));if(m.some(a=>o.includes(a))){let a="instacart";return i&&(e!=null&&e.enableWholeFoods)?a="whole_foods":e!=null&&e.enableAmazonFresh&&(a="amazon_fresh"),{category:"fresh_produce",freshnessPriority:10,recommendedService:a}}if(u.some(a=>o.includes(a))){let a="instacart";return i&&(e!=null&&e.enableWholeFoods)?a="whole_foods":e!=null&&e.enableAmazonFresh&&(a="amazon_fresh"),{category:"meat",freshnessPriority:10,recommendedService:a}}if(_.some(a=>o.includes(a))){let a="instacart";return i&&(e!=null&&e.enableWholeFoods)?a="whole_foods":e!=null&&e.enableAmazonFresh&&(a="amazon_fresh"),{category:"dairy",freshnessPriority:9,recommendedService:a}}if(h.some(a=>o.includes(a))){let a="instacart";return e!=null&&e.enableAmazonFresh&&(a="amazon_fresh"),{category:"frozen",freshnessPriority:6,recommendedService:a}}if(y.some(a=>o.includes(a))){let a="amazon";return e!=null&&e.enableAmazonGrocery&&(a="amazon_grocery"),{category:"pantry",freshnessPriority:2,recommendedService:a}}let t="amazon";return e!=null&&e.enableAmazonGrocery&&(t="amazon_grocery"),{category:"other",freshnessPriority:5,recommendedService:t}}async function v(r){const{data:e,error:o}=await c.from("ingredient_delivery_routing").select("*").eq("ingredient_name",r.toLowerCase().trim()).maybeSingle();return o?(console.error("Error fetching routing rule:",o),null):e}async function A(r,e){const o=await z(e),i=await Promise.all(r.map(async t=>{const a=await v(t.name);if(a)return{...t,recommendedService:a.recommended_service,category:a.category,freshnessPriority:a.freshness_priority,confidenceScore:Number(a.confidence_score),reasoning:"Database rule match"};const s=f(t.name,o);let n=s.recommendedService;return(o==null?void 0:o.defaultService)!=="auto"&&(n=o.defaultService),!(o!=null&&o.autoRouteFreshItems)&&s.freshnessPriority>=8&&(n="manual"),!(o!=null&&o.autoRoutePantryItems)&&s.freshnessPriority<=3&&(n="manual"),{...t,recommendedService:n,category:s.category,freshnessPriority:s.freshnessPriority,confidenceScore:.7,reasoning:"Auto-categorized"}}));return{instacartItems:i.filter(t=>t.recommendedService==="instacart"),amazonItems:i.filter(t=>t.recommendedService==="amazon"),amazonFreshItems:i.filter(t=>t.recommendedService==="amazon_fresh"),amazonGroceryItems:i.filter(t=>t.recommendedService==="amazon_grocery"),wholeFoodsItems:i.filter(t=>t.recommendedService==="whole_foods"),manualItems:i.filter(t=>t.recommendedService==="manual")}}async function z(r){const{data:e,error:o}=await c.from("user_delivery_preferences").select("*").eq("user_id",r).maybeSingle();return o?(console.error("Error fetching delivery preferences:",o),null):e?{id:e.id,userId:e.user_id,defaultService:e.default_service,deliveryAddress:e.delivery_address,deliveryInstructions:e.delivery_instructions,preferredDeliveryWindow:e.preferred_delivery_window,autoRouteFreshItems:e.auto_route_fresh_items,autoRoutePantryItems:e.auto_route_pantry_items,enableCostOptimization:e.enable_cost_optimization,preferredAmazonService:e.preferred_amazon_service,enableAmazonFresh:e.enable_amazon_fresh,enableAmazonGrocery:e.enable_amazon_grocery,enableWholeFoods:e.enable_whole_foods,userZipCode:e.user_zip_code}:null}async function k(r){const{error:e}=await c.from("user_delivery_preferences").upsert({user_id:r.userId,default_service:r.defaultService,delivery_address:r.deliveryAddress,delivery_instructions:r.deliveryInstructions||"",preferred_delivery_window:r.preferredDeliveryWindow||"",auto_route_fresh_items:r.autoRouteFreshItems,auto_route_pantry_items:r.autoRoutePantryItems,enable_cost_optimization:r.enableCostOptimization,preferred_amazon_service:r.preferredAmazonService||"auto",enable_amazon_fresh:r.enableAmazonFresh??!0,enable_amazon_grocery:r.enableAmazonGrocery??!0,enable_whole_foods:r.enableWholeFoods??!1,user_zip_code:r.userZipCode||"",updated_at:new Date().toISOString()});if(e)throw console.error("Error saving delivery preferences:",e),e}function P(r){return{fresh_produce:"ü•¨",meat:"ü•©",dairy:"ü•õ",pantry:"üè∫",frozen:"‚ùÑÔ∏è",other:"üì¶"}[r]||"üì¶"}function R(r){return{instacart:"Instacart",amazon:"Amazon",amazon_fresh:"Amazon Fresh",amazon_grocery:"Amazon Grocery",whole_foods:"Whole Foods",manual:"Choose Service"}[r]}const b="https://api.instacart.com/v2";async function d(){const{data:r,error:e}=await c.from("delivery_service_configs").select("*").eq("service_name","instacart").single();if(e||!r)throw new Error("Instacart configuration not found");return r}async function F(){try{return(await d()).is_active}catch{return!1}}async function E(r,e,o){try{const i=await d();if(!i.api_key)throw new Error("Instacart API key not configured");const t=i.affiliate_tag||"mealscrape",a=`${e}-${Date.now()}`,s=await fetch(`${b}/checkout/sessions`,{method:"POST",headers:{Authorization:`Bearer ${i.api_key}`,"Content-Type":"application/json"},body:JSON.stringify({items:r,delivery_address:o,partner_metadata:{affiliate_tag:t,tracking_id:a,source:"mealscrape_app"}})});if(!s.ok)throw new Error("Failed to create Instacart checkout session");const n=await s.json();return await c.from("affiliate_conversions").insert({user_id:e,service_name:"instacart",conversion_type:"cart_created",tracking_id:a,status:"pending",metadata:{session_id:n.session_id}}),{session_id:n.session_id,checkout_url:w(n.checkout_url,a),expires_at:n.expires_at}}catch(i){throw console.error("Error creating Instacart cart:",i),i}}function w(r,e){try{const o=new URL(r);return o.searchParams.set("utm_source","mealscrape"),o.searchParams.set("utm_medium","affiliate"),o.searchParams.set("tracking_id",e),o.toString()}catch{return r}}export{I as T,P as a,R as b,E as c,z as g,F as i,A as r,k as s};
